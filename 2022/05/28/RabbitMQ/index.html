<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="翔仔"><meta name="copyright" content="翔仔"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>RabbitMQ | 翔仔的博客</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"翔仔的小站","version":"1.8.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="一，消息队列1，MQ的相关概念1.1，什么是MQ MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。   1.2， 为">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="http://example.com/2022/05/28/RabbitMQ/index.html">
<meta property="og:site_name" content="翔仔的博客">
<meta property="og:description" content="一，消息队列1，MQ的相关概念1.1，什么是MQ MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。   1.2， 为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647868645838-1653732359163.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647868916410-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647869042100-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647870050835-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647870321223-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647870475117-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647934253220-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647934567027-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647934661081-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647935034194-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647939603518-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647941378934-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647941394207-1653732359164.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647941419688-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647955223026-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647952006682-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647953949699-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647953975057-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647954080914-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647954175872-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647954205440-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647956104334-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647956166230-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647956211750-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647957917395-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958068805-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958093017-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958099675-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958446351-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958394199-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958560698-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647958787529-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647959485850-1653732359166.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647959520375-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1647959720299-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648025889672-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648026057309-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648026218607-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648026639050-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648027601870-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648027754135-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648027820046-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648029492967-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648038950025-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648038972483-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648039277010-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648039382216-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648039590414-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648039839475-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648041267722-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648041286722-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648041301904-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648042584000-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648042803293-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648042848453-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648042856445-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648044330768-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648044542995-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648113740834-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648116923890-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648117085967-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648117183741-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648127112937-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648127185064-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653325743032-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648127354388-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648214656169-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648214846116-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215262083-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215329397-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215402938-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215554012-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215564473-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215570954-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215706522-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215712006-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215737318-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648215961834-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648216001247-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648287789567-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648287817234-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648288138031-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648288860233-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648289020619-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648289983864-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648290114496-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648290191588-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1648290213610-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653360742919-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653360794276-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653361461312-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653361642367-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653378248845-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653378278248-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653378299318-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653378434376-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653378689389-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379039184-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379083510-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379097309-1653732359167.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379138898-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379157817-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379174578-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379255179-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379272812-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379339708-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379353824-1653732359168.png">
<meta property="og:image" content="http://example.com/2022/05/28/RabbitMQ/1653379366451.png">
<meta property="article:published_time" content="2022-05-28T10:02:39.000Z">
<meta property="article:modified_time" content="2022-05-30T16:24:35.073Z">
<meta property="article:author" content="翔仔">
<meta property="article:tag" content="消息中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/05/28/RabbitMQ/1647868645838-1653732359163.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="翔仔"><img width="96" loading="lazy" src="/images/tx.jpg" alt="翔仔"><span class="site-author-status" title="不想上学">😭</span></a><div class="site-author-name"><a href="/about/">翔仔</a></div><span class="site-name">翔仔的博客</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="我的主页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">28</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">19</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=910426929&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="985391895@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%EF%BC%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">一，消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8CMQ%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1，MQ的相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1，什么是MQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8C-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-MQ"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2， 为什么要用 MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%B6%88%E5%B3%B0"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">流量消峰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">应用解耦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">异步处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%EF%BC%8C-MQ-%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3， MQ 的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ActiveMQ"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">ActiveMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">Kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RocketMQ"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">RocketMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">RabbitMQ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%EF%BC%8C-MQ-%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4， MQ 的选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka-1"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">Kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RocketMQ-1"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">RocketMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RabbitMQ-1"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">RabbitMQ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-RabbitMQ"><span class="toc-number">1.2.</span> <span class="toc-text">2， RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C-RabbitMQ-%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1， RabbitMQ 的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C-%E5%9B%9B%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2， 四大核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%EF%BC%8C-RabbitMQ-%E6%A0%B8%E5%BF%83%E9%83%A8%E5%88%86"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3， RabbitMQ 核心部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%EF%BC%8C-%E5%90%84%E4%B8%AA%E5%90%8D%E8%AF%8D%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4， 各个名词介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%EF%BC%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5，安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%EF%BC%8CHello-World"><span class="toc-number">2.</span> <span class="toc-text">二，Hello World</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.</span> <span class="toc-text">1，依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">2.2.</span> <span class="toc-text">2，消息生产者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">2.3.</span> <span class="toc-text">3，消息消费者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93"><span class="toc-number">2.4.</span> <span class="toc-text">4，创建思路总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%EF%BC%8CWork-Queues"><span class="toc-number">3.</span> <span class="toc-text">三，Work Queues</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C%E8%BD%AE%E8%AE%AD%E5%88%86%E5%8F%91%E6%B6%88%E6%81%AF"><span class="toc-number">3.1.</span> <span class="toc-text">1，轮训分发消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8C-%E6%8A%BD%E5%8F%96%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1， 抽取工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8C%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">1.2，工作线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%EF%BC%8C%E5%8F%91%E9%80%81%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.1.3.</span> <span class="toc-text">1.3，发送线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94"><span class="toc-number">3.2.</span> <span class="toc-text">2，消息应答</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C-%E6%A6%82%E5%BF%B5"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1， 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C-%E8%87%AA%E5%8A%A8%E5%BA%94%E7%AD%94"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2， 自动应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%EF%BC%8C-%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.3， 消息应答的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%EF%BC%8C-Multiple-%E7%9A%84%E8%A7%A3%E9%87%8A"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.4， Multiple 的解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%EF%BC%8C-%E6%B6%88%E6%81%AF%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E5%85%A5%E9%98%9F"><span class="toc-number">3.2.5.</span> <span class="toc-text">2.5， 消息自动重新入队</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%EF%BC%8C-%E6%B6%88%E6%81%AF%E6%89%8B%E5%8A%A8%E5%BA%94%E7%AD%94%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.6.</span> <span class="toc-text">2.6， 消息手动应答代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8CRabbitMQ-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">3，RabbitMQ 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C%E6%A6%82%E5%BF%B5"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1，概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C%E9%98%9F%E5%88%97%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2，队列如何实现持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3，消息实现持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%EF%BC%8C%E4%B8%8D%E5%85%AC%E5%B9%B3%E5%88%86%E5%8F%91"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.4，不公平分发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5%EF%BC%8C%E9%A2%84%E5%8F%96%E5%80%BC"><span class="toc-number">3.3.5.</span> <span class="toc-text">3.5，预取值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%EF%BC%8C%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4"><span class="toc-number">4.</span> <span class="toc-text">四，发布确认</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">1，发布确认原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.</span> <span class="toc-text">2， 发布确认的策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C%E5%BC%80%E5%90%AF%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.1，开启发布确认的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C%E5%8D%95%E4%B8%AA%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83"><span class="toc-number">4.2.2.</span> <span class="toc-text">2,2，单个确认发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%EF%BC%8C%E6%89%B9%E9%87%8F%E7%A1%AE%E8%AE%A4%E5%8F%91%E5%B8%83"><span class="toc-number">4.2.3.</span> <span class="toc-text">2.3，批量确认发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%EF%BC%8C%E5%BC%82%E6%AD%A5%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4"><span class="toc-number">4.2.4.</span> <span class="toc-text">2.4，异步发布确认</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%EF%BC%8C%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E6%9C%AA%E7%A1%AE%E8%AE%A4%E6%B6%88%E6%81%AF"><span class="toc-number">4.2.5.</span> <span class="toc-text">2.5，如何处理异步未确认消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%EF%BC%8C%E4%BB%A5%E4%B8%8A-3-%E7%A7%8D%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="toc-number">4.2.6.</span> <span class="toc-text">2.6，以上 3 种发布确认速度对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%EF%BC%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">5.</span> <span class="toc-text">五，交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8CExchanges"><span class="toc-number">5.1.</span> <span class="toc-text">1，Exchanges</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8CExchanges-%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1，Exchanges 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8CExchanges-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2，Exchanges 的类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%EF%BC%8C%E6%97%A0%E5%90%8D-exchange"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.3，无名 exchange</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-%E4%B8%B4%E6%97%B6%E9%98%9F%E5%88%97"><span class="toc-number">5.2.</span> <span class="toc-text">2， 临时队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C%E7%BB%91%E5%AE%9A-bindings"><span class="toc-number">5.3.</span> <span class="toc-text">3，绑定(bindings)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%EF%BC%8CFanout"><span class="toc-number">5.4.</span> <span class="toc-text">4，Fanout</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%EF%BC%8CFanout-%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.4.1.</span> <span class="toc-text">4.1，Fanout 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%EF%BC%8CFanout-%E5%AE%9E%E6%88%98"><span class="toc-number">5.4.2.</span> <span class="toc-text">4.2，Fanout 实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%EF%BC%8CDirect-exchange"><span class="toc-number">5.5.</span> <span class="toc-text">5，Direct exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%EF%BC%8CDirect-exchange-%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.5.1.</span> <span class="toc-text">5.1，Direct exchange 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%EF%BC%8C%E5%A4%9A%E9%87%8D%E7%BB%91%E5%AE%9A"><span class="toc-number">5.5.2.</span> <span class="toc-text">5.2，多重绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3%EF%BC%8C%E5%AE%9E%E6%88%98"><span class="toc-number">5.5.3.</span> <span class="toc-text">5.3，实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%EF%BC%8CTopics"><span class="toc-number">5.6.</span> <span class="toc-text">6，Topics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%EF%BC%8C%E4%B9%8B%E5%89%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.6.1.</span> <span class="toc-text">6.1，之前类型的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%EF%BC%8CTopic-%E7%9A%84%E8%A6%81%E6%B1%82"><span class="toc-number">5.6.2.</span> <span class="toc-text">6.2，Topic 的要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%EF%BC%8CTopic-%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B"><span class="toc-number">5.6.3.</span> <span class="toc-text">6.3，Topic 匹配案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4%EF%BC%8C-%E5%AE%9E%E6%88%98"><span class="toc-number">5.6.4.</span> <span class="toc-text">6.4， 实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%EF%BC%8C%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">6.</span> <span class="toc-text">六，死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C%E6%AD%BB%E4%BF%A1%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">6.1.</span> <span class="toc-text">1，死信的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C%E6%AD%BB%E4%BF%A1%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="toc-number">6.2.</span> <span class="toc-text">2，死信的来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C%E6%AD%BB%E4%BF%A1%E5%AE%9E%E6%88%98"><span class="toc-number">6.3.</span> <span class="toc-text">3，死信实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">6.3.1.</span> <span class="toc-text">3.1，代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C%E6%B6%88%E6%81%AF-TTL-%E8%BF%87%E6%9C%9F"><span class="toc-number">6.3.2.</span> <span class="toc-text">3.2，消息 TTL 过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C%E9%98%9F%E5%88%97%E8%BE%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6"><span class="toc-number">6.3.3.</span> <span class="toc-text">3.3，队列达到最大长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%EF%BC%8C%E6%B6%88%E6%81%AF%E8%A2%AB%E6%8B%92"><span class="toc-number">6.3.4.</span> <span class="toc-text">3.4，消息被拒</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%EF%BC%8C%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97"><span class="toc-number">7.</span> <span class="toc-text">七，延时队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%A6%82%E5%BF%B5"><span class="toc-number">7.1.</span> <span class="toc-text">1，延迟队列概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.2.</span> <span class="toc-text">2，延迟队列使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8CRabbitMQ-%E4%B8%AD%E7%9A%84-TTL"><span class="toc-number">7.3.</span> <span class="toc-text">3，RabbitMQ 中的 TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C%E9%98%9F%E5%88%97%E8%AE%BE%E7%BD%AE-TTL"><span class="toc-number">7.3.1.</span> <span class="toc-text">3.1，队列设置 TTL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C%E6%B6%88%E6%81%AF%E8%AE%BE%E7%BD%AE-TTL"><span class="toc-number">7.3.2.</span> <span class="toc-text">3.2，消息设置 TTL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C%E4%B8%A4%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">7.3.3.</span> <span class="toc-text">3.3，两者的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%EF%BC%8C%E6%95%B4%E5%90%88-springboot"><span class="toc-number">7.4.</span> <span class="toc-text">4，整合 springboot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%EF%BC%8C%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.4.1.</span> <span class="toc-text">4.1，创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%EF%BC%8C%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">7.4.2.</span> <span class="toc-text">4.2，添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3%EF%BC%8C%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.4.3.</span> <span class="toc-text">4.3，修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4%EF%BC%8C%E6%B7%BB%E5%8A%A0-Swagger-%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">7.4.4.</span> <span class="toc-text">4.4，添加 Swagger 配置类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%EF%BC%8C%E9%98%9F%E5%88%97-TTL"><span class="toc-number">7.5.</span> <span class="toc-text">5，队列 TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%EF%BC%8C%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">7.5.1.</span> <span class="toc-text">5.1，代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%B1%BB%E4%BB%A3%E7%A0%81"><span class="toc-number">7.5.2.</span> <span class="toc-text">5.2，配置文件类代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3%EF%BC%8C%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">7.5.3.</span> <span class="toc-text">5.3，消息生产者代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4%EF%BC%8C%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">7.5.4.</span> <span class="toc-text">5.4，消息消费者代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%EF%BC%8C%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E4%BC%98%E5%8C%96"><span class="toc-number">7.6.</span> <span class="toc-text">6，延时队列优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%EF%BC%8C%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">7.6.1.</span> <span class="toc-text">6.1，代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%B1%BB%E4%BB%A3%E7%A0%81"><span class="toc-number">7.6.2.</span> <span class="toc-text">6.2，配置文件类代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3%EF%BC%8C%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">7.6.3.</span> <span class="toc-text">6.3，消息生产者代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%EF%BC%8CRabbitmq-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number">7.7.</span> <span class="toc-text">7，Rabbitmq 插件实现延迟队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1%EF%BC%8C%E5%AE%89%E8%A3%85%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E6%8F%92%E4%BB%B6"><span class="toc-number">7.7.1.</span> <span class="toc-text">7.1，安装延时队列插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2%EF%BC%8C%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">7.7.2.</span> <span class="toc-text">7.2，代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%B1%BB%E4%BB%A3%E7%A0%81"><span class="toc-number">7.7.3.</span> <span class="toc-text">7.3，配置文件类代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4%EF%BC%8C%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">7.7.4.</span> <span class="toc-text">7.4，消息生产者代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5%EF%BC%8C%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">7.7.5.</span> <span class="toc-text">7.5，消息消费者代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%EF%BC%8C%E6%80%BB%E7%BB%93"><span class="toc-number">7.8.</span> <span class="toc-text">8，总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%EF%BC%8C%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%AB%98%E7%BA%A7"><span class="toc-number">8.</span> <span class="toc-text">八，发布确认高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C-%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4-springboot-%E7%89%88%E6%9C%AC"><span class="toc-number">8.1.</span> <span class="toc-text">1， 发布确认 springboot 版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8C-%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E6%96%B9%E6%A1%88"><span class="toc-number">8.1.1.</span> <span class="toc-text">1.1， 确认机制方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8C-%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">8.1.2.</span> <span class="toc-text">1.2， 代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%EF%BC%8C-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">8.1.3.</span> <span class="toc-text">1.3， 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%EF%BC%8C-%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">8.1.4.</span> <span class="toc-text">1.4， 添加配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%EF%BC%8C-%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">8.1.5.</span> <span class="toc-text">1.5， 消息生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%EF%BC%8C%E5%9B%9E%E8%B0%83%E7%B1%BB"><span class="toc-number">8.1.6.</span> <span class="toc-text">1.6，回调类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7%EF%BC%8C-%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">8.1.7.</span> <span class="toc-text">1.7， 消息消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8%EF%BC%8C-%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">8.1.8.</span> <span class="toc-text">1.8， 结果分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-%E5%9B%9E%E9%80%80%E6%B6%88%E6%81%AF"><span class="toc-number">8.2.</span> <span class="toc-text">2， 回退消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C-Mandatory-%E5%8F%82%E6%95%B0"><span class="toc-number">8.2.1.</span> <span class="toc-text">2.1， Mandatory 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">8.2.2.</span> <span class="toc-text">2.2，修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%EF%BC%8C-%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">8.2.3.</span> <span class="toc-text">2.3， 回调接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%EF%BC%8C-%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">8.2.4.</span> <span class="toc-text">2.4， 结果分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C-%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">8.3.</span> <span class="toc-text">3， 备份交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C-%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">8.3.1.</span> <span class="toc-text">3.1， 代码架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">8.3.2.</span> <span class="toc-text">3.2， 修改配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C-%E6%8A%A5%E8%AD%A6%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">8.3.3.</span> <span class="toc-text">3.3， 报警消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%EF%BC%8C-%E6%B5%8B%E8%AF%95%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">8.3.4.</span> <span class="toc-text">3.4， 测试注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5%EF%BC%8C-%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">8.3.5.</span> <span class="toc-text">3.5， 结果分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%EF%BC%8C-RabbitMQ-%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">9.</span> <span class="toc-text">九， RabbitMQ 其他知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C-%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">9.1.</span> <span class="toc-text">1， 幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8C-%E6%A6%82%E5%BF%B5"><span class="toc-number">9.1.1.</span> <span class="toc-text">1.1， 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8C-%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">9.1.2.</span> <span class="toc-text">1.2， 消息重复消费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-number">9.1.3.</span> <span class="toc-text">1.3，解决思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%EF%BC%8C%E6%B6%88%E8%B4%B9%E7%AB%AF%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-number">9.1.4.</span> <span class="toc-text">1.4，消费端的幂等性保障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%EF%BC%8C%E5%94%AF%E4%B8%80-ID-%E6%8C%87%E7%BA%B9%E7%A0%81%E6%9C%BA%E5%88%B6"><span class="toc-number">9.1.5.</span> <span class="toc-text">1.5，唯一 ID+指纹码机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%EF%BC%8CRedis-%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">9.1.6.</span> <span class="toc-text">1.6，Redis 原子性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97"><span class="toc-number">9.2.</span> <span class="toc-text">2， 优先级队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">9.2.1.</span> <span class="toc-text">2.1， 使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C-%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0"><span class="toc-number">9.2.2.</span> <span class="toc-text">2.2， 如何添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%EF%BC%8C-%E5%AE%9E%E6%88%98"><span class="toc-number">9.2.3.</span> <span class="toc-text">2.3， 实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C-%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97"><span class="toc-number">9.3.</span> <span class="toc-text">3， 惰性队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">9.3.1.</span> <span class="toc-text">3.1， 使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C-%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.3.2.</span> <span class="toc-text">3.2， 两种模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C-%E5%86%85%E5%AD%98%E5%BC%80%E9%94%80%E5%AF%B9%E6%AF%94"><span class="toc-number">9.3.3.</span> <span class="toc-text">3.3， 内存开销对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%EF%BC%8C-RabbitMQ-%E9%9B%86%E7%BE%A4"><span class="toc-number">10.</span> <span class="toc-text">十， RabbitMQ 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%8C-clustering"><span class="toc-number">10.1.</span> <span class="toc-text">1， clustering</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E9%9B%86%E7%BE%A4%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.1.1.</span> <span class="toc-text">1.1， 使用集群的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.1.2.</span> <span class="toc-text">1.2， 搭建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%EF%BC%8C-%E9%95%9C%E5%83%8F%E9%98%9F%E5%88%97"><span class="toc-number">10.2.</span> <span class="toc-text">2， 镜像队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.2.1.</span> <span class="toc-text">2.1， 使用镜像的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.2.2.</span> <span class="toc-text">2.2， 搭建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%EF%BC%8C-Haproxy-Keepalive-%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">10.3.</span> <span class="toc-text">3， Haproxy+Keepalive 实现高可用负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%EF%BC%8C-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">10.3.1.</span> <span class="toc-text">3.1， 整体架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2%EF%BC%8C-Haproxy-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">10.3.2.</span> <span class="toc-text">3.2， Haproxy 实现负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3%EF%BC%8C%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.3.3.</span> <span class="toc-text">3.3，搭建步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4%EF%BC%8C-Keepalived-%E5%AE%9E%E7%8E%B0%E5%8F%8C%E6%9C%BA-%E4%B8%BB%E5%A4%87-%E7%83%AD%E5%A4%87"><span class="toc-number">10.3.4.</span> <span class="toc-text">3.4， Keepalived 实现双机(主备)热备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.3.5.</span> <span class="toc-text">3.5， 搭建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%EF%BC%8C-Federation-Exchange"><span class="toc-number">10.4.</span> <span class="toc-text">4， Federation Exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E5%AE%83%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.4.1.</span> <span class="toc-text">4.1， 使用它的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.4.2.</span> <span class="toc-text">4.2， 搭建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%EF%BC%8C-Federation-Queue"><span class="toc-number">10.5.</span> <span class="toc-text">5， Federation Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E5%AE%83%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.5.1.</span> <span class="toc-text">5.1， 使用它的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.5.2.</span> <span class="toc-text">5.2， 搭建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%EF%BC%8C-Shovel"><span class="toc-number">10.6.</span> <span class="toc-text">6， Shovel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1%EF%BC%8C-%E4%BD%BF%E7%94%A8%E5%AE%83%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.6.1.</span> <span class="toc-text">6.1， 使用它的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2%EF%BC%8C-%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.6.2.</span> <span class="toc-text">6.2， 搭建步骤</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2022/05/28/RabbitMQ/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="翔仔"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="翔仔的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RabbitMQ</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2022-05-28 18:02:39" itemprop="dateCreated datePublished" datetime="2022-05-28T18:02:39+08:00">2022-05-28</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2022-05-31 00:24:35" itemprop="dateModified" datetime="2022-05-31T00:24:35+08:00">2022-05-31</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">消息队列</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">消息中间件</span></a></span></div><div class="post-author"><span class="author-name">翔仔</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="一，消息队列"><a href="#一，消息队列" class="headerlink" title="一，消息队列"></a>一，消息队列</h1><h2 id="1，MQ的相关概念"><a href="#1，MQ的相关概念" class="headerlink" title="1，MQ的相关概念"></a>1，MQ的相关概念</h2><h3 id="1-1，什么是MQ"><a href="#1-1，什么是MQ" class="headerlink" title="1.1，什么是MQ"></a>1.1，什么是MQ</h3><p> MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种<strong>跨进程的通信机制</strong>，<strong>用于上下游传递消息</strong>。在互联网架构中，MQ 是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。  </p>
<h3 id="1-2，-为什么要用-MQ"><a href="#1-2，-为什么要用-MQ" class="headerlink" title="1.2， 为什么要用 MQ"></a>1.2， 为什么要用 MQ</h3><h4 id="流量消峰"><a href="#流量消峰" class="headerlink" title="流量消峰"></a><strong>流量消峰</strong></h4><p> 举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正 常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限 制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分 散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体 验要好。 </p>
<p><img src="/2022/05/28/RabbitMQ/1647868645838-1653732359163.png" alt="1647868645838" loading="lazy"></p>
<p><strong>自己的理解是：</strong></p>
<p>之前我们没有中间的过渡件，会使用户的请求直接全堆在了系统上，如果请求过高的话就很容易导致宕机。如果我们有一个中间的组件的话，我们可以通过中间的组件去预处理这些请求，这样子就可以实现让这些请求，同时还不会导致系统崩溃。但是缺点是因为我们有预处理，如果请求多的话，就肯定会进行排队，导致性能下降。</p>
<h4 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h4><p> 以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合 调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于 消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在 这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流 系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性 。</p>
<p><img src="/2022/05/28/RabbitMQ/1647868916410-1653732359164.png" alt="1647868916410" loading="lazy"></p>
<p><strong>我的理解:</strong></p>
<p>之前应为这几个系统是相互关联的，所以如果一个系统出现了问题，那么其他的系统就会出现问题。但是如果中间加了一层，这样子我们各个系统就可以自己做自己的事情，只需要将结果返回给中间件即可。</p>
<h4 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h4><p> 有些服务间调用是异步的，例如 A 调用 B，B 需要花费很长时间执行，但是 A 需要知道 B 什么时候可 以执行完，以前一般有两种方式，A 过一段时间去调用 B 的查询 api 查询。或者 A 提供一个 callback api， B 执行完之后调用 api 通知 A 服务。这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题， A 调用 B 服务后，只需要监听 B 处理完成的消息，当 B 处理完成后，会发送一条消息给 MQ，MQ 会将此 消息转发给 A 服务。这样 A 服务既不用循环调用 B 的查询 api，也不用提供 callback api。同样 B 服务也不 用做这些操作。A 服务还能及时的得到异步处理成功的消息。 </p>
<p><img src="/2022/05/28/RabbitMQ/1647869042100-1653732359164.png" alt="1647869042100" loading="lazy"></p>
<p><strong>我的理解：</strong></p>
<p>假设B的调用会用很长的时间，之前A调用B，在B没有返回消息前，A是无法去调用别的方法的，但是如果有了中间消息队列，那么我们A可以不用关心B返回消息我们收不到的问题了，因为B会将消息发送给消息队列，由消息队列传递给A。</p>
<h3 id="1-3，-MQ-的分类"><a href="#1-3，-MQ-的分类" class="headerlink" title="1.3， MQ 的分类"></a>1.3， MQ 的分类</h3><h4 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h4><p> 优点： </p>
<ul>
<li> 单机吞吐量万级，时效性 ms 级，可用性高，基于主从架构实现高可用性，消息可靠性较 低的概率丢失数据 </li>
</ul>
<p>缺点</p>
<ul>
<li> 官方社区现在对 ActiveMQ 5.x 维护越来越少，高吞吐量场景较少使用。 </li>
</ul>
<h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><p> 大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开 Kafka，这款为大数据而生的消息中间件， 以其百万级 TPS 的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥 着举足轻重的作用。目前已经被 LinkedIn，Uber, Twitter, Netflix 等大公司所采纳。 </p>
<p><strong>优点:</strong></p>
<ul>
<li> 性能卓越，单机写入 TPS 约在百万条/秒，最大的优点，就是吞吐量高。</li>
<li> 时效性 ms 级可用性非 常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用,消费者采 用 Pull 方式获取消息, 消息有序, 通过控制能够保证所有消息被消费且仅被消费一次;</li>
<li> 有优秀的第三方 Kafka Web 管理界面 Kafka-Manager；</li>
<li> 在日志领域比较成熟，被多家公司和多个开源项目使用；</li>
<li> 功能支持： 功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用 </li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Kafka 单机超过 64 个队列/分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消 息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；</li>
<li>支持消息顺序， 但是一台代理宕机后，就会产生消息乱序，社区更新较慢；  </li>
</ul>
<h4 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h4><p> RocketMQ 出自阿里巴巴的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一 些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog 分发等场景。  </p>
<p><strong>优点：</strong></p>
<ul>
<li> 单机吞吐量十万级,可用性非常高。</li>
<li> 分布式架构,消息可以做到 0 丢失,MQ 功能较为完善，还是分布式的，扩展性好,支持 10 亿级别的消息堆积，不会因为堆积导致性能下降。</li>
<li> 源码是 java 我们可以自己阅读源码，定制自己公司的 MQ 。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li> 支持的客户端语言不多，目前是 java 及 c++，其中 c++不成熟；社区活跃度一般,没有在 MQ 核心中去实现 JMS 等接口,有些系统要迁移需要修改大量代码。</li>
</ul>
<h4 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><p>2007 年发布，是一个在 AMQP(高级消息队列协议)基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。  </p>
<p><strong>优点：</strong></p>
<ul>
<li> 由于 erlang 语言的高并发特性，性能较好；</li>
<li> 吞吐量到万级，MQ 功能比较完备,健壮、稳定、易用、跨平台、支持多种语言 如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等，支持 AJAX 文档齐全；</li>
<li> 开源提供的管理界面非常棒，用起来很好用,社区活跃度高；更新频率相当高  </li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li> 商业版需要收费,学习成本较高。</li>
</ul>
<h3 id="1-4，-MQ-的选择"><a href="#1-4，-MQ-的选择" class="headerlink" title="1.4， MQ 的选择"></a>1.4， MQ 的选择</h3><h4 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h4><p> Kafka 主要特点是基于 Pull 的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集 和传输，<strong>适合产生大量数据的互联网服务的数据收集业务</strong>。大型公司建议可以选用，如果有日志采集功能， 肯定是首选 kafka 了。 </p>
<h4 id="RocketMQ-1"><a href="#RocketMQ-1" class="headerlink" title="RocketMQ"></a>RocketMQ</h4><p> 天生为<strong>金融互联网领域而生，对于可靠性要求很高的场景</strong>，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ 在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。 </p>
<h4 id="RabbitMQ-1"><a href="#RabbitMQ-1" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><p> 结合 erlang 语言本身的并发优势，<strong>性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分方便</strong>，如果你的数据量没有那么大，中小型公司优先选择功能比较完备的 RabbitMQ。 </p>
<h2 id="2，-RabbitMQ"><a href="#2，-RabbitMQ" class="headerlink" title="2， RabbitMQ"></a>2， RabbitMQ</h2><h3 id="2-1，-RabbitMQ-的概念"><a href="#2-1，-RabbitMQ-的概念" class="headerlink" title="2.1， RabbitMQ 的概念"></a>2.1， RabbitMQ 的概念</h3><p> RabbitMQ 是一个消息中间件：它接受并转发消息。你可以把它当做一个快递站点，当你要发送一个包 裹时，你把你的包裹放到快递站，快递员最终会把你的快递送到收件人那里，按照这种逻辑 RabbitMQ 是 一个快递站，一个快递员帮你传递快件。<strong>RabbitMQ 与快递站的主要区别在于，它不处理快件而是接收， 存储和转发消息数据。</strong> </p>
<p><img src="/2022/05/28/RabbitMQ/1647870050835-1653732359164.png" alt="1647870050835" loading="lazy"></p>
<h3 id="2-2，-四大核心概念"><a href="#2-2，-四大核心概念" class="headerlink" title="2.2， 四大核心概念"></a>2.2， 四大核心概念</h3><p> <strong>生产者</strong></p>
<p> 产生数据发送消息的程序是生产者。</p>
<p> <strong>交换机</strong></p>
<p>交换机是 RabbitMQ 非常重要的一个部件，<strong>一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。</strong>交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定 。</p>
<p><strong>队列</strong></p>
<p>队列是 RabbitMQ 内部使用的一种数据结构，<strong>尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。</strong>队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式  </p>
<p><strong>消费者</strong></p>
<p>消费与接收具有相似的含义。消费者大多时候是一个<strong>等待接收消息的程序。请注意生产者，消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</strong> </p>
<h3 id="2-3，-RabbitMQ-核心部分"><a href="#2-3，-RabbitMQ-核心部分" class="headerlink" title="2.3， RabbitMQ 核心部分"></a>2.3， RabbitMQ 核心部分</h3><p><img src="/2022/05/28/RabbitMQ/1647870321223-1653732359164.png" alt="1647870321223" loading="lazy"></p>
<h3 id="2-4，-各个名词介绍"><a href="#2-4，-各个名词介绍" class="headerlink" title="2.4， 各个名词介绍"></a>2.4， 各个名词介绍</h3><p><img src="/2022/05/28/RabbitMQ/1647870475117-1653732359164.png" alt="1647870475117" loading="lazy"></p>
<p> <strong>Broker（消息代理）：</strong></p>
<p>接收和分发消息的应用，RabbitMQ Server 就是 Message Broker </p>
<p> <strong>Virtual host：（虚拟主机）</strong></p>
<p>出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出 多个 vhost，每个用户在自己的 vhost 创建 exchange／queue 等 。</p>
<p><strong>Connection（连接）：</strong></p>
<p>publisher／consumer 和 broker 之间的 TCP 连接 </p>
<p><strong>Channel：（信道）</strong></p>
<p>如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP  Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。<u>Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</u> </p>
<p><strong>Exchange：（交换机）</strong></p>
<p>message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到 queue 中去。常用的类型有：direct (point-to-point), topic (publish-subscribe) and fanout  (multicast) </p>
<p><strong>Queue：（队列）</strong></p>
<p>消息最终被送到这里等待 consumer 取走 </p>
<p><strong>Binding：（捆绑）</strong></p>
<p>exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key（路由密钥），Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据  </p>
<h3 id="2-5，安装"><a href="#2-5，安装" class="headerlink" title="2.5，安装"></a>2.5，安装</h3><ol>
<li><p>官网地址 </p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a> </p>
</li>
<li><p>文件上传 </p>
<p>上传到/usr/local/software 目录下(如果没有 software 需要自己创建) </p>
<p><img src="/2022/05/28/RabbitMQ/1647934253220-1653732359164.png" alt="1647934253220" loading="lazy"></p>
</li>
<li><p>安装文件(分别按照以下顺序安装) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh erlang-21.3-1.el7.x86_64.rpm</span><br><span class="line">yum install socat -y</span><br><span class="line">rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure></li>
<li><p>常用命令(按照以下顺序执行)  </p>
<ul>
<li><p>添加开机启动 RabbitMQ 服务  <code>chkconfig rabbitmq-server on</code></p>
</li>
<li><p>启动服务  <code>/sbin/service rabbitmq-server start</code></p>
</li>
<li><p>查看服务状态 <code>/sbin/service rabbitmq-server status</code></p>
<p><img src="/2022/05/28/RabbitMQ/1647934567027-1653732359164.png" alt="1647934567027" loading="lazy"></p>
</li>
<li><p>停止服务(选择执行)  <code>/sbin/service rabbitmq-server stop </code></p>
</li>
<li><p>开启 web 管理插件  <code>rabbitmq-plugins enable rabbitmq_management</code></p>
<ul>
<li> 用默认账号密码(guest)访问地址 <a target="_blank" rel="noopener" href="http://47.98.198.119:15672/%E5%87%BA%E7%8E%B0%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98">http://47.98.198.119:15672/出现权限问题</a>  </li>
</ul>
<p><img src="/2022/05/28/RabbitMQ/1647934661081-1653732359164.png" alt="1647934661081" loading="lazy"></p>
</li>
</ul>
</li>
<li><p>添加一个新的用户 </p>
<ul>
<li><p>创建账号 <code>rabbitmqctl add_user admin 123 </code></p>
</li>
<li><p>设置用户角色 <code>rabbitmqctl set_user_tags admin administrator</code></p>
</li>
<li><p>设置用户权限 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">格式如下</span><br><span class="line">set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;read&gt;</span><br><span class="line">用户 user_admin 具有/vhost1 这个 virtual host 中所有资源的配置、写、读权限</span><br><span class="line">rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>当前用户和角色  <code>rabbitmqctl list_users</code></p>
</li>
</ul>
</li>
<li><p>重置命令 </p>
<ul>
<li> 关闭应用的命令为  <code>rabbitmqctl stop_app</code></li>
<li> 清除的命令为  <code>rabbitmqctl reset</code></li>
<li> 重新启动命令为 <code>rabbitmqctl start_app</code></li>
</ul>
</li>
</ol>
<h1 id="二，Hello-World"><a href="#二，Hello-World" class="headerlink" title="二，Hello World"></a>二，Hello World</h1><p>在本教程的这一部分中，我们将用 Java 编写两个程序。发送单个消息的生产者和接收消息并打印 出来的消费者。我们将介绍 Java API 中的一些细节。</p>
<p>在下图中，“ P”是我们的生产者，“ C”是我们的消费者。中间的框是一个队列-RabbitMQ 代 表使用者保留的消息缓冲区 </p>
<p><img src="/2022/05/28/RabbitMQ/1647935034194-1653732359164.png" alt="1647935034194" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1647939603518-1653732359164.png" alt="1647939603518" loading="lazy"></p>
<h2 id="1，依赖"><a href="#1，依赖" class="headerlink" title="1，依赖"></a>1，依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zhao.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbitmq-hello<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--指定 jdk 编译版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--rabbitmq 依赖客户端--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--操作文件流的一个依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2，消息生产者"><a href="#2，消息生产者" class="headerlink" title="2，消息生产者"></a>2，消息生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 16:21</span></span><br><span class="line"><span class="comment"> * 记得开放5672端口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="comment">//队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//创建一个连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">//设置一个主机的的ip地址</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;47.98.198.119&quot;</span>);</span><br><span class="line">        <span class="comment">//设置我们使用的用户（包括用户名和密码）</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//创建一个信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明一个队列</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue 这个队列的名字</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> durable（耐用，持久） 如果我们声明一个持久队列，则为 true（该队列将在服务器重新启动后继续存在）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exclusive（独家的） 如果我们声明一个独占队列，则为 true（仅限于此连接）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoDelete（自动删除） 如果我们声明一个自动删除队列，则为 true（服务器将在不再使用时将其删除）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> arguments（论据） 队列的其他属性（构造参数）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 声明队列已成功声明的声明确认方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//发消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 发布一个消息</span></span><br><span class="line"><span class="comment">         * 发布到不存在的交易所将导致渠道级别，协议异常，关闭通道。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exchange（交换机） 将消息发布到的交易所</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> routingKey（路由Key） 这个路由的key</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> props 消息的其他属性 - 路由标头等</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> body 消息体</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送完毕&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行结果图</strong></p>
<p><img src="/2022/05/28/RabbitMQ/1647941378934-1653732359164.png" alt="1647941378934" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1647941394207-1653732359164.png" alt="1647941394207" loading="lazy"></p>
<h2 id="3，消息消费者"><a href="#3，消息消费者" class="headerlink" title="3，消息消费者"></a>3，消息消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 消息消费者，接收消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 17:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="comment">//队列的名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> java.lang.<span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="comment">//接收消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">//设置一个主机的的ip地址</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;47.98.198.119&quot;</span>);</span><br><span class="line">        <span class="comment">//设置我们使用的用户（包括用户名和密码）</span></span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="comment">//创建一个信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明 接收消息</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取消消息是的回调</span></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息消费者被中断&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 使用服务器生成的 consumerTag(消费者标签) 启动一个非 nolocal（本地）、非独占的消费者。</span></span><br><span class="line"><span class="comment">         * 仅提供对 &lt;code&gt;basic.deliver&lt;/code&gt; 和 &lt;code&gt;basic.cancel&lt;/code&gt; AMQP 方法的访问（这对于大多数情况来说已经足够了）。</span></span><br><span class="line"><span class="comment">         * 查看带有 &#123;<span class="doctag">@link</span> Consumer&#125; 参数的方法以访问所有应用程序回调。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue the name of the queue</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoAck 如果服务器应该考虑消息，则为 true，也就是是否让服务器自己应答</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> deliverCallback（传递回调） 消息传递时的回调</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> cancelCallback（取消回调） 消费者取消时的回调</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>运行结果</strong></p>
<p><img src="/2022/05/28/RabbitMQ/1647941419688-1653732359166.png" alt="1647941419688" loading="lazy"></p>
<h2 id="4，创建思路总结"><a href="#4，创建思路总结" class="headerlink" title="4，创建思路总结"></a>4，创建思路总结</h2><p><img src="/2022/05/28/RabbitMQ/1647955223026-1653732359166.png" alt="1647955223026" loading="lazy"></p>
<h1 id="三，Work-Queues"><a href="#三，Work-Queues" class="headerlink" title="三，Work Queues"></a>三，Work Queues</h1><p>工作队列(又称任务队列)的主要思想是<strong>避免立即执行资源密集型任务，而不得不等待它完成</strong>。 相反我们安排任务在之后执行。我们把任务封装为消息并将其发送到队列。在后台运行的工作进程将弹出任务并最终执行作业。当有多个工作线程时，这些工作线程将一起处理这些任务。 </p>
<p><img src="/2022/05/28/RabbitMQ/1647952006682-1653732359166.png" alt="1647952006682" loading="lazy"></p>
<p>我的理解：假设有大量的请求涌入我们的系统，这个时候我们就可以通过吧这些请求发送给队列，进行并行的操作，也就是上面画的多个工作线程去一起执行。而且这些工作现场去处理请求的时候是轮训的。</p>
<h2 id="1，轮训分发消息"><a href="#1，轮训分发消息" class="headerlink" title="1，轮训分发消息"></a>1，轮训分发消息</h2><p>在这个案例中我们会启动两个工作线程，一个消息发送线程。  </p>
<h3 id="1-1，-抽取工具类"><a href="#1-1，-抽取工具类" class="headerlink" title="1.1， 抽取工具类"></a>1.1， 抽取工具类</h3><p>将我们创建信道的代码抽取为一个工作类，进行一个代码的复用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: RabbitMqUtils</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: RabbitMqUtils工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 20:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqUtils</span> &#123;</span><br><span class="line">    <span class="comment">//得到一个连接的 channel</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Channel <span class="title function_">getChannel</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">//设置一个主机的的ip地址</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;47.98.198.119&quot;</span>);</span><br><span class="line">        <span class="comment">//设置我们使用的用户（包括用户名和密码）</span></span><br><span class="line">        factory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="comment">//创建一个信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2，工作线程"><a href="#1-2，工作线程" class="headerlink" title="1.2，工作线程"></a>1.2，工作线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.demo01.Consumer;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Worker01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 这是一个工作线程，相当于之前的消费者。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 20:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker01</span> &#123;</span><br><span class="line">    <span class="comment">//队列的名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接受到消息后做的事情</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到的消息：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果消费者取消消息后回调</span></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息被消费者取消的回调逻辑&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 使用服务器生成的 consumerTag(消费者标签) 启动一个非 nolocal（本地）、非独占的消费者。</span></span><br><span class="line"><span class="comment">         * 仅提供对 &lt;code&gt;basic.deliver&lt;/code&gt; 和 &lt;code&gt;basic.cancel&lt;/code&gt; AMQP 方法的访问（这对于大多数情况来说已经足够了）。</span></span><br><span class="line"><span class="comment">         * 查看带有 &#123;<span class="doctag">@link</span> Consumer&#125; 参数的方法以访问所有应用程序回调。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue the name of the queue</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoAck 如果服务器应该考虑消息，则为 true，也就是是否让服务器自己应答</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> deliverCallback（传递回调） 消息传递时的回调</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> cancelCallback（取消回调） 消费者取消时的回调</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(<span class="string">&quot;C2等待接收消息&quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以用idea自带的功能实现开启多个进程，即运行多个相同的java文件。</p>
<ol>
<li><img src="/2022/05/28/RabbitMQ/1647953949699-1653732359166.png" alt="1647953949699" loading="lazy"></li>
<li><img src="/2022/05/28/RabbitMQ/1647953975057-1653732359166.png" alt="1647953975057" loading="lazy"></li>
<li><img src="/2022/05/28/RabbitMQ/1647954080914-1653732359166.png" alt="1647954080914" loading="lazy"></li>
</ol>
<h3 id="1-3，发送线程"><a href="#1-3，发送线程" class="headerlink" title="1.3，发送线程"></a>1.3，发送线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Task01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 生产者，可以发送大量的消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 20:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task01</span> &#123;</span><br><span class="line">    <span class="comment">//队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送大量消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明一个队列</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue 这个队列的名字</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> durable（耐用，持久） 如果我们声明一个持久队列，则为 true（该队列将在服务器重新启动后继续存在）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exclusive（独家的） 如果我们声明一个独占队列，则为 true（仅限于此连接）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoDelete（自动删除） 如果我们声明一个自动删除队列，则为 true（服务器将在不再使用时将其删除）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> arguments（论据） 队列的其他属性（构造参数）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 声明队列已成功声明的声明确认方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//从控制台接受消息</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 发布一个消息</span></span><br><span class="line"><span class="comment">             * 发布到不存在的交易所将导致渠道级别，协议异常，关闭通道。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> exchange（交换机） 将消息发布到的交易所</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> routingKey（路由Key） 这个路由的key</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> props 消息的其他属性 - 路由标头等</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> body 消息体</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息完成&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p>发送线程发送了四个内容</p>
<p><img src="/2022/05/28/RabbitMQ/1647954175872-1653732359166.png" alt="1647954175872" loading="lazy"></p>
<p>工作线程C2接收到bb和dd</p>
<p><img src="/2022/05/28/RabbitMQ/1647954205440-1653732359166.png" alt="1647954205440" loading="lazy"></p>
<p>工作线程C1接收到aa和cc</p>
<h2 id="2，消息应答"><a href="#2，消息应答" class="headerlink" title="2，消息应答"></a>2，消息应答</h2><h3 id="2-1，-概念"><a href="#2-1，-概念" class="headerlink" title="2.1， 概念"></a>2.1， 概念</h3><p>消费者完成一个任务可能需要一段时间，如果其中<strong>一个消费者处理一个长的任务并仅只完成 了部分突然它挂掉了</strong>，会发生什么情况。<strong>RabbitMQ 一旦向消费者传递了一条消息，便立即将该消 息标记为删除</strong>。在这种情况下，突然有个消费者挂掉了，我们<strong>将丢失正在处理的消息</strong>。以及后续发送给该消费者的消息，因为它无法接收到。 </p>
<p>为了保证消息在发送过程中不丢失，rabbitmq 引入消息应答机制，消息应答就是:消费者在接 收到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除了。 </p>
<h3 id="2-2，-自动应答"><a href="#2-2，-自动应答" class="headerlink" title="2.2， 自动应答"></a>2.2， 自动应答</h3><p>消息发送后立即被认为已经传送成功，这种模式需要在<strong>高吞吐量和数据传输安全性方面做权衡,<strong>因为这种模式如果消息在接收到之前，消费者那边出现连接或者 channel 关闭，那么消息就丢 失了,当然另一方面这种模式消费者那边可以传递过载的消息，</strong>没有对传递的消息数量进行限制</strong>， 当然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死，所以<strong>这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用。</strong>  </p>
<h3 id="2-3，-消息应答的方法"><a href="#2-3，-消息应答的方法" class="headerlink" title="2.3， 消息应答的方法"></a>2.3， 消息应答的方法</h3><ul>
<li><p><code>Channel.basicAck</code>(用于肯定确认) </p>
<p>RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了 </p>
</li>
<li><p><code>Channel.basicNack</code> (用于否定确认) </p>
</li>
<li><p><code>Channel.basicReject</code> (用于否定确认) </p>
<ul>
<li> 与 Channel.basicNack 相比少一个参数 </li>
<li> 不处理该消息了直接拒绝，可以将其丢弃了  </li>
</ul>
</li>
</ul>
<h3 id="2-4，-Multiple-的解释"><a href="#2-4，-Multiple-的解释" class="headerlink" title="2.4， Multiple 的解释"></a>2.4， Multiple 的解释</h3><p>手动应答的好处是可以批量应答并且减少网络拥堵。</p>
<p><img src="/2022/05/28/RabbitMQ/1647956104334-1653732359166.png" alt="1647956104334" loading="lazy"></p>
<ul>
<li><p>multiple 的 true 和 false 代表不同意思 </p>
<ul>
<li><p>true 代表批量应答 channel 上未应答的消息 </p>
<p>比如说 channel 上有传送 tag 的消息 5,6,7,8 当前 tag 是 8 那么此时 5-8 的这些还未应答的消息都会被确认收到消息应答。</p>
</li>
<li><p>false 同上面相比 ，只会应答 tag=8 的消息 5,6,7 这三个消息依然不会被确认收到消息应答  </p>
</li>
</ul>
</li>
</ul>
<p><img src="/2022/05/28/RabbitMQ/1647956166230-1653732359166.png" alt="1647956166230" loading="lazy"></p>
<h3 id="2-5，-消息自动重新入队"><a href="#2-5，-消息自动重新入队" class="headerlink" title="2.5， 消息自动重新入队"></a>2.5， 消息自动重新入队</h3><p>如果消费者由于某些原因失去连接(其通道已关闭，连接已关闭或 TCP 连接丢失)，导致消息 未发送 ACK 确认，RabbitMQ 将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者 可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确 保不会丢失任何消息。  </p>
<p><img src="/2022/05/28/RabbitMQ/1647956211750-1653732359166.png" alt="1647956211750" loading="lazy"></p>
<h3 id="2-6，-消息手动应答代码"><a href="#2-6，-消息手动应答代码" class="headerlink" title="2.6， 消息手动应答代码"></a>2.6， 消息手动应答代码</h3><p>默认消息采用的是自动应答，所以我们要想实现消息消费过程中不丢失，需要把自动应答改 为手动应答，消费者在上面代码的基础上增加下面画红色部分代码。 </p>
<p><img src="/2022/05/28/RabbitMQ/1647957917395-1653732359166.png" alt="1647957917395" loading="lazy"></p>
<p><strong>消息生产者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Task02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 生产者   目的是使用手动应答</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 21:43</span></span><br><span class="line"><span class="comment"> * 消息在手动应答不会丢失消息，如果丢失会放入队列重新消费</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Task02</span> &#123;</span><br><span class="line">    <span class="comment">//队列名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//从控制台接受消息</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息完成&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>消息消费者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.demo01.Consumer;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.SleepUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Work03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 消费者  手动应答</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 21:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work03</span> &#123;</span><br><span class="line">    <span class="comment">//队列的名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;C1 等待接收消息处理时间较短&quot;</span>);</span><br><span class="line">        <span class="comment">//接受到消息后做的事情</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            <span class="comment">//睡眠1秒</span></span><br><span class="line">            SleepUtils.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到的消息：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1，消息的标签</span></span><br><span class="line"><span class="comment">             * 2，是否批量应答 false：不批量应答。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(message.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果消费者取消消息后回调</span></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息被消费者取消的回调逻辑&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 使用服务器生成的 consumerTag(消费者标签) 启动一个非 nolocal（本地）、非独占的消费者。</span></span><br><span class="line"><span class="comment">         * 仅提供对 &lt;code&gt;basic.deliver&lt;/code&gt; 和 &lt;code&gt;basic.cancel&lt;/code&gt; AMQP 方法的访问（这对于大多数情况来说已经足够了）。</span></span><br><span class="line"><span class="comment">         * 查看带有 &#123;<span class="doctag">@link</span> Consumer&#125; 参数的方法以访问所有应用程序回调。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue the name of the queue</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoAck 如果服务器应该考虑消息，则为 true，也就是是否让服务器自己应答</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> deliverCallback（传递回调） 消息传递时的回调</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> cancelCallback（取消回调） 消费者取消时的回调</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(<span class="string">&quot;C2等待接收消息&quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">false</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.CancelCallback;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.demo01.Consumer;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.SleepUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Work04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/22 21:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work04</span> &#123;</span><br><span class="line">    <span class="comment">//队列的名称</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ack_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;C2 等待接收消息处理时间较长&quot;</span>);</span><br><span class="line">        <span class="comment">//接受到消息后做的事情</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            <span class="comment">//睡眠30秒</span></span><br><span class="line">            SleepUtils.sleep(<span class="number">30</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到的消息：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1，消息的标签</span></span><br><span class="line"><span class="comment">             * 2，是否批量应答 false：不批量应答。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(message.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果消费者取消消息后回调</span></span><br><span class="line">        <span class="type">CancelCallback</span> <span class="variable">cancelCallback</span> <span class="operator">=</span> consumerTag -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息被消费者取消的回调逻辑&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 使用服务器生成的 consumerTag(消费者标签) 启动一个非 nolocal（本地）、非独占的消费者。</span></span><br><span class="line"><span class="comment">         * 仅提供对 &lt;code&gt;basic.deliver&lt;/code&gt; 和 &lt;code&gt;basic.cancel&lt;/code&gt; AMQP 方法的访问（这对于大多数情况来说已经足够了）。</span></span><br><span class="line"><span class="comment">         * 查看带有 &#123;<span class="doctag">@link</span> Consumer&#125; 参数的方法以访问所有应用程序回调。</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> queue the name of the queue</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> autoAck 如果服务器应该考虑消息，则为 true，也就是是否让服务器自己应答</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> deliverCallback（传递回调） 消息传递时的回调</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> cancelCallback（取消回调） 消费者取消时的回调</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(<span class="string">&quot;C2等待接收消息&quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">false</span>, deliverCallback, cancelCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>效果图</strong></p>
<p>正常情况下消息发送方发送两个消息 C1 和 C2 分别接收到消息并进行处理  </p>
<p><img src="/2022/05/28/RabbitMQ/1647958068805-1653732359166.png" alt="1647958068805" loading="lazy"></p>
<p>在发送者发送消息 dd，发出消息之后的把 C2 消费者停掉，按理说该 C2 来处理该消息，但是 由于它处理时间较长，在还未处理完，也就是说 C2 还没有执行 ack 代码的时候，C2 被停掉了， 此时会看到消息被 C1 接收到了，说明消息 dd 被重新入队，然后分配给能处理消息的 C1 处理了  </p>
<p><img src="/2022/05/28/RabbitMQ/1647958093017-1653732359166.png" alt="1647958093017" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1647958099675-1653732359166.png" alt="1647958099675" loading="lazy"></p>
<h2 id="3，RabbitMQ-持久化"><a href="#3，RabbitMQ-持久化" class="headerlink" title="3，RabbitMQ 持久化"></a>3，RabbitMQ 持久化</h2><h3 id="3-1，概念"><a href="#3-1，概念" class="headerlink" title="3.1，概念"></a>3.1，概念</h3><p>刚刚我们已经看到了如何处理任务不丢失的情况，但是如何保障当 RabbitMQ 服务停掉以后消 息生产者发送过来的消息不丢失。<strong>默认情况下 RabbitMQ 退出或由于某种原因崩溃时，它忽视队列和消息，除非告知它不要这样做。确保消息不会丢失需要做两件事：我们需要将队列和消息都标记为持久化。</strong> </p>
<h3 id="3-2，队列如何实现持久化"><a href="#3-2，队列如何实现持久化" class="headerlink" title="3.2，队列如何实现持久化"></a>3.2，队列如何实现持久化</h3><p>之前我们创建的队列都是非持久化的，rabbitmq 如果重启的化，该队列就会被删除掉，如果 要队列实现持久化 需要在声明队列的时候把 durable 参数设置为持久化  </p>
<p><img src="/2022/05/28/RabbitMQ/1647958446351-1653732359166.png" alt="1647958446351" loading="lazy"></p>
<p>要记住一点，如果事先声明过队列，之后再进行修改持久化时就会报错，效果如下：</p>
<p><img src="/2022/05/28/RabbitMQ/1647958394199-1653732359166.png" alt="1647958394199" loading="lazy"></p>
<p>解决方案就是删除该队列重新创建。</p>
<p><img src="/2022/05/28/RabbitMQ/1647958560698-1653732359166.png" alt="1647958560698" loading="lazy"></p>
<p> 这个时候即使重启 rabbitmq 队列也依然存在 </p>
<h3 id="3-3，消息实现持久化"><a href="#3-3，消息实现持久化" class="headerlink" title="3.3，消息实现持久化"></a>3.3，消息实现持久化</h3><p>要想让消息实现持久化需要在消息生产者修改代码，MessageProperties.PERSISTENT_TEXT_PLAIN 添 加这个属性。  </p>
<p><img src="/2022/05/28/RabbitMQ/1647958787529-1653732359166.png" alt="1647958787529" loading="lazy"></p>
<p>将消息标记为持久化并不能完全保证不会丢失消息。尽管它告诉 RabbitMQ 将消息保存到磁盘，但是 这里依然存在当消息刚准备存储在磁盘的时候 但是还没有存储完，消息还在缓存的一个间隔点。此时并没 有真正写入磁盘。持久性保证并不强，但是对于我们的简单任务队列而言，这已经绰绰有余了。</p>
<h3 id="3-4，不公平分发"><a href="#3-4，不公平分发" class="headerlink" title="3.4，不公平分发"></a>3.4，不公平分发</h3><p>在最开始的时候我们学习到 RabbitMQ 分发消息采用的轮训分发，但是在某种场景下这种策略并不是 很好，比方说有两个消费者在处理任务，其中有个<strong>消费者 1 处理任务的速度非常快，而另外一个消费者 2 处理速度却很慢，这个时候我们还是采用轮训分发的化就会到这处理速度快的这个消费者很大一部分时间 处于空闲状态，而处理慢的那个消费者一直在干活，这种分配方式在这种情况下其实就不太好</strong>，但是 RabbitMQ 并不知道这种情况它依然很公平的进行分发。  （能者多劳）</p>
<p>为了避免这种情况，我们可以设置参数 channel.basicQos(1);  </p>
<p><img src="/2022/05/28/RabbitMQ/1647959485850-1653732359166.png" alt="1647959485850" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1647959520375-1653732359167.png" alt="1647959520375" loading="lazy"></p>
<p>意思就是如果这个任务我还没有处理完或者我还没有应答你，你先别分配给我，我目前只能处理一个 任务，然后 rabbitmq 就会把该任务分配给没有那么忙的那个空闲消费者，当然如果所有的消费者都没有完 成手上任务，队列还在不停的添加新任务，队列有可能就会遇到队列被撑满的情况，这个时候就只能添加新的 worker 或者改变其他存储任务的策略。 </p>
<h3 id="3-5，预取值"><a href="#3-5，预取值" class="headerlink" title="3.5，预取值"></a>3.5，预取值</h3><p> 本身消息的发送就是异步发送的，所以在任何时候，channel 上肯定不止只有一个消息另外来自消费者的手动确认本质上也是异步的。因此这里就存在<strong>一个未确认的消息缓冲区</strong>，因此希望开发人员<strong>能限制此缓冲区的大小</strong>，以避免缓冲区里面无限制的未确认消息问题。这个时候就<strong>可以通过使用 basic.qos 方法设 置“预取计数”值来完成的</strong>。该值定义通道上允许的未确认消息的最大数量。一旦数量达到配置的数量， RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认。</p>
<p>例如，假设在通道上有 未确认的消息 5、6、7，8，并且通道的预取计数设置为 4，此时 RabbitMQ 将不会在该通道上再传递任何 消息，除非至少有一个未应答的消息被 ack。比方说 tag=6 这个消息刚刚被确认 ACK，RabbitMQ 将会感知 这个情况到并再发送一条消息。消息应答和 QoS 预取值对用户吞吐量有重大影响。通常，增加预取将提高向消费者传递消息的速度。<strong>虽然自动应答传输消息速率是最佳的，但是，在这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的 RAM 消耗</strong>(随机存取存储器)应该小心使用具有无限预处理 的自动确认模式或手动确认模式，消费者消费了大量的消息如果没有确认的话，会导致消费者连接节点的 内存消耗变大，所以找到合适的预取值是一个反复试验的过程，<strong>不同的负载该值取值也不同 100 到 300 范 围内的值通常可提供最佳的吞吐量，并且不会给消费者带来太大的风险。</strong>预取值为 1 是最保守的。当然这将使吞吐量变得很低，特别是消费者连接延迟很严重的情况下，特别是在消费者连接等待时间较长的环境 中。对于大多数应用来说，稍微高一点的值将是最佳的。 </p>
<p><img src="/2022/05/28/RabbitMQ/1647959720299-1653732359167.png" alt="1647959720299" loading="lazy"></p>
<h1 id="四，发布确认"><a href="#四，发布确认" class="headerlink" title="四，发布确认"></a>四，发布确认</h1><h2 id="1，发布确认原理"><a href="#1，发布确认原理" class="headerlink" title="1，发布确认原理"></a>1，发布确认原理</h2><p>生产者将信道设置成 confirm 模式，一旦信道进入 confirm 模式，所有在该信道上面发布的消息都将会被指派一个唯一的 ID(从 1 开始)，一旦消息被投递到所有匹配的队列之后，broker 就会发送一个确认给生产者(包含消息的唯一 ID)，这就使得生产者知道消息已经正确到达目的队列了，如果消息和队列是可持久化的，那么确认消息会在将消息写入磁盘之后发出，broker 回传 给生产者的确认消息中 delivery-tag 域包含了确认消息的序列号，此外 broker 也可以设置 basic.ack 的 multiple 域，表示到这个序列号之前的所有消息都已经得到了处理。 </p>
<p>confirm 模式最大的好处在于他是异步的，一旦发布一条消息，生产者应用程序就可以在等信 道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用便可以通过回调 方法来处理该确认消息，如果 RabbitMQ 因为自身内部错误导致消息丢失，就会发送一条 nack 消 息，生产者应用程序同样可以在回调方法中处理该 nack 消息。</p>
<p><img src="/2022/05/28/RabbitMQ/1648025889672-1653732359167.png" alt="1648025889672" loading="lazy"></p>
<p>简言之，在队列持久化，消息持久化的前提下，如果生产者发送了消息，我们的中间消息组件在消息完成持久化后，给生产者发送确认的消息。</p>
<h2 id="2，-发布确认的策略"><a href="#2，-发布确认的策略" class="headerlink" title="2， 发布确认的策略"></a>2， 发布确认的策略</h2><h3 id="2-1，开启发布确认的方法"><a href="#2-1，开启发布确认的方法" class="headerlink" title="2.1，开启发布确认的方法"></a>2.1，开启发布确认的方法</h3><p>发布确认默认是没有开启的，如果要开启需要调用方法 confirmSelect，每当你要想使用发布 确认，都需要在 channel 上调用该方法。</p>
<p><img src="/2022/05/28/RabbitMQ/1648026057309-1653732359167.png" alt="1648026057309" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">channel.confirmSelect();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2，单个确认发布"><a href="#2-2，单个确认发布" class="headerlink" title="2,2，单个确认发布"></a>2,2，单个确认发布</h3><p>这是一种简单的确认方式，它是一种同步确认发布的方式，<strong>也就是发布一个消息之后只有它被确认发布，后续的消息才能继续发布</strong>,<code>waitForConfirmsOrDie(long)</code>这个方法只有在消息被确认 的时候才返回，如果在指定时间范围内这个消息没有被确认那么它将抛出异常。 </p>
<p>这种确认方式有一个<strong>最大的缺点就是:发布速度特别的慢</strong>，因为如果没有确认发布的消息就会 阻塞所有后续消息的发布，这种方式最多提供每秒不超过数百条发布消息的吞吐量。当然对于某 些应用程序来说这可能已经足够了。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo04;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ConfirmMessage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 单个确认</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 16:40</span></span><br><span class="line"><span class="comment"> * 发布确认模式</span></span><br><span class="line"><span class="comment"> * 使用的时间  比较哪种方式是最好的。</span></span><br><span class="line"><span class="comment"> * 1，单个确认</span></span><br><span class="line"><span class="comment"> * 2，批量确认</span></span><br><span class="line"><span class="comment"> * 3，异步批量确认</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//批量发送消息的个数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MESSAGE_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//发布1000条单独确认消息，耗时37361ms</span></span><br><span class="line">        ConfirmMessage.publishMessageIndividually();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//单个确认</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageIndividually</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//队列的声明</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//开启发布确认</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//批量发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i + <span class="string">&quot;&quot;</span>;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            <span class="comment">//单个消息马上确认</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> channel.waitForConfirms();</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;发布1000条单独确认消息，耗时&quot;</span> + (end - begin) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/2022/05/28/RabbitMQ/1648026218607-1653732359167.png" alt="1648026218607" loading="lazy"></p>
<h3 id="2-3，批量确认发布"><a href="#2-3，批量确认发布" class="headerlink" title="2.3，批量确认发布"></a>2.3，批量确认发布</h3><p>上面那种方式非常慢，与单个等待确认消息相比，先发布一批消息然后一起确认可以极大地 提高吞吐量，当然这种方式的缺点就是:当发生故障导致发布出现问题时，不知道是哪个消息出现 问题了，我们必须将整个批处理保存在内存中，以记录重要的信息而后重新发布消息。当然这种 方案仍然是同步的，也一样阻塞消息的发布。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量确认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageBatch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//队列的声明</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//开启发布确认</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//批量确认消息的大小</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">//批量发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= MESSAGE_COUNT; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i + <span class="string">&quot;&quot;</span>;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            <span class="keyword">if</span> (i % batchSize == <span class="number">0</span>) &#123;</span><br><span class="line">                channel.waitForConfirms();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;发布1000条批量确认消息，耗时&quot;</span> + (end - begin) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/2022/05/28/RabbitMQ/1648026639050-1653732359167.png" alt="1648026639050" loading="lazy"></p>
<h3 id="2-4，异步发布确认"><a href="#2-4，异步发布确认" class="headerlink" title="2.4，异步发布确认"></a>2.4，异步发布确认</h3><p>异步确认虽然编程逻辑比上两个要复杂，但是性价比最高，无论是可靠性还是效率都没得说， 他是<strong>利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功</strong>， 下面就让我们来详细讲解异步确认是怎么实现的。  </p>
<p><img src="/2022/05/28/RabbitMQ/1648027601870-1653732359167.png" alt="1648027601870" loading="lazy"></p>
<p>简言之，你先发消息，到后面我们会告诉生产者那个消息我们收到了，哪个消息我们没收到，这是依赖确认监听器完成的。</p>
<p><img src="/2022/05/28/RabbitMQ/1648027754135-1653732359167.png" alt="1648027754135" loading="lazy"></p>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line">     * 异步确认</span><br><span class="line">     * <span class="meta">@throws</span> Exception</span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageAsync</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//队列的声明</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//开启发布确认</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//准备一个消息的监听器 监听那个消息成功了，那些消息失败了</span></span><br><span class="line">        <span class="comment">//消息确认回调函数</span></span><br><span class="line">        <span class="type">ConfirmCallback</span> <span class="variable">ackCallback</span> <span class="operator">=</span> (deliveryTag, multiple) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;确认的消息：&quot;</span> + deliveryTag);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//消息确认失败回调函数 1,消息标记 2，是否为批量确认</span></span><br><span class="line">        <span class="type">ConfirmCallback</span> <span class="variable">nackCallback</span> <span class="operator">=</span> (deliveryTag, multiple) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;未确认的消息：&quot;</span> + deliveryTag);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1,监听那些消息成功</span></span><br><span class="line"><span class="comment">         * 2，监听那些消息失败</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.addConfirmListener(ackCallback, nackCallback);</span><br><span class="line">        <span class="comment">//批量发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;消息&quot;</span> + i;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;发布1000条异步确认消息，耗时&quot;</span> + (end - begin) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="/2022/05/28/RabbitMQ/1648027820046-1653732359167.png" alt="1648027820046" loading="lazy"></p>
<h3 id="2-5，如何处理异步未确认消息"><a href="#2-5，如何处理异步未确认消息" class="headerlink" title="2.5，如何处理异步未确认消息"></a>2.5，如何处理异步未确认消息</h3><p>最好的解决的解决方案就是把未确认的消息放到一个基于内存的能被发布线程访问的队列， 比如说用 ConcurrentLinkedQueue 这个队列在 confirm callbacks 与发布线程之间进行消息的传递。</p>
<p><strong>具体流程如下：</strong></p>
<ol>
<li>创建一个线程安全有序的哈希表<code>ConcurrentSkipListMap</code> ,key值存放消息的发布序列，value存放的是消息体。</li>
<li>在发送消息的时候将都有的消息添加入上面的map中</li>
<li>通过监听器的回调去实现具体的方法<ul>
<li>消息确认<ul>
<li>如果是批量操作，我们可以通过<code>concurrentSkipListMap.headMap()</code>方法找到所有的确认过的消息，参数是消息的标签。然后通过删除这些消息。</li>
<li>如果不允许批量操作，我们只能直接删除，即<code>concurrentSkipListMap.remove(deliveryTag);</code>。</li>
</ul>
</li>
<li>消息确认失败<ul>
<li>我们可以通过<code>concurrentSkipListMap.get()</code>方法找到确认失败的消息，将其重新加入信道。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步确认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">publishMessageAsync</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//队列的声明</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//开启发布确认</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 线程安全有序的一个哈希表，适用于高并发的情况下</span></span><br><span class="line"><span class="comment">         * 1,轻松的将序号于消息关联</span></span><br><span class="line"><span class="comment">         * 2，可以轻松的批量删除条目，只要给到序号</span></span><br><span class="line"><span class="comment">         * 3，支持高并发</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ConcurrentSkipListMap&lt;Long,String&gt; concurrentSkipListMap = <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//准备一个消息的监听器 监听那个消息成功了，那些消息失败了</span></span><br><span class="line">        <span class="comment">//消息确认回调函数</span></span><br><span class="line">        <span class="type">ConfirmCallback</span> <span class="variable">ackCallback</span> <span class="operator">=</span> (deliveryTag, multiple) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (multiple) &#123;</span><br><span class="line">                <span class="comment">//删除确认消息</span></span><br><span class="line">                ConcurrentNavigableMap&lt;Long, String&gt; confirmed = concurrentSkipListMap.headMap(deliveryTag);</span><br><span class="line">                confirmed.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                concurrentSkipListMap.remove(deliveryTag);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;确认的消息：&quot;</span> + deliveryTag);</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//消息确认失败回调函数 1,消息标记 2，是否为批量确认</span></span><br><span class="line">        <span class="type">ConfirmCallback</span> <span class="variable">nackCallback</span> <span class="operator">=</span> (deliveryTag, multiple) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;未确认的消息：&quot;</span> + deliveryTag);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1,监听那些消息成功</span></span><br><span class="line"><span class="comment">         * 2，监听那些消息失败</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.addConfirmListener(ackCallback, nackCallback);</span><br><span class="line">        <span class="comment">//批量发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MESSAGE_COUNT; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;消息&quot;</span> + i;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,queueName,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1,保存所有的消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            concurrentSkipListMap.put(channel.getNextPublishSeqNo(), message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;发布1000条异步确认消息，耗时&quot;</span> + (end - begin) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-6，以上-3-种发布确认速度对比"><a href="#2-6，以上-3-种发布确认速度对比" class="headerlink" title="2.6，以上 3 种发布确认速度对比"></a>2.6，以上 3 种发布确认速度对比</h3><ul>
<li>单独发布消息<ul>
<li> 同步等待确认，简单，但吞吐量非常有限。</li>
</ul>
</li>
<li>批量发布消息 <ul>
<li> 批量同步等待确认，简单，合理的吞吐量，一旦出现问题但很难推断出是那条 消息出现了问题。</li>
</ul>
</li>
<li>异步处理 <ul>
<li> 最佳性能和资源使用，在出现错误的情况下可以很好地控制，但是实现起来稍微难些 </li>
</ul>
</li>
</ul>
<p><img src="/2022/05/28/RabbitMQ/1648029492967-1653732359167.png" alt="1648029492967" loading="lazy"></p>
<h1 id="五，交换机"><a href="#五，交换机" class="headerlink" title="五，交换机"></a>五，交换机</h1><p>我们创建了一个工作队列。我们假设的是工作队列背后，每个任务都恰好交付给一个消 费者(工作进程)。在这一部分中，我们将做一些完全不同的事情-我们将消息传达给多个消费者。这种模式 称为 ”发布/订阅”.  </p>
<p>为了说明这种模式，我们将构建一个简单的日志系统。它将由两个程序组成:第一个程序将发出日志消 息，第二个程序是消费者。其中我们会启动两个消费者，其中一个消费者接收到消息后把日志存储在磁盘， 另外一个消费者接收到消息后把消息打印在屏幕上，事实上第一个程序发出的日志消息将广播给所有消费 者者  </p>
<p><strong>默认交换机的工作图</strong></p>
<p><img src="/2022/05/28/RabbitMQ/1648038950025-1653732359167.png" alt="1648038950025" loading="lazy"></p>
<p><strong>自己加上的交换机的工作图</strong></p>
<p><img src="/2022/05/28/RabbitMQ/1648038972483-1653732359167.png" alt="1648038972483" loading="lazy"></p>
<h2 id="1，Exchanges"><a href="#1，Exchanges" class="headerlink" title="1，Exchanges"></a>1，Exchanges</h2><h3 id="1-1，Exchanges-概念"><a href="#1-1，Exchanges-概念" class="headerlink" title="1.1，Exchanges 概念"></a>1.1，Exchanges 概念</h3><p>RabbitMQ 消息传递模型的核心思想是: <strong>生产者生产的消息从不会直接发送到队列</strong>。实际上，通常生产者甚至都不知道这些消息传递传递到了哪些队列中。 </p>
<p>相反，**生产者只能将消息发送到交换机(exchange)**，交换机工作的内容非常简单，一方面它接收来自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消 息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。  </p>
<p><img src="/2022/05/28/RabbitMQ/1648039277010-1653732359167.png" alt="1648039277010" loading="lazy"></p>
<h3 id="1-2，Exchanges-的类型"><a href="#1-2，Exchanges-的类型" class="headerlink" title="1.2，Exchanges 的类型"></a>1.2，Exchanges 的类型</h3><p> 总共有以下类型：</p>
<ul>
<li>直接(direct)</li>
<li>主题(topic) </li>
<li>标题(headers) </li>
<li>扇出(fanout)  </li>
</ul>
<h3 id="1-3，无名-exchange"><a href="#1-3，无名-exchange" class="headerlink" title="1.3，无名 exchange"></a>1.3，无名 exchange</h3><p>在本教程的前面部分我们对 exchange 一无所知，但仍然能够将消息发送到队列。之前能实现的原因是<strong>因为我们使用的是默认交换，我们通过空字符串(“”)进行标识。</strong> </p>
<p><img src="/2022/05/28/RabbitMQ/1648039382216-1653732359167.png" alt="1648039382216" loading="lazy"></p>
<p>第一个参数是交换机的名称。空字符串表示默认或无名称交换机：消息能路由发送到队列中其实是由 <code>routingKey(bindingkey)</code>绑定 key 指定的，如果它存在的话。</p>
<h2 id="2，-临时队列"><a href="#2，-临时队列" class="headerlink" title="2， 临时队列"></a>2， 临时队列</h2><p>之前的章节我们使用的是具有特定名称的队列(还记得 hello 和 ack_queue 吗？)。队列的名称我们 来说至关重要-我们需要指定我们的消费者去消费哪个队列的消息。 </p>
<p>每当我们连接到 Rabbit 时，我们都需要一个全新的空队列，为此我们可以创建一个具有<strong>随机名称的队列</strong>，或者能让服务器为我们选择一个随机队列名称那就更好了。其次<strong>一旦我们断开了消费者的连 接，队列将被自动删除。</strong> </p>
<p>创建临时队列的方式如下: </p>
<p><code>String queueName = channel.queueDeclare().getQueue(); </code></p>
<p>创建出来之后长成这样: </p>
<p><img src="/2022/05/28/RabbitMQ/1648039590414-1653732359167.png" alt="1648039590414" loading="lazy"></p>
<h2 id="3，绑定-bindings"><a href="#3，绑定-bindings" class="headerlink" title="3，绑定(bindings)"></a>3，绑定(bindings)</h2><p>什么是 bingding 呢，binding 其实是 exchange 和 queue 之间的桥梁，它告诉我们 exchange 和那个队 列进行了绑定关系。比如说下面这张图告诉我们的就是 X 与 Q1 和 Q2 进行了绑定 。</p>
<p><img src="/2022/05/28/RabbitMQ/1648039839475-1653732359167.png" alt="1648039839475" loading="lazy"></p>
<h2 id="4，Fanout"><a href="#4，Fanout" class="headerlink" title="4，Fanout"></a>4，Fanout</h2><h3 id="4-1，Fanout-介绍"><a href="#4-1，Fanout-介绍" class="headerlink" title="4.1，Fanout 介绍"></a>4.1，Fanout 介绍</h3><p>Fanout 这种类型非常简单。正如从名称中猜到的那样，<strong>它是将接收到的所有消息广播到它知道的所有队列中</strong>。系统中默认有些 exchange 类型。</p>
<p><img src="/2022/05/28/RabbitMQ/1648041267722-1653732359167.png" alt="1648041267722" loading="lazy"></p>
<h3 id="4-2，Fanout-实战"><a href="#4-2，Fanout-实战" class="headerlink" title="4.2，Fanout 实战"></a>4.2，Fanout 实战</h3><p><img src="/2022/05/28/RabbitMQ/1648041286722-1653732359167.png" alt="1648041286722" loading="lazy"></p>
<p> Logs 和临时队列的绑定关系如下图  </p>
<p><img src="/2022/05/28/RabbitMQ/1648041301904-1653732359167.png" alt="1648041301904" loading="lazy"></p>
<p> <strong>ReceiveLogs01 将接收到的消息打印在控制台</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo05;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogs01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: fanout交换机的接收消息方</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 20:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogs01</span> &#123;</span><br><span class="line">    <span class="comment">//交换机的名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明一个临时队列,队列的名称是随机的</span></span><br><span class="line"><span class="comment">         * 当消费者断开与队列连接的时候，队列就会自动删除</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 绑定交换机与队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息，把接收到消息打印在屏幕上&quot;</span>);</span><br><span class="line">        <span class="comment">//收到消息后的回调</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;01打印接受到的消息&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queue,<span class="literal">true</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ReceiveLogs02 将接收到的消息打印在控制台</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo05;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogs01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: fanout交换机的接收消息方</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 20:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogs02</span> &#123;</span><br><span class="line">    <span class="comment">//交换机的名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 声明一个临时队列,队列的名称是随机的</span></span><br><span class="line"><span class="comment">         * 当消费者断开与队列连接的时候，队列就会自动删除</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 绑定交换机与队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息，把接收到消息打印在屏幕上&quot;</span>);</span><br><span class="line">        <span class="comment">//收到消息后的回调</span></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;02打印接受到的消息&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queue,<span class="literal">true</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>EmitLog 发送消息给两个消费者接收</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: EmitLog</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: fanout交换机的生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLog</span> &#123;</span><br><span class="line">    <span class="comment">//交换机的名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="comment">//这四个属性分别为交换机名称，路由的key，消息的其他属性，消息体</span></span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;生产者发出消息&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意点：</strong></p>
<p>fanout exception交换机，他就是给他绑定的所有的消费者都发送消息，与<code>routingKey</code>无关。</p>
<h2 id="5，Direct-exchange"><a href="#5，Direct-exchange" class="headerlink" title="5，Direct exchange"></a>5，Direct exchange</h2><h3 id="5-1，Direct-exchange-介绍"><a href="#5-1，Direct-exchange-介绍" class="headerlink" title="5.1，Direct exchange 介绍"></a>5.1，Direct exchange 介绍</h3><p>上一节中的我们的日志系统将所有消息广播给所有消费者，对此我们想做一些改变，例如我们希望将日志消息写入磁盘的程序仅接收严重错误(errros)，而不存储哪些警告(warning)或信息(info)日志 消息避免浪费磁盘空间。Fanout 这种交换类型并不能给我们带来很大的灵活性-它只能进行无意识的 广播，在这里我们将使用 direct 这种类型来进行替换，这种类型的工作方式是，消息只去到它绑定的 routingKey 队列中去。  </p>
<p><img src="/2022/05/28/RabbitMQ/1648042584000-1653732359167.png" alt="1648042584000" loading="lazy"></p>
<p>在上面这张图中，我们可以看到 X 绑定了两个队列，绑定类型是 direct。队列 Q1 绑定键为 orange， 队列 Q2 绑定键有两个:一个绑定键为 black，另一个绑定键为 green. </p>
<p>在这种绑定情况下，生产者发布消息到 exchange 上，绑定键为 orange 的消息会被发布到队列 Q1。绑定键为 blackgreen 和的消息会被发布到队列 Q2，其他消息类型的消息将被丢弃。 </p>
<h3 id="5-2，多重绑定"><a href="#5-2，多重绑定" class="headerlink" title="5.2，多重绑定"></a>5.2，多重绑定</h3><p><img src="/2022/05/28/RabbitMQ/1648042803293-1653732359167.png" alt="1648042803293" loading="lazy"></p>
<p>当然如果 exchange 的绑定类型是 direct，但是它绑定的多个队列的 key 如果都相同，在这种情 况下虽然绑定类型是 direct 但是它表现的就和 fanout 有点类似了，就跟广播差不多，如上图所示。  </p>
<h3 id="5-3，实战"><a href="#5-3，实战" class="headerlink" title="5.3，实战"></a>5.3，实战</h3><p><img src="/2022/05/28/RabbitMQ/1648042848453-1653732359167.png" alt="1648042848453" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1648042856445-1653732359167.png" alt="1648042856445" loading="lazy"></p>
<p><strong>ReceiveLogsDirect01</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo06;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogsDirect01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsDirect01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机（另外一种写法）</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;console&quot;</span>;</span><br><span class="line">        <span class="comment">//声明一个队列</span></span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;waring&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ReceiveLogsDirect01控制台打印消息&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ReceiveLogsDirect02</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo06;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogsDirect01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsDirect02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;disk&quot;</span>;</span><br><span class="line">        <span class="comment">//声明一个队列</span></span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ReceiveLogsDirect02控制台打印消息&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>EmitLogDirect</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo06;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: EmitLogDirect</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLogDirect</span> &#123;</span><br><span class="line">    <span class="comment">//交换机的名字</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;direct_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="comment">//我们发送的消息的key是err</span></span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;error&quot;</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;生产者发出消息&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意，这里最好将三个地方全部绑定，这样子我们就可以随机启动如何一个了。</p>
<h2 id="6，Topics"><a href="#6，Topics" class="headerlink" title="6，Topics"></a>6，Topics</h2><h3 id="6-1，之前类型的问题"><a href="#6-1，之前类型的问题" class="headerlink" title="6.1，之前类型的问题"></a>6.1，之前类型的问题</h3><p>扇形交换机他只能无差别的分发消息。直接交换机只能将一个消息发送给相同routingKey的队列，但是我们又可能会发生一种情况，就是要将相同的消息发送给不一样的routingKey的队列，这个时候就可以使用主题交换机。</p>
<h3 id="6-2，Topic-的要求"><a href="#6-2，Topic-的要求" class="headerlink" title="6.2，Topic 的要求"></a>6.2，Topic 的要求</h3><p>发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，它必须是一个单词列表，以点号分隔开。这些单词可以是任意单词，比如说：”stock.usd.nyse”, “nyse.vmw”,  “quick.orange.rabbit”.这种类型的。当然这个单词列表最多不能超过 255 个字节。  </p>
<p>在这个规则列表中，其中有两个替换符是大家需要注意的  </p>
<ul>
<li> *(星号)可以代替一个单词 </li>
<li> #(井号)可以替代零个或多个单词 </li>
</ul>
<h3 id="6-3，Topic-匹配案例"><a href="#6-3，Topic-匹配案例" class="headerlink" title="6.3，Topic 匹配案例"></a>6.3，Topic 匹配案例</h3><p><img src="/2022/05/28/RabbitMQ/1648044330768-1653732359167.png" alt="1648044330768" loading="lazy"></p>
<p>上图是一个队列绑定关系图，我们来看看他们之间数据接收情况是怎么样的 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">quick.orange.rabbit 被队列 Q1Q2 接收到</span><br><span class="line">lazy.orange.elephant 被队列 Q1Q2 接收到</span><br><span class="line">quick.orange.fox 被队列 Q1 接收到</span><br><span class="line">lazy.brown.fox 被队列 Q2 接收到</span><br><span class="line">lazy.pink.rabbit 虽然满足两个绑定但只被队列 Q2 接收一次</span><br><span class="line">quick.brown.fox 不匹配任何绑定不会被任何队列接收到会被丢弃</span><br><span class="line">quick.orange.male.rabbit 是四个单词不匹配任何绑定会被丢弃</span><br><span class="line">lazy.orange.male.rabbit 是四个单词但匹配 Q2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 当队列绑定关系是下列这种情况时需要引起注意</p>
<ul>
<li> <strong>当一个队列绑定键是#,那么这个队列将接收所有数据，就有点像 fanout 了</strong> </li>
<li> <strong>如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了</strong> </li>
</ul>
<h3 id="6-4，-实战"><a href="#6-4，-实战" class="headerlink" title="6.4， 实战"></a>6.4， 实战</h3><p><img src="/2022/05/28/RabbitMQ/1648044542995-1653732359167.png" alt="1648044542995" loading="lazy"></p>
<p><strong>EmitLogTopic</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo07;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: EmitLogTopic</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmitLogTopic</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Q1--&gt;绑定的是</span></span><br><span class="line"><span class="comment">         * 中间带 orange 带 3 个单词的字符串(*.orange.*)</span></span><br><span class="line"><span class="comment">         * Q2--&gt;绑定的是</span></span><br><span class="line"><span class="comment">         * 最后一个单词是 rabbit 的 3 个单词(*.*.rabbit)</span></span><br><span class="line"><span class="comment">         * 第一个单词是 lazy 的多个单词(lazy.#)</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String, String&gt; bindingKeyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;quick.orange.rabbit&quot;</span>,<span class="string">&quot;被队列 Q1Q2 接收到&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;lazy.orange.elephant&quot;</span>,<span class="string">&quot;被队列 Q1Q2 接收到&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;quick.orange.fox&quot;</span>,<span class="string">&quot;被队列 Q1 接收到&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;lazy.brown.fox&quot;</span>,<span class="string">&quot;被队列 Q2 接收到&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;lazy.pink.rabbit&quot;</span>,<span class="string">&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;quick.brown.fox&quot;</span>,<span class="string">&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;quick.orange.male.rabbit&quot;</span>,<span class="string">&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span>);</span><br><span class="line">        bindingKeyMap.put(<span class="string">&quot;lazy.orange.male.rabbit&quot;</span>,<span class="string">&quot;是四个单词但匹配 Q2&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; bindingKeyEntry: bindingKeyMap.entrySet())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">bindingKey</span> <span class="operator">=</span> bindingKeyEntry.getKey();</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> bindingKeyEntry.getValue();</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,bindingKey, <span class="literal">null</span>,</span><br><span class="line">                    message.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;生产者发出消息&quot;</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ReceiveLogsTopic02</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo07;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogsTopic02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: z主题交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsTopic02</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="comment">//声明队列</span></span><br><span class="line">        String queueName=<span class="string">&quot;Q2&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME,  <span class="string">&quot;*.*.rabbit&quot;</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME,   <span class="string">&quot;lazy.#&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot; 接收队列2 :&quot;</span>+queueName+<span class="string">&quot; 绑 定 键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;,消息:&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ReceiveLogsTopic01</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo07;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ReceiveLogsTopic01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: z主题交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/23 21:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveLogsTopic01</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//声明一个交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        <span class="comment">//声明队列</span></span><br><span class="line">        String queueName=<span class="string">&quot;Q1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueBind(queueName, EXCHANGE_NAME, <span class="string">&quot;*.orange.*&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, delivery) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot; 接收队列1 :&quot;</span>+queueName+<span class="string">&quot; 绑 定 键:&quot;</span>+delivery.getEnvelope().getRoutingKey()+<span class="string">&quot;,消息:&quot;</span>+message);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, deliverCallback, consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="六，死信队列"><a href="#六，死信队列" class="headerlink" title="六，死信队列"></a>六，死信队列</h1><h2 id="1，死信的概念"><a href="#1，死信的概念" class="headerlink" title="1，死信的概念"></a>1，死信的概念</h2><p>先从概念解释上搞清楚这个定义，<strong>死信，顾名思义就是无法被消费的消息</strong>，字面意思可以这样理解，一般来说，producer 将消息投递到 broker 或者直接到 queue 里了，consumer 从 queue 取出消息 进行消费，但某些时候<strong>由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列。</strong> </p>
<p>应用场景:为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息消费发生异常时，将消息投入死信队列中.还有比如说: 用户在商城下单成功并点击去支付后在指定时间未支付时自动失效 </p>
<h2 id="2，死信的来源"><a href="#2，死信的来源" class="headerlink" title="2，死信的来源"></a>2，死信的来源</h2><ul>
<li> 消息 TTL 过期（消息的过期时间）</li>
<li> 队列达到最大长度(队列满了，无法再添加数据到 mq 中)  </li>
<li> 消息被拒绝(basic.reject 或 basic.nack)并且 requeue=false.（不放入队列中）</li>
</ul>
<h2 id="3，死信实战"><a href="#3，死信实战" class="headerlink" title="3，死信实战"></a>3，死信实战</h2><h3 id="3-1，代码架构图"><a href="#3-1，代码架构图" class="headerlink" title="3.1，代码架构图"></a>3.1，代码架构图</h3><p><img src="/2022/05/28/RabbitMQ/1648113740834-1653732359167.png" alt="1648113740834" loading="lazy"></p>
<h3 id="3-2，消息-TTL-过期"><a href="#3-2，消息-TTL-过期" class="headerlink" title="3.2，消息 TTL 过期"></a>3.2，消息 TTL 过期</h3><p><strong>生产者代码</strong>  </p>
<p>生产者的代码与</p>
<p>之前的区别在于我们多加了一个过期时间，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置消息的 TTL 时间</span></span><br><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().</span><br><span class="line">    builder().expiration(<span class="string">&quot;10000&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>,properties,</span><br><span class="line">                        message.getBytes());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>全部代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo08;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">//设置消息的 TTL 时间</span></span><br><span class="line">            AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().expiration(<span class="string">&quot;10000&quot;</span>).build();</span><br><span class="line">            <span class="comment">//该信息是用作演示队列个数限制</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span> ; i++) &#123;</span><br><span class="line">                String message=<span class="string">&quot;info&quot;</span>+i;</span><br><span class="line">                channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>,properties,</span><br><span class="line">                        message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发送消息:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>消费者</strong></p>
<ul>
<li><p>一个消费者要有两个交换机和两个队列，分别为两套，一个是正常的，一个是死信的</p>
</li>
<li><p>之前我们去创建队列的时候一直没有使用附加参数的，而在使用死信队列的时候则需要使用这个附加参数</p>
<ul>
<li><p>附加参数是Map结构的<code>Map&lt;String, Object&gt; arguments</code></p>
</li>
<li><p>使用到的参数有这个正常队列的死信交换机是哪个，他们之间的routingKey是啥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo08;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 死信队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 17:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line">    <span class="comment">//普通交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">//死信交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">//正常队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_QUEUE</span> <span class="operator">=</span>  <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">    <span class="comment">//死信队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;dead_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明死信喝普通交换机 类型为direct</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明一个普通队列</span></span><br><span class="line">        Map&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-max-length&quot;</span>, <span class="number">6</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        channel.queueDeclare(NORMAL_QUEUE,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,arguments);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明要给死信队列</span></span><br><span class="line">        channel.queueDeclare(DEAD_QUEUE,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定普通的交换机与普通队列</span></span><br><span class="line">        channel.queueBind(NORMAL_QUEUE, NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        <span class="comment">//绑定死信交换机和死信队列</span></span><br><span class="line">        channel.queueBind(DEAD_QUEUE, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer01 接收到消息&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(NORMAL_QUEUE,<span class="literal">true</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>死信消费者</strong></p>
<ul>
<li>这个消费者就是一个最原始的消费者，只负责输出死信队列的消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo08;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 死信队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 17:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02</span> &#123;</span><br><span class="line">    <span class="comment">//死信队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;dead_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Consumer02 接收到消息&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(DEAD_QUEUE,<span class="literal">true</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>运行结果</strong></p>
<p><img src="/2022/05/28/RabbitMQ/1648116923890-1653732359167.png" alt="1648116923890" loading="lazy"></p>
<h3 id="3-3，队列达到最大长度"><a href="#3-3，队列达到最大长度" class="headerlink" title="3.3，队列达到最大长度"></a>3.3，队列达到最大长度</h3><ol>
<li><p>消息生产者代码去掉 TTL 属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo08;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel()) &#123;</span><br><span class="line">            channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">            <span class="comment">//该信息是用作演示队列个数限制</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span> ; i++) &#123;</span><br><span class="line">                String message=<span class="string">&quot;info&quot;</span>+i;</span><br><span class="line">                channel.basicPublish(NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                        message.getBytes());</span><br><span class="line">                System.out.println(<span class="string">&quot;生产者发送消息:&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>C1 消费者修改以下代码(启动之后关闭该消费者 模拟其接收不到消息) </p>
<p><img src="/2022/05/28/RabbitMQ/1648117085967-1653732359167.png" alt="1648117085967" loading="lazy"></p>
<p>这个时候我们发现我们还是收不到消息，是因为我们这个队列之前已经创建好了，而参数又发生了变化，必须要删了重新创建。</p>
</li>
<li><p>C2 消费者代码不变(启动 C2 消费者) </p>
</li>
</ol>
<p><img src="/2022/05/28/RabbitMQ/1648117183741-1653732359167.png" alt="1648117183741" loading="lazy"></p>
<h3 id="3-4，消息被拒"><a href="#3-4，消息被拒" class="headerlink" title="3.4，消息被拒"></a>3.4，消息被拒</h3><ol>
<li><p>消息生产者代码同上生产者一致  </p>
</li>
<li><p>C1 消费者代码(启动之后关闭该消费者 模拟其接收不到消息) </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.rabbitmq.demo08;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DeliverCallback;</span><br><span class="line"><span class="keyword">import</span> com.zhao.rabbitmq.utils.RabbitMqUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 死信队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 17:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01</span> &#123;</span><br><span class="line">    <span class="comment">//普通交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;normal_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">//死信交换机名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line">    <span class="comment">//正常队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NORMAL_QUEUE</span> <span class="operator">=</span>  <span class="string">&quot;normal-queue&quot;</span>;</span><br><span class="line">    <span class="comment">//死信队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;dead_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明死信喝普通交换机 类型为direct</span></span><br><span class="line">        channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明一个普通队列</span></span><br><span class="line">        Map&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        <span class="comment">//arguments.put(&quot;x-max-length&quot;, 6);</span></span><br><span class="line">        <span class="comment">//arguments.put(&quot;x-message-ttl&quot;, 10000);</span></span><br><span class="line">        channel.queueDeclare(NORMAL_QUEUE,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,arguments);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明要给死信队列</span></span><br><span class="line">        channel.queueDeclare(DEAD_QUEUE,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定普通的交换机与普通队列</span></span><br><span class="line">        channel.queueBind(NORMAL_QUEUE, NORMAL_EXCHANGE, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        <span class="comment">//绑定死信交换机喝四星队列</span></span><br><span class="line">        channel.queueBind(DEAD_QUEUE, DEAD_EXCHANGE, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息.....&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">DeliverCallback</span> <span class="variable">deliverCallback</span> <span class="operator">=</span> (consumerTag, message) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg.equals(<span class="string">&quot;info5&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Consumer01 接收到消息&quot;</span> + msg + <span class="string">&quot;此消息是被拒绝的&quot;</span>);</span><br><span class="line">                channel.basicReject(message.getEnvelope().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Consumer01 接收到消息&quot;</span>+msg);</span><br><span class="line">                channel.basicAck(message.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(NORMAL_QUEUE,<span class="literal">false</span>,deliverCallback,consumerTag -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>消息被拒就是多了一个手动应答和判断的过程，同时也要关闭自动应答的选项</p>
<h1 id="七，延时队列"><a href="#七，延时队列" class="headerlink" title="七，延时队列"></a>七，延时队列</h1><h2 id="1，延迟队列概念"><a href="#1，延迟队列概念" class="headerlink" title="1，延迟队列概念"></a>1，延迟队列概念</h2><p>延时队列,队列内部是有序的，最重要的特性就体现在它的延时属性上，延时队列中的元素是希望 在指定时间到了以后或之前取出和处理，简单来说，<strong>延时队列就是用来存放需要在指定时间被处理的元素的队列。</strong> </p>
<h2 id="2，延迟队列使用场景"><a href="#2，延迟队列使用场景" class="headerlink" title="2，延迟队列使用场景"></a>2，延迟队列使用场景</h2><p><img src="/2022/05/28/RabbitMQ/1648127112937-1653732359167.png" alt="1648127112937" loading="lazy"></p>
<p>这些场景都有一个特点，需要在某个事件发生之后或者之前的指定时间点完成某一项任务，如： 发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭；<strong>看起来似乎 使用定时任务，一直轮询数据，每秒查一次，取出需要被处理的数据</strong>，然后处理不就完事了吗？<strong>如果数据量比较少，确实可以这样做</strong>，比如：对于“如果账单一周内未支付则进行自动结算”这样的需求， 如果对于时间不是严格限制，而是宽松意义上的一周，那么每天晚上跑个定时任务检查一下所有未支 付的账单，确实也是一个可行的方案。<strong>但对于数据量比较大，并且时效性较强的场景</strong>，如：“订单十 分钟内未支付则关闭“，短期内未支付的订单数据可能会有很多，活动期间甚至会达到百万甚至千万 级别，<strong>对这么庞大的数据量仍旧使用轮询的方式显然是不可取的</strong>，很可能在一秒内无法完成所有订单的检查，同时<strong>会给数据库带来很大压力，无法满足业务要求而且性能低下</strong>。 </p>
<p><img src="/2022/05/28/RabbitMQ/1648127185064-1653732359167.png" alt="1648127185064" loading="lazy"></p>
<h2 id="3，RabbitMQ-中的-TTL"><a href="#3，RabbitMQ-中的-TTL" class="headerlink" title="3，RabbitMQ 中的 TTL"></a>3，RabbitMQ 中的 TTL</h2><p>TTL 是什么呢？TTL 是 RabbitMQ 中一个消息或者队列的属性，<strong>表明一条消息或者该队列中的所有消息的最大存活时间，   单位是毫秒。</strong>换句话说，如果一条消息设置了 TTL 属性或者进入了设置 TTL 属性的队列，那么这条消息<strong>如果在 TTL 设置的时间内没有被消费，则会成为”死信”。</strong>如果同时配置了队列的 TTL 和消息的 TTL，那么较小的那个值将会被使用，有两种方式设置 TTL。  </p>
<h3 id="3-1，队列设置-TTL"><a href="#3-1，队列设置-TTL" class="headerlink" title="3.1，队列设置 TTL"></a>3.1，队列设置 TTL</h3><p> 第一种是在创建队列的时候设置队列的“x-message-ttl”属性  </p>
<p><img src="/2022/05/28/RabbitMQ/1653325743032-1653732359167.png" alt="1653325743032" loading="lazy"></p>
<h3 id="3-2，消息设置-TTL"><a href="#3-2，消息设置-TTL" class="headerlink" title="3.2，消息设置 TTL"></a>3.2，消息设置 TTL</h3><p> 另一种方式便是针对每条消息设置 TTL </p>
<p><img src="/2022/05/28/RabbitMQ/1648127354388-1653732359167.png" alt="1648127354388" loading="lazy"></p>
<h3 id="3-3，两者的区别"><a href="#3-3，两者的区别" class="headerlink" title="3.3，两者的区别"></a>3.3，两者的区别</h3><p>如果设置了<strong>队列的 TTL 属性，那么一旦消息过期，就会被队列丢弃(如果配置了死信队列被丢到死信队列中)<strong>，而</strong>第二种方式，消息即使过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者之前判定的</strong>，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间；另外，还需 要注意的一点是，如果不设置 TTL，表示消息永远不会过期，如果将 TTL 设置为 0，则表示除非此时可以直接投递该消息到消费者，否则该消息将会被丢弃。 </p>
<p>延时队列，不就是想要消息延迟多久被处理吗，TTL 则刚好能让消息在延迟多久之后成为死信，另一方面， 成为死信的消息都会被投递到死信队列里，这样只需要消费者一直消费死信队列里的消息就完事了，因为里面的消息都是希望被立即处理的消息 。</p>
<h2 id="4，整合-springboot"><a href="#4，整合-springboot" class="headerlink" title="4，整合 springboot"></a>4，整合 springboot</h2><h3 id="4-1，创建项目"><a href="#4-1，创建项目" class="headerlink" title="4.1，创建项目"></a>4.1，创建项目</h3><p><img src="/2022/05/28/RabbitMQ/1648214656169-1653732359167.png" alt="1648214656169" loading="lazy"></p>
<h3 id="4-2，添加依赖"><a href="#4-2，添加依赖" class="headerlink" title="4.2，添加依赖"></a>4.2，添加依赖</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!--RabbitMQ 依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.2</span><span class="number">.47</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--swagger--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">2.9</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">2.9</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--RabbitMQ 测试依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.amqp&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-rabbit-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-3，修改配置文件"><a href="#4-3，修改配置文件" class="headerlink" title="4.3，修改配置文件"></a>4.3，修改配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">47.98.198.119</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">spring.mvc.pathmatch.matching-strategy</span>=<span class="string">ant_path_matcher</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-4，添加-Swagger-配置类"><a href="#4-4，添加-Swagger-配置类" class="headerlink" title="4.4，添加 Swagger 配置类"></a>4.4，添加 Swagger 配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: SwaggerConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 测试类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 21:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">webApiConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .groupName(<span class="string">&quot;webApi&quot;</span>)</span><br><span class="line">                .apiInfo(webApiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">webApiInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;rabbitmq 接口文档&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;本文档描述了 rabbitmq 微服务接口定义&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;ming&quot;</span>, <span class="string">&quot;www.cainiaoming.vip&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;1346858620@qq.com&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5，队列-TTL"><a href="#5，队列-TTL" class="headerlink" title="5，队列 TTL"></a>5，队列 TTL</h2><h3 id="5-1，代码架构图"><a href="#5-1，代码架构图" class="headerlink" title="5.1，代码架构图"></a>5.1，代码架构图</h3><p><img src="/2022/05/28/RabbitMQ/1648214846116-1653732359167.png" alt="1648214846116" loading="lazy"></p>
<h3 id="5-2，配置文件类代码"><a href="#5-2，配置文件类代码" class="headerlink" title="5.2，配置文件类代码"></a>5.2，配置文件类代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: TtlQueueConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: TTL队列的配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 21:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TtlQueueConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通交换机，俩普通队列，一个死信交换机，一个死信队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">X_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;X&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_A</span> <span class="operator">=</span> <span class="string">&quot;QA&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_B</span> <span class="operator">=</span> <span class="string">&quot;QB&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Y_DEAD_LETTER_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_LETTER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;QD&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_C</span> <span class="operator">=</span> <span class="string">&quot;QC&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明 xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回一个直接交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;xExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">xExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(X_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明 xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 直接交换机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;yExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">yExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 A ttl 为 10s 并绑定到对应的死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueA</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">//声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">//声明队列的 TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_A).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 A 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueA</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueABindingX</span><span class="params">(</span></span><br><span class="line"><span class="params">           <span class="meta">@Qualifier(&quot;queueA&quot;)</span> Queue queueA,</span></span><br><span class="line"><span class="params">           <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange</span></span><br><span class="line"><span class="params">    )</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueA).to(xExchange).with(<span class="string">&quot;XA&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 B ttl 为 40s 并绑定到对应的死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 队列B</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">//声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">//声明队列的 TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">40000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_B).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 B 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue1B</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queuebBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueB&quot;)</span> Queue queue1B,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1B).to(xExchange).with(<span class="string">&quot;XB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信队列 QD</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 死信队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueD</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_LETTER_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明死信队列 QD 绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueD</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> yExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deadLetterBindingQAD</span><span class="params">(<span class="meta">@Qualifier(&quot;queueD&quot;)</span> Queue queueD,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@Qualifier(&quot;yExchange&quot;)</span> DirectExchange yExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueD).to(yExchange).with(<span class="string">&quot;YD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 C 死信交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueC&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueC</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, Y_DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">//声明当前队列的死信路由 key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;YD&quot;</span>);</span><br><span class="line">        <span class="comment">//没有声明 TTL 属性</span></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_C).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明队列 c 绑定 X 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueC</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueCBindingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueC&quot;)</span> Queue queueC,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;xExchange&quot;)</span> DirectExchange xExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueC).to(xExchange).with(<span class="string">&quot;XC&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>总结一下：</strong></p>
<ul>
<li>配置文件中声明了所有的队列和交换机，及其绑定的关系。</li>
<li>声明的交换机，队列及其绑定关系都需要将其注入到容器中。</li>
</ul>
<h3 id="5-3，消息生产者代码"><a href="#5-3，消息生产者代码" class="headerlink" title="5.3，消息生产者代码"></a>5.3，消息生产者代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: SendMsgController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 发送延时消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 21:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/tt1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMsgController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMsg/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;,发送一条信息给两个 TTL 队列:&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XA&quot;</span>, <span class="string">&quot;消息来自 ttl 为 10S 的队列: &quot;</span>+message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XB&quot;</span>, <span class="string">&quot;消息来自 ttl 为 40S 的队列: &quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendExpirationMsg/&#123;message&#125;/&#123;ttlTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> String ttlTime)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XC&quot;</span>, message, correlationData -&gt;&#123;</span><br><span class="line">            correlationData.getMessageProperties().setExpiration(ttlTime);</span><br><span class="line">            <span class="keyword">return</span> correlationData;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;,发送一条时长&#123;&#125;毫秒 TTL 信息给队列 C:&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(),ttlTime, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendDelayMsg/&#123;message&#125;/&#123;delayTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> Integer delayTime)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message,</span><br><span class="line">                correlationData -&gt;&#123;</span><br><span class="line">                    correlationData.getMessageProperties().setDelay(delayTime);</span><br><span class="line">                    <span class="keyword">return</span> correlationData;</span><br><span class="line">                &#125;);</span><br><span class="line">        log.info(<span class="string">&quot; 当 前 时 间 ： &#123;&#125;, 发送一条延迟 &#123;&#125; 毫秒的信息给队列 delayed.queue:&#123;&#125;&quot;</span>, <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">Date</span>(),delayTime, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意，这里发送消息使用的是官方提供的RabbitMQ的模板。</p>
<h3 id="5-4，消息消费者代码"><a href="#5-4，消息消费者代码" class="headerlink" title="5.4，消息消费者代码"></a>5.4，消息消费者代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: DeadLetterQueueConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 消费者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 21:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;QD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveD</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;,收到死信队列信息&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = DELAYED_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDelayedQueue</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;当前时间：&#123;&#125;,收到延时队列的消息：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong></p>
<p>这里的消费者是用Rabbit的监听器去监听队列，这样子队列发送的消息我们就可以及时收到。</p>
<p><img src="/2022/05/28/RabbitMQ/1648215262083-1653732359167.png" alt="1648215262083" loading="lazy"></p>
<h2 id="6，延时队列优化"><a href="#6，延时队列优化" class="headerlink" title="6，延时队列优化"></a>6，延时队列优化</h2><h3 id="6-1，代码架构图"><a href="#6-1，代码架构图" class="headerlink" title="6.1，代码架构图"></a>6.1，代码架构图</h3><p>在这里新增了一个队列 QC,绑定关系如下,该队列不设置 TTL 时间 </p>
<p><img src="/2022/05/28/RabbitMQ/1648215329397-1653732359167.png" alt="1648215329397" loading="lazy"></p>
<h3 id="6-2，配置文件类代码"><a href="#6-2，配置文件类代码" class="headerlink" title="6.2，配置文件类代码"></a>6.2，配置文件类代码</h3><p><img src="/2022/05/28/RabbitMQ/1648215402938-1653732359167.png" alt="1648215402938" loading="lazy"></p>
<h3 id="6-3，消息生产者代码"><a href="#6-3，消息生产者代码" class="headerlink" title="6.3，消息生产者代码"></a>6.3，消息生产者代码</h3><p><img src="/2022/05/28/RabbitMQ/1648215554012-1653732359167.png" alt="1648215554012" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1648215564473-1653732359167.png" alt="1648215564473" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1648215570954-1653732359167.png" alt="1648215570954" loading="lazy"></p>
<h2 id="7，Rabbitmq-插件实现延迟队列"><a href="#7，Rabbitmq-插件实现延迟队列" class="headerlink" title="7，Rabbitmq 插件实现延迟队列"></a>7，Rabbitmq 插件实现延迟队列</h2><p>上文中提到的问题，确实是一个问题，如果不能实现在消息粒度上的 TTL，并使其在设置的 TTL 时间 及时死亡，就无法设计成一个通用的延时队列。那如何解决呢，接下来我们就去解决该问题。 </p>
<h3 id="7-1，安装延时队列插件"><a href="#7-1，安装延时队列插件" class="headerlink" title="7.1，安装延时队列插件"></a>7.1，安装延时队列插件</h3><p>在官网上下载 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html%EF%BC%8C%E4%B8%8B%E8%BD%BD">https://www.rabbitmq.com/community-plugins.html，下载</a> <strong>rabbitmq_delayed_message_exchange</strong> 插件，然后解压放置到 RabbitMQ 的插件目录。 进入 RabbitMQ 的安装目录下的 plgins 目录，执行下面命令让该插件生效，然后重启 RabbitMQ </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8/plugins rabbitmq-plugins enable rabbitmq_delayed_message_exchange  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1648215706522-1653732359167.png" alt="1648215706522" loading="lazy"></p>
<p><img src="/2022/05/28/RabbitMQ/1648215712006-1653732359167.png" alt="1648215712006" loading="lazy"></p>
<h3 id="7-2，代码架构图"><a href="#7-2，代码架构图" class="headerlink" title="7.2，代码架构图"></a>7.2，代码架构图</h3><p><img src="/2022/05/28/RabbitMQ/1648215737318-1653732359167.png" alt="1648215737318" loading="lazy"></p>
<h3 id="7-3，配置文件类代码"><a href="#7-3，配置文件类代码" class="headerlink" title="7.3，配置文件类代码"></a>7.3，配置文件类代码</h3><p>在我们自定义的交换机中，这是一种新的交换类型，该类型消息支持延迟投递机制消息传递后并不会立即投递到目标队列中，而是存储在 mnesia(一个分布式数据系统)表中，当达到投递时间时，才投递到目标队列中。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: DelayedQueueConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 延时交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/24 22:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedQueueConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DELAYED_QUEUE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义交换机 我们在这里定义的是一个延迟交换机</span></span><br><span class="line"><span class="comment">     * 1,交换机的名称</span></span><br><span class="line"><span class="comment">     * 2，交换机的类型</span></span><br><span class="line"><span class="comment">     * 3，是否持久化</span></span><br><span class="line"><span class="comment">     * 4，是否自动删除</span></span><br><span class="line"><span class="comment">     * 5，其他消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayedExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//自定义交换机的类型，这个延时交换机可以看作一个我们最开始学的无名交换机，只是我们有了延时功能，如果要用别的交换机，必须指明类型</span></span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAYED_EXCHANGE_NAME, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>,</span><br><span class="line">                args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDelayedQueue</span><span class="params">(<span class="meta">@Qualifier(&quot;delayedQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@Qualifier(&quot;delayedExchange&quot;)</span> CustomExchange</span></span><br><span class="line"><span class="params">                                               delayedExchange)</span> &#123;</span><br><span class="line">        <span class="comment">//noargs 通用参数的配置</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">                BindingBuilder.bind(queue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-4，消息生产者代码"><a href="#7-4，消息生产者代码" class="headerlink" title="7.4，消息生产者代码"></a>7.4，消息生产者代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;sendDelayMsg/&#123;message&#125;/&#123;delayTime&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> Integer delayTime)</span> &#123;</span><br><span class="line">       rabbitTemplate.convertAndSend(DELAYED_EXCHANGE_NAME, DELAYED_ROUTING_KEY, message,</span><br><span class="line">               correlationData -&gt;&#123;</span><br><span class="line">                   correlationData.getMessageProperties().setDelay(delayTime);</span><br><span class="line">                   <span class="keyword">return</span> correlationData;</span><br><span class="line">               &#125;);</span><br><span class="line">       log.info(<span class="string">&quot; 当 前 时 间 ： &#123;&#125;, 发送一条延迟 &#123;&#125; 毫秒的信息给队列 delayed.queue:&#123;&#125;&quot;</span>, <span class="keyword">new</span></span><br><span class="line">               <span class="title class_">Date</span>(),delayTime, message);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-5，消息消费者代码"><a href="#7-5，消息消费者代码" class="headerlink" title="7.5，消息消费者代码"></a>7.5，消息消费者代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line"><span class="meta">@RabbitListener(queues = DELAYED_QUEUE_NAME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveDelayedQueue</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">    log.info(<span class="string">&quot;当前时间：&#123;&#125;,收到延时队列的消息：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>().toString(), msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1648215961834-1653732359167.png" alt="1648215961834" loading="lazy"></p>
<h2 id="8，总结"><a href="#8，总结" class="headerlink" title="8，总结"></a>8，总结</h2><p><img src="/2022/05/28/RabbitMQ/1648216001247-1653732359167.png" alt="1648216001247" loading="lazy"></p>
<h1 id="八，发布确认高级"><a href="#八，发布确认高级" class="headerlink" title="八，发布确认高级"></a>八，发布确认高级</h1><p>在生产环境中由于一些不明原因，导致 rabbitmq 重启，在 RabbitMQ 重启期间生产者消息投递失败， 导致消息丢失，需要手动处理和恢复。于是，我们开始思考，如何才能进行 RabbitMQ 的消息可靠投递呢？ 特别是在这样比较极端的情况，RabbitMQ 集群不可用的时候，无法投递的消息该如何处理呢: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">应 用 [xxx] 在 [08-1516:36:04] 发 生 [ 错误日志异常 ] ， alertId=[xxx] 。 由</span><br><span class="line">[org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620] 触发。 </span><br><span class="line">应用 xxx 可能原因如下</span><br><span class="line">服务名为： </span><br><span class="line">异常为： org.springframework.amqp.rabbit.listener.BlockingQueueConsumer:start:620, </span><br><span class="line">产 生 原 因 如 下 :1.org.springframework.amqp.rabbit.listener.QueuesNotAvailableException: </span><br><span class="line">Cannot prepare queue for listener. Either the queue doesn&#x27;t exist or the broker will not </span><br><span class="line">allow us to use it.||Consumer received fatal=false exception on startup:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="1，-发布确认-springboot-版本"><a href="#1，-发布确认-springboot-版本" class="headerlink" title="1， 发布确认 springboot 版本"></a>1， 发布确认 springboot 版本</h2><h3 id="1-1，-确认机制方案"><a href="#1-1，-确认机制方案" class="headerlink" title="1.1， 确认机制方案"></a>1.1， 确认机制方案</h3><p><img src="/2022/05/28/RabbitMQ/1648287789567-1653732359167.png" alt="1648287789567" loading="lazy"> </p>
<h3 id="1-2，-代码架构图"><a href="#1-2，-代码架构图" class="headerlink" title="1.2， 代码架构图"></a>1.2， 代码架构图</h3><p><img src="/2022/05/28/RabbitMQ/1648287817234-1653732359167.png" alt="1648287817234" loading="lazy"></p>
<h3 id="1-3，-配置文件"><a href="#1-3，-配置文件" class="headerlink" title="1.3， 配置文件"></a>1.3， 配置文件</h3><p> 在配置文件当中需要添加 </p>
<p><code>spring.rabbitmq.publisher-confirm-type=correlated</code></p>
<ul>
<li>NONE  <ul>
<li>禁用发布确认模式，是默认值  </li>
</ul>
</li>
<li>CORRELATED  <ul>
<li>发布消息成功到交换器后会触发回调方法 </li>
</ul>
</li>
<li>SIMPLE   经测试有两种效果<ul>
<li>其一效果和 CORRELATED 值一样会触发回调方法，</li>
<li>其二在发布消息成功后使用 rabbitTemplate 调用 waitForConfirms 或 waitForConfirmsOrDie 方法 等待 broker 节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是 waitForConfirmsOrDie 方法如果返回 false 则会关闭 channel，则接下来无法发送消息到 broker </li>
</ul>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">47.98.198.119</span></span><br><span class="line"><span class="attr">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">spring.rabbitmq.username</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">spring.rabbitmq.password</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">spring.mvc.pathmatch.matching-strategy</span>=<span class="string">ant_path_matcher</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-confirm-type</span>=<span class="string">correlated</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-4，-添加配置类"><a href="#1-4，-添加配置类" class="headerlink" title="1.4， 添加配置类"></a>1.4， 添加配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ConfirmConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 发布确认 （高级）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="comment">//声明业务 Exchange</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(CONFIRM_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明确认队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明确认队列绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-5，-消息生产者"><a href="#1-5，-消息生产者" class="headerlink" title="1.5， 消息生产者"></a>1.5， 消息生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zhao.config.MyCallBack;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyCallBack myCallBack;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;sendMessage/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line">        <span class="comment">//指定消息 id 为 1</span></span><br><span class="line">        CorrelationData correlationData1=<span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        String routingKey=<span class="string">&quot;key1&quot;</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME,routingKey,message+routingKey,correlationData1);</span><br><span class="line">        CorrelationData correlationData2=<span class="keyword">new</span> <span class="title class_">CorrelationData</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        routingKey=<span class="string">&quot;key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME,routingKey,message+routingKey,correlationData2);</span><br><span class="line">        log.info(<span class="string">&quot;发送消息内容:&#123;&#125;&quot;</span>,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-6，回调类"><a href="#1-6，回调类" class="headerlink" title="1.6，回调类"></a>1.6，回调类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: MyCallBack</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 回调</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将这个类注入到模板中</span></span><br><span class="line"><span class="comment">     * 依赖注入 rabbitTemplate 之后再设置它的回调对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * j交换机确认回调方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData 保存回调消息的ID及其相关信息   但是这个值如果不显示申请，其实是不存在，必须要在生产者申请</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack 交换机是否收到消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause 原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : correlationData.getId();</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机已经收到 id 为:&#123;&#125;的消息&quot;</span>,id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机还未收到 id 为:&#123;&#125;消息,由于原因:&#123;&#125;&quot;</span>,id,cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-7，-消息消费者"><a href="#1-7，-消息消费者" class="headerlink" title="1.7， 消息消费者"></a>1.7， 消息消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ConfirmConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 发布确认（高级）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="meta">@RabbitListener(queues =CONFIRM_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveMsg</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        String msg=<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;接受到队列 confirm.queue 消息:&#123;&#125;&quot;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-8，-结果分析"><a href="#1-8，-结果分析" class="headerlink" title="1.8， 结果分析"></a>1.8， 结果分析</h3><p><img src="/2022/05/28/RabbitMQ/1648288138031-1653732359167.png" alt="1648288138031" loading="lazy"></p>
<h2 id="2，-回退消息"><a href="#2，-回退消息" class="headerlink" title="2， 回退消息"></a>2， 回退消息</h2><h3 id="2-1，-Mandatory-参数"><a href="#2-1，-Mandatory-参数" class="headerlink" title="2.1， Mandatory 参数"></a>2.1， Mandatory 参数</h3><p><img src="/2022/05/28/RabbitMQ/1648288860233-1653732359167.png" alt="1648288860233" loading="lazy"></p>
<h3 id="2-2，修改配置文件"><a href="#2-2，修改配置文件" class="headerlink" title="2.2，修改配置文件"></a>2.2，修改配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回退消息</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-returns</span>=<span class="string">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-3，-回调接口"><a href="#2-3，-回调接口" class="headerlink" title="2.3， 回调接口"></a>2.3， 回调接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: MyCallBack</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 回调</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallBack</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback,RabbitTemplate.ReturnsCallback &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将这个类注入到模板中</span></span><br><span class="line"><span class="comment">     * 依赖注入 rabbitTemplate 之后再设置它的回调对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * j交换机确认回调方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData 保存回调消息的ID及其相关信息   但是这个值如果不显示申请，其实是不存在，必须要在生产者申请</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack 交换机是否收到消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause 原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> correlationData == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : correlationData.getId();</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机已经收到 id 为:&#123;&#125;的消息&quot;</span>,id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;交换机还未收到 id 为:&#123;&#125;消息,由于原因:&#123;&#125;&quot;</span>,id,cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机不管是否收到消息的一个回调方法，当消息传递过程中不可达目的地时将消息返回生产者</span></span><br><span class="line"><span class="comment">     * CorrelationData</span></span><br><span class="line"><span class="comment">     * 消息相关数据</span></span><br><span class="line"><span class="comment">     * ack</span></span><br><span class="line"><span class="comment">     * 交换机是否收到消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot; 消 息 &#123;&#125;, 被交换机 &#123;&#125; 退回，退回原因 :&#123;&#125;, 路 由 key:&#123;&#125;&quot;</span>,<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">String</span>(returned.getMessage().getBody()),returned.getExchange(),returned.getReplyText(),returned.getRoutingKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>记得注入模板。</p>
<h3 id="2-4，-结果分析"><a href="#2-4，-结果分析" class="headerlink" title="2.4， 结果分析"></a>2.4， 结果分析</h3><p><img src="/2022/05/28/RabbitMQ/1648289020619-1653732359167.png" alt="1648289020619" loading="lazy"></p>
<h2 id="3，-备份交换机"><a href="#3，-备份交换机" class="headerlink" title="3， 备份交换机"></a>3， 备份交换机</h2><p>有了 mandatory 参数和回退消息，我们获得了对无法投递消息的感知能力，有机会在生产者的消息无法被投递时发现并处理。但有时候，我们并不知道该如何处理这些无法路由的消息，最多打个日志，然 后触发报警，再来手动处理。而通过日志来处理这些无法路由的消息是很不优雅的做法，特别是当生产者 所在的服务有多台机器的时候，手动复制日志会更加麻烦而且容易出错。而且设置 mandatory 参数会增加生产者的复杂性，需要添加处理这些被退回的消息的逻辑。如果既不想丢失消息，又不想增加生产者的复杂性，该怎么做呢？前面在设置死信队列的文章中，我们提到，可以为队列设置死信交换机来存储那些处理失败的消息，可是这些不可路由消息根本没有机会进入到队列，因此无法使用死信队列来保存消息。 在 RabbitMQ 中，有一种备份交换机的机制存在，可以很好的应对这个问题。什么是备份交换机呢？<strong>备份交换机可以理解为 RabbitMQ 中交换机的“备胎”，当我们为某一个交换机声明一个对应的备份交换机时， 就是为它创建一个备胎，当交换机接收到一条不可路由消息时，将会把这条消息转发到备份交换机中，由 备份交换机来进行转发和处理，通常备份交换机的类型为 Fanout ，这样就能把所有消息都投递到与其绑 定的队列中，然后我们在备份交换机下绑定一个队列，这样所有那些原交换机无法被路由的消息，就会都 进入这个队列了。当然，我们还可以建立一个报警队列，用独立的消费者来进行监测和报警。</strong>  </p>
<h3 id="3-1，-代码架构图"><a href="#3-1，-代码架构图" class="headerlink" title="3.1， 代码架构图"></a>3.1， 代码架构图</h3><p><img src="/2022/05/28/RabbitMQ/1648289983864-1653732359167.png" alt="1648289983864" loading="lazy"></p>
<h3 id="3-2，-修改配置类"><a href="#3-2，-修改配置类" class="headerlink" title="3.2， 修改配置类"></a>3.2， 修改配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: ConfirmConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 发布确认 （高级）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 17:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIRM_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BACKUP_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;backup.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line">    <span class="comment">// 声明确认队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">confirmQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(CONFIRM_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//声明确认队列绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;confirmQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                <span class="meta">@Qualifier(&quot;confirmExchange&quot;)</span> DirectExchange exchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//声明备份 Exchange</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backupExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">backupExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(BACKUP_EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//声明确认 Exchange 交换机的备份交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;confirmExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">confirmExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ExchangeBuilder</span> <span class="variable">exchangeBuilder</span> <span class="operator">=</span> ExchangeBuilder.directExchange(CONFIRM_EXCHANGE_NAME)</span><br><span class="line">                        .durable(<span class="literal">true</span>)</span><br><span class="line">                        <span class="comment">//设置该交换机的备份交换机</span></span><br><span class="line">                        .withArgument(<span class="string">&quot;alternate-exchange&quot;</span>, BACKUP_EXCHANGE_NAME);</span><br><span class="line">        <span class="keyword">return</span> (DirectExchange)exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明警告队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;warningQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">warningQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(WARNING_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明报警队列绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">warningBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;warningQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange backupExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明备份队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">backQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BACKUP_QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 声明备份队列绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">backupBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;backQueue&quot;)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange backupExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(backupExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要在声明确认交换机时进行绑定备份交换机的过程</p>
<p><img src="/2022/05/28/RabbitMQ/1648290114496-1653732359167.png" alt="1648290114496" loading="lazy"></p>
<h3 id="3-3，-报警消费者"><a href="#3-3，-报警消费者" class="headerlink" title="3.3， 报警消费者"></a>3.3， 报警消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhao.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot_rabbit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: WarningConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 请描述该类的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 18:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WarningConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WARNING_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;warning.queue&quot;</span>;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = WARNING_QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveWarningMsg</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        log.error(<span class="string">&quot;报警发现不可路由消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-4，-测试注意事项"><a href="#3-4，-测试注意事项" class="headerlink" title="3.4， 测试注意事项"></a>3.4， 测试注意事项</h3><p><img src="/2022/05/28/RabbitMQ/1648290191588-1653732359167.png" alt="1648290191588" loading="lazy"></p>
<h3 id="3-5，-结果分析"><a href="#3-5，-结果分析" class="headerlink" title="3.5， 结果分析"></a>3.5， 结果分析</h3><p><img src="/2022/05/28/RabbitMQ/1648290213610-1653732359167.png" alt="1648290213610" loading="lazy"></p>
<h1 id="九，-RabbitMQ-其他知识点"><a href="#九，-RabbitMQ-其他知识点" class="headerlink" title="九， RabbitMQ 其他知识点"></a>九， RabbitMQ 其他知识点</h1><h2 id="1，-幂等性"><a href="#1，-幂等性" class="headerlink" title="1， 幂等性"></a>1， 幂等性</h2><h3 id="1-1，-概念"><a href="#1-1，-概念" class="headerlink" title="1.1， 概念"></a>1.1， 概念</h3><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。 举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常， 此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱 了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等 。</p>
<h3 id="1-2，-消息重复消费"><a href="#1-2，-消息重复消费" class="headerlink" title="1.2， 消息重复消费"></a>1.2， 消息重复消费</h3><p>消费者在消费 MQ 中的消息时，MQ 已把消息发送给消费者，消费者在给 MQ 返回 ack 时网络中断，故 MQ 未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。 </p>
<h3 id="1-3，解决思路"><a href="#1-3，解决思路" class="headerlink" title="1.3，解决思路"></a>1.3，解决思路</h3><p>MQ 消费者的幂等性的解决一般使用全局 ID 或者写个唯一标识比如时间戳或者 UUID 或者订单消费者消费 MQ 中的消息也可利用 MQ 的该 id 来判断，或者可按自己的规则生成一个全局唯一 id，每次消费消息时用该 id 先判断该消息是否已消费过。 </p>
<h3 id="1-4，消费端的幂等性保障"><a href="#1-4，消费端的幂等性保障" class="headerlink" title="1.4，消费端的幂等性保障"></a>1.4，消费端的幂等性保障</h3><p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性，这就意味着我们的消息永远不会被消费多次，即使我们收到了一样的消息。业界主流的幂等性有两种操作:a.唯一 ID+指纹码机制,利用数据库主键去重, b.利用 redis 的原子性去实现 </p>
<h3 id="1-5，唯一-ID-指纹码机制"><a href="#1-5，唯一-ID-指纹码机制" class="headerlink" title="1.5，唯一 ID+指纹码机制"></a>1.5，唯一 ID+指纹码机制</h3><p>指纹码:我们的一些规则或者时间戳加别的服务给到的唯一信息码,它并不一定是我们系统生成的，基本都是由我们的业务规则拼接而来，但是一定要保证唯一性，然后就利用查询语句进行判断这个 id 是否存在数据库中,优势就是实现简单就一个拼接，然后查询判断是否重复；劣势就是在高并发时，如果是单个数据库就会有写入性能瓶颈当然也可以采用分库分表提升性能，但也不是我们最推荐的方式。 </p>
<h3 id="1-6，Redis-原子性"><a href="#1-6，Redis-原子性" class="headerlink" title="1.6，Redis 原子性"></a>1.6，Redis 原子性</h3><p>利用 redis 执行 setnx 命令，天然具有幂等性。从而实现不重复消费 。</p>
<p><code>setnx</code>是指如果这条数据不存在就可以存入，如果存在就啥也不做。</p>
<h2 id="2，-优先级队列"><a href="#2，-优先级队列" class="headerlink" title="2， 优先级队列"></a>2， 优先级队列</h2><h3 id="2-1，-使用场景"><a href="#2-1，-使用场景" class="headerlink" title="2.1， 使用场景"></a>2.1， 使用场景</h3><p>在我们系统中有一个订单催付的场景，我们的客户在天猫下的订单,淘宝会及时将订单推送给我们，如果在用户设定的时间内未付款那么就会给用户推送一条短信提醒，很简单的一个功能对吧，但是，tmall商家对我们来说，肯定是要分大客户和小客户的对吧，比如像苹果，小米这样大商家一年起码能给我们创造很大的利润，所以理应当然，他们的订单必须得到优先处理，而曾经我们的后端系统是使用 redis 来存放的定时轮询，大家都知道 redis 只能用 List 做一个简简单单的消息队列，并不能实现一个优先级的场景， 所以订单量大了后采用 RabbitMQ 进行改造和优化,如果发现是大客户的订单给一个相对比较高的优先级，否则就是默认优先级 。</p>
<h3 id="2-2，-如何添加"><a href="#2-2，-如何添加" class="headerlink" title="2.2， 如何添加"></a>2.2， 如何添加</h3><p><strong>a.控制台页面添加</strong> </p>
<p><img src="/2022/05/28/RabbitMQ/1653360742919-1653732359167.png" alt="1653360742919" loading="lazy"></p>
<p><strong>b.队列中代码添加优先级</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1653360794276-1653732359167.png" alt="1653360794276" loading="lazy"></p>
<p><strong>c.消息中代码添加优先级</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>d.注意事项</strong> </p>
<p>要让队列实现优先级需要做的事情有如下事情:队列需要设置为优先级队列，消息需要设置消息的优先级，消费者需要等待消息已经发送到队列中才去消费因为，这样才有机会对消息进行排序。 </p>
<h3 id="2-3，-实战"><a href="#2-3，-实战" class="headerlink" title="2.3， 实战"></a>2.3， 实战</h3><p><strong>a.消息生产者</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();) &#123;</span><br><span class="line">            <span class="comment">//给消息赋予一个 priority属性</span></span><br><span class="line">            AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">AMQP</span>.BasicProperties().builder().priority(<span class="number">5</span>).build();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;info&quot;</span>+i;</span><br><span class="line">                <span class="keyword">if</span>(i==<span class="number">5</span>)&#123;</span><br><span class="line">                	channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, properties, message.getBytes());</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                	channel.basicPublish(<span class="string">&quot;&quot;</span>, QUEUE_NAME, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息完成:&quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>b.消息消费者</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 优先级队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: ming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2022/3/26 20:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMqUtils.getChannel();</span><br><span class="line">        <span class="comment">//设置队列的最大优先级 最大可以设置到 255 官网推荐 1-10 如果设置太高比较吃内存和 CPU</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        params.put(<span class="string">&quot;x-max-priority&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, params);</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者启动等待消费......&quot;</span>);</span><br><span class="line">        DeliverCallback deliverCallback=(consumerTag, delivery)-&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">receivedMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody());</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到消息:&quot;</span>+receivedMessage);</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,deliverCallback,(consumerTag)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3，-惰性队列"><a href="#3，-惰性队列" class="headerlink" title="3， 惰性队列"></a>3， 惰性队列</h2><h3 id="3-1，-使用场景"><a href="#3-1，-使用场景" class="headerlink" title="3.1， 使用场景"></a>3.1， 使用场景</h3><p>RabbitMQ 从 3.6.0 版本开始引入了惰性队列的概念。惰性队列会尽可能的将消息存入磁盘中，而在消费者消费到相应的消息时才会被加载到内存中，它的一个<strong>重要的设计目标是能够支持更长的队列，即支持更多的消息存储</strong>。当消费者由于各种各样的原因(比如消费者下线、宕机亦或者是由于维护而关闭等)而致使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。 </p>
<p>默认情况下，当生产者将消息发送到 RabbitMQ 的时候，队列中的消息会尽可能的存储在内存之中，这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留一份备份。当 RabbitMQ 需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的时间，也会阻塞队列的操作，进而无法接收新的消息。虽然 RabbitMQ 的开发者们一直在升级相关的算法，但是效果始终不太理想，尤其是在消息量特别大的时候。 </p>
<h3 id="3-2，-两种模式"><a href="#3-2，-两种模式" class="headerlink" title="3.2， 两种模式"></a>3.2， 两种模式</h3><p>队列具备两种模式：<code>default</code>和<code>lazy</code>。默认的为 default 模式，在 3.6.0 之前的版本无需做任何变更。lazy模式即为惰性队列的模式，可以通过调用<code>channel.queueDeclare</code>方法的时候在参数中设置，也可以通过Policy 的方式设置，如果一个队列同时使用这两种方式设置的话，那么 Policy 的方式具备更高的优先级。如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的。 </p>
<p>在队列声明的时候可以通过“x-queue-mode”参数来设置队列的模式，取值为“default”和“lazy”。下面示例中演示了一个惰性队列的声明细节： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-queue-mode&quot;</span>, <span class="string">&quot;lazy&quot;</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;myqueue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-3，-内存开销对比"><a href="#3-3，-内存开销对比" class="headerlink" title="3.3， 内存开销对比"></a>3.3， 内存开销对比</h3><p><img src="/2022/05/28/RabbitMQ/1653361461312-1653732359167.png" alt="1653361461312" loading="lazy"></p>
<h1 id="十，-RabbitMQ-集群"><a href="#十，-RabbitMQ-集群" class="headerlink" title="十， RabbitMQ 集群"></a>十， RabbitMQ 集群</h1><h2 id="1，-clustering"><a href="#1，-clustering" class="headerlink" title="1， clustering"></a>1， clustering</h2><h3 id="1-1，-使用集群的原因"><a href="#1-1，-使用集群的原因" class="headerlink" title="1.1， 使用集群的原因"></a>1.1， 使用集群的原因</h3><p>最开始我们介绍了如何安装及运行 RabbitMQ 服务，不过这些是单机版的，无法满足目前真实应用的要求。如果 RabbitMQ 服务器遇到内存崩溃、机器掉电或者主板故障等情况，该怎么办？单台 RabbitMQ服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢？购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是解决实际问题的关键. </p>
<h3 id="1-2，-搭建步骤"><a href="#1-2，-搭建步骤" class="headerlink" title="1.2， 搭建步骤"></a>1.2， 搭建步骤</h3><p>1.修改 3 台机器的主机名称<br><code>vim /etc/hostname</code><br>2.配置各个节点的 hosts 文件，让各个节点都能互相识别对方</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">10.211.55.74 node1</span><br><span class="line">10.211.55.75 node2</span><br><span class="line">10.211.55.76 node3 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1653361642367-1653732359167.png" alt="1653361642367" loading="lazy"></p>
<p>3.以确保各个节点的 cookie 文件使用的是同一个值 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在 node1 上执行远程操作命令</span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie root@node2:/var/lib/rabbitmq/.erlang.cookie</span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie root@node3:/var/lib/rabbitmq/.erlang.cookie</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.启动 RabbitMQ 服务,顺带启动 Erlang 虚拟机和 RbbitMQ 应用服务(在三台节点上分别执行以下命令) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server -detached</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.在节点 2 执行 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">(rabbitmqctl stop 会将 Erlang 虚拟机关闭，rabbitmqctl stop_app 只关闭 RabbitMQ 服务)</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node1</span><br><span class="line">rabbitmqctl start_app(只启动应用服务)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.在节点 3 执行 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node2</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>7.集群状态 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl cluster_status</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>8.需要重新设置用户 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">创建账号</span><br><span class="line">rabbitmqctl add_user admin 123</span><br><span class="line">设置用户角色</span><br><span class="line">rabbitmqctl set_user_tags admin administrator</span><br><span class="line">设置用户权限</span><br><span class="line">rabbitmqctl set_permissions -p &quot;/&quot; admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>9.解除集群节点(node2 和 node3 机器分别执行) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">rabbitmqctl cluster_status</span><br><span class="line">rabbitmqctl forget_cluster_node rabbit@node2(node1 机器上执行)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2，-镜像队列"><a href="#2，-镜像队列" class="headerlink" title="2， 镜像队列"></a>2， 镜像队列</h2><h3 id="2-1，-使用镜像的原因"><a href="#2-1，-使用镜像的原因" class="headerlink" title="2.1， 使用镜像的原因"></a>2.1， 使用镜像的原因</h3><p>如果 RabbitMQ 集群中只有一个 Broker 节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能会导致消息的丢失。可以将所有消息都设置为持久化，并且对应队列的 durable 属性也设置为 true，但是这样仍然无法避免由于缓存导致的问题：因为消息在发送之后和被写入磁盘井执行刷盘动作之间存在一个短暂却会产生问题的时间窗。通过 publisherconfirm 机制能够确保客户端知道哪些消息己经存入磁盘，尽管如此，一般不希望遇到因单点故障导致的服务不可用。 </p>
<p>引入镜像队列(Mirror Queue)的机制，可以将队列镜像到集群中的其他 Broker 节点之上，如果集群中的一个节点失效了，队列能自动地切换到镜像中的另一个节点上以保证服务的可用性。 </p>
<h3 id="2-2，-搭建步骤"><a href="#2-2，-搭建步骤" class="headerlink" title="2.2， 搭建步骤"></a>2.2， 搭建步骤</h3><p>1.启动三台集群节点 </p>
<p>2.随便找一个节点添加 policy </p>
<p><img src="/2022/05/28/RabbitMQ/1653378248845-1653732359167.png" alt="1653378248845" loading="lazy"></p>
<p>3.在 node1 上创建一个队列发送一条消息，队列存在镜像队列 </p>
<p><img src="/2022/05/28/RabbitMQ/1653378278248-1653732359167.png" alt="1653378278248" loading="lazy"></p>
<p>4.停掉 node1 之后发现 node2 成为镜像队列 </p>
<p><img src="/2022/05/28/RabbitMQ/1653378299318-1653732359167.png" alt="1653378299318" loading="lazy"></p>
<p>5.就算整个集群只剩下一台机器了 依然能消费队列里面的消息， 说明队列里面的消息被镜像队列传递到相应机器里面了 </p>
<h2 id="3，-Haproxy-Keepalive-实现高可用负载均衡"><a href="#3，-Haproxy-Keepalive-实现高可用负载均衡" class="headerlink" title="3， Haproxy+Keepalive 实现高可用负载均衡"></a>3， Haproxy+Keepalive 实现高可用负载均衡</h2><h3 id="3-1，-整体架构图"><a href="#3-1，-整体架构图" class="headerlink" title="3.1， 整体架构图"></a>3.1， 整体架构图</h3><p><img src="/2022/05/28/RabbitMQ/1653378434376-1653732359167.png" alt="1653378434376" loading="lazy"></p>
<h3 id="3-2，-Haproxy-实现负载均衡"><a href="#3-2，-Haproxy-实现负载均衡" class="headerlink" title="3.2， Haproxy 实现负载均衡"></a>3.2， Haproxy 实现负载均衡</h3><p>HAProxy 提供高可用性、负载均衡及基于 TCPHTTP 应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案，包括 Twitter,Reddit,StackOverflow,GitHub 在内的多家知名互联网公司在使用。HAProxy 实现了一种事件驱动、单一进程模型，此模型支持非常大的井发连接数。 </p>
<p>扩展 nginx,lvs,haproxy 之间的区别: <a target="_blank" rel="noopener" href="http://www.ha97.com/5646.html">http://www.ha97.com/5646.html</a> </p>
<h3 id="3-3，搭建步骤"><a href="#3-3，搭建步骤" class="headerlink" title="3.3，搭建步骤"></a>3.3，搭建步骤</h3><p>1.下载 haproxy(在 node1 和 node2) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.修改 node1 和 node2 的 haproxy.cfg </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要修改红色 IP 为当前机器 IP </p>
<p><img src="/2022/05/28/RabbitMQ/1653378689389-1653732359167.png" alt="1653378689389" loading="lazy"></p>
<p>3.在两台节点启动 haproxy </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br><span class="line">ps -ef | grep haproxy</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.访问地址 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://10.211.55.71:8888/stats</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-4，-Keepalived-实现双机-主备-热备"><a href="#3-4，-Keepalived-实现双机-主备-热备" class="headerlink" title="3.4， Keepalived 实现双机(主备)热备"></a>3.4， Keepalived 实现双机(主备)热备</h3><p>试想如果前面配置的 HAProxy 主机突然宕机或者网卡失效，那么虽然 RbbitMQ 集群没有任何故障但是对于外界的客户端来说所有的连接都会被断开结果将是灾难性的为了确保负载均衡服务的可靠性同样显得十分重要，这里就要引入 Keepalived 它能够通过自身健康检查、资源接管功能做高可用(双机热备)，实现故障转移. </p>
<h3 id="3-5，-搭建步骤"><a href="#3-5，-搭建步骤" class="headerlink" title="3.5， 搭建步骤"></a>3.5， 搭建步骤</h3><p>1.下载 keepalived </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.节点 node1 配置文件 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">把资料里面的 keepalived.conf 修改之后替换</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.节点 node2 配置文件 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">需要修改 global_defs 的 router_id,如:nodeB</span><br><span class="line">其次要修改 vrrp_instance_VI 中 state 为&quot;BACKUP&quot;；</span><br><span class="line">最后要将 priority 设置为小于 100 的值</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.添加 haproxy_chk.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(为了防止 HAProxy 服务挂掉之后 Keepalived 还在正常工作而没有切换到 Backup 上，所以这里需要编写一个脚本来检测 HAProxy 务的状态,当 HAProxy 服务挂掉之后该脚本会自动重启</span><br><span class="line">HAProxy 的服务，如果不成功则关闭 Keepalived 服务，这样便可以切换到 Backup 继续工作)</span><br><span class="line">vim /etc/keepalived/haproxy_chk.sh(可以直接上传文件)</span><br><span class="line">修改权限 chmod 777 /etc/keepalived/haproxy_chk.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.启动 keepalive 命令(node1 和 node2 启动) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.观察 Keepalived 的日志 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/messages -n 200</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>7.观察最新添加的 vip </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip add show</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>8.node1 模拟 keepalived 关闭状态 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop keepalived</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>9.使用 vip 地址来访问 rabbitmq 集群 </p>
<h2 id="4，-Federation-Exchange"><a href="#4，-Federation-Exchange" class="headerlink" title="4， Federation Exchange"></a>4， Federation Exchange</h2><h3 id="4-1，-使用它的原因"><a href="#4-1，-使用它的原因" class="headerlink" title="4.1， 使用它的原因"></a>4.1， 使用它的原因</h3><p>(broker 北京)，(broker 深圳)彼此之间相距甚远，网络延迟是一个不得不面对的问题。有一个在北京的业务(Client 北京) 需要连接(broker 北京)，向其中的交换器 exchangeA 发送消息，此时的网络延迟很小，(Client 北京)可以迅速将消息发送至 exchangeA 中，就算在开启了 publisherconfirm 机制或者事务机制的情况下，也可以迅速收到确认信息。此时又有个在深圳的业务(Client 深圳)需要向 exchangeA 发送消息，那么(Client 深圳) (broker 北京)之间有很大的网络延迟，(Client 深圳) 将发送消息至 exchangeA 会经历一定的延迟，尤其是在开启了 publisherconfirm 机制或者事务机制的情况下，(Client 深圳) 会等待很长的延迟时间来接收(broker 北京)的确认信息，进而必然造成这条发送线程的性能降低，甚至造成一定程度上的阻塞。 </p>
<p>将业务(Client 深圳)部署到北京的机房可以解决这个问题，但是如果(Client 深圳)调用的另些服务都部署在深圳，那么又会引发新的时延问题，总不见得将所有业务全部部署在一个机房，那么容灾又何以实现？这里使用 Federation 插件就可以很好地解决这个问题. </p>
<p><img src="/2022/05/28/RabbitMQ/1653379039184-1653732359167.png" alt="1653379039184" loading="lazy"></p>
<h3 id="4-2，-搭建步骤"><a href="#4-2，-搭建步骤" class="headerlink" title="4.2， 搭建步骤"></a>4.2， 搭建步骤</h3><p>1.需要保证每台节点单独运行 </p>
<p>2.在每台机器上开启 federation 相关插件 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_federation</span><br><span class="line">rabbitmq-plugins enable rabbitmq_federation_management</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1653379083510-1653732359167.png" alt="1653379083510" loading="lazy"></p>
<p>3.原理图(先运行 consumer 在 node2 创建 fed_exchange) </p>
<p><img src="/2022/05/28/RabbitMQ/1653379097309-1653732359167.png" alt="1653379097309" loading="lazy"></p>
<p>4.在 downstream(node2)配置 upstream(node1) </p>
<p><img src="/2022/05/28/RabbitMQ/1653379138898-1653732359168.png" alt="1653379138898" loading="lazy"></p>
<p>5.添加 policy </p>
<p><img src="/2022/05/28/RabbitMQ/1653379157817-1653732359168.png" alt="1653379157817" loading="lazy"></p>
<p>6.成功的前提 </p>
<p><img src="/2022/05/28/RabbitMQ/1653379174578-1653732359168.png" alt="1653379174578" loading="lazy"></p>
<h2 id="5，-Federation-Queue"><a href="#5，-Federation-Queue" class="headerlink" title="5， Federation Queue"></a>5， Federation Queue</h2><h3 id="5-1，-使用它的原因"><a href="#5-1，-使用它的原因" class="headerlink" title="5.1， 使用它的原因"></a>5.1， 使用它的原因</h3><p>联邦队列可以在多个 Broker 节点(或者集群)之间为单个队列提供均衡负载的功能。一个联邦队列可以连接一个或者多个上游队列(upstream queue)，并从这些上游队列中获取消息以满足本地消费者消费消息的需求。 </p>
<h3 id="5-2，-搭建步骤"><a href="#5-2，-搭建步骤" class="headerlink" title="5.2， 搭建步骤"></a>5.2， 搭建步骤</h3><p>1.原理图 </p>
<p><img src="/2022/05/28/RabbitMQ/1653379255179-1653732359168.png" alt="1653379255179" loading="lazy"></p>
<p>2.添加 upstream(同上) </p>
<p>3.添加 policy </p>
<p><img src="/2022/05/28/RabbitMQ/1653379272812-1653732359168.png" alt="1653379272812" loading="lazy"></p>
<h2 id="6，-Shovel"><a href="#6，-Shovel" class="headerlink" title="6， Shovel"></a>6， Shovel</h2><h3 id="6-1，-使用它的原因"><a href="#6-1，-使用它的原因" class="headerlink" title="6.1， 使用它的原因"></a>6.1， 使用它的原因</h3><p>Federation 具备的数据转发功能类似，Shovel 够可靠、持续地从一个 Broker 中的队列(作为源端，即source)拉取数据并转发至另一个 Broker 中的交换器(作为目的端，即 destination)。作为源端的队列和作为目的端的交换器可以同时位于同一个 Broker，也可以位于不同的 Broker 上。Shovel 可以翻译为”铲子”，是一种比较形象的比喻，这个”铲子”可以将消息从一方”铲子”另一方。Shovel 行为就像优秀的客户端应用程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理。 </p>
<h3 id="6-2，-搭建步骤"><a href="#6-2，-搭建步骤" class="headerlink" title="6.2， 搭建步骤"></a>6.2， 搭建步骤</h3><p>1.开启插件(需要的机器都开启) </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_shovel</span><br><span class="line">rabbitmq-plugins enable rabbitmq_shovel_management</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/28/RabbitMQ/1653379339708-1653732359168.png" alt="1653379339708" loading="lazy"></p>
<p>2.原理图(在源头发送的消息直接回进入到目的地队列) </p>
<p><img src="/2022/05/28/RabbitMQ/1653379353824-1653732359168.png" alt="1653379353824" loading="lazy"></p>
<p>3.添加 shovel 源和目的地 </p>
<p><img src="/2022/05/28/RabbitMQ/1653379366451.png" alt="1653379366451" loading="lazy"></p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/images/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechatpay.png"><img loading="lazy" src="/images/wechatpay.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>翔仔</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2022/05/28/RabbitMQ/" title="RabbitMQ">http://example.com/2022/05/28/RabbitMQ/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/05/31/javaIO/" rel="prev" title="javaIO"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">javaIO</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/05/26/Redis-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="next" title="Redis-内存管理"><span class="post-nav-text">Redis-内存管理</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2022 </span><span class="with-love" id="animate" title="云游君的赞助者们"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 翔仔</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.2</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.11</span></div><div class="live-time"><span>本博客已运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2022-04-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>