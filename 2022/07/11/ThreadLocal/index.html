<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="ç¿”ä»”"><meta name="copyright" content="ç¿”ä»”"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>ThreadLocal | ç¿”ä»”çš„åšå®¢</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"ç¿”ä»”çš„å°ç«™","version":"1.8.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="ThreadLocal1.ç®€ä»‹ThreadLocalå«åšçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œæ„æ€æ˜¯ThreadLocalä¸­çš„å˜é‡æ˜¯å±äºå½“å‰çº¿ç¨‹çš„ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯éš”ç¦»çš„ã€‚ ThreadLocalä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª**(private)ThreadLocalMapç±»å‹çš„å‰¯æœ¬æˆå‘˜å˜é‡**ï¼Œæ¯ä¸ªçº¿ç¨‹åªå¯ä»¥è®¿é—®è‡ªå·±çš„å‰¯æœ¬å˜é‡ã€‚åŒæ—¶å¯¹å˜é‡çš„ä¿®æ”¹åªå¯¹è‡ªå·±å¯è§ã€‚ æ³¨æ„ï¼š  æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„çº¿ç¨‹å‰¯æœ¬å˜é‡ï¼Œåªèƒ½ç”±å½“å‰çº¿ç¨‹ä½¿">
<meta property="og:type" content="article">
<meta property="og:title" content="ThreadLocal">
<meta property="og:url" content="http://example.com/2022/07/11/ThreadLocal/index.html">
<meta property="og:site_name" content="ç¿”ä»”çš„åšå®¢">
<meta property="og:description" content="ThreadLocal1.ç®€ä»‹ThreadLocalå«åšçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œæ„æ€æ˜¯ThreadLocalä¸­çš„å˜é‡æ˜¯å±äºå½“å‰çº¿ç¨‹çš„ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯éš”ç¦»çš„ã€‚ ThreadLocalä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª**(private)ThreadLocalMapç±»å‹çš„å‰¯æœ¬æˆå‘˜å˜é‡**ï¼Œæ¯ä¸ªçº¿ç¨‹åªå¯ä»¥è®¿é—®è‡ªå·±çš„å‰¯æœ¬å˜é‡ã€‚åŒæ—¶å¯¹å˜é‡çš„ä¿®æ”¹åªå¯¹è‡ªå·±å¯è§ã€‚ æ³¨æ„ï¼š  æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„çº¿ç¨‹å‰¯æœ¬å˜é‡ï¼Œåªèƒ½ç”±å½“å‰çº¿ç¨‹ä½¿">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/20201217201331591.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/2.84686f10.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/7.2604852b.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/9.f78d7ebb.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/10.706954d1.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/11.c5a61453.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/12.1fd13c9f.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/13.55766305.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/14.28205930.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/view.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/15.e6795086.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/16.480ba6bd.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/17.ce02241d.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/17.ce02241d.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/24.5a96689a.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/26.fdebe91d.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/27.9c78c2a2.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/28.ea7d5196.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/29.5f828b88.png">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/640.jpg">
<meta property="og:image" content="http://example.com/2022/07/11/ThreadLocal/640-1657591204426.jpg">
<meta property="article:published_time" content="2022-07-11T14:23:36.000Z">
<meta property="article:modified_time" content="2022-08-23T16:43:18.670Z">
<meta property="article:author" content="ç¿”ä»”">
<meta property="article:tag" content="ThreadLocal">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/11/ThreadLocal/20201217201331591.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ç¿”ä»”"><img width="96" loading="lazy" src="/images/tx.jpg" alt="ç¿”ä»”"><span class="site-author-status" title="ä¸æƒ³ä¸Šå­¦">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">ç¿”ä»”</a></div><span class="site-name">ç¿”ä»”çš„åšå®¢</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="æˆ‘çš„ä¸»é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">28</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">19</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="æ–‡æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=910426929&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="985391895@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadLocal"><span class="toc-number">1.</span> <span class="toc-text">ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ThreadLocal%E4%B8%8ESynchronized%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">2.ThreadLocalä¸Synchronizedçš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ThreadLocal%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">3.ThreadLocalçš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">4.ThreadLocalæ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">5.æºç è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap-Hash%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">ThreadLocalMap Hashç®—æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadHash%E5%86%B2%E7%AA%81"><span class="toc-number">1.5.2.</span> <span class="toc-text">ThreadHashå†²çª</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal-set-%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.3.</span> <span class="toc-text">ThreadLocal.set()è¯¦è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap%E8%BF%87%E6%9C%9Fkey%E7%9A%84%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.4.</span> <span class="toc-text">ThreadLocalMapè¿‡æœŸkeyçš„æ¢æµ‹å¼æ¸…ç†è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.5.</span> <span class="toc-text">ThreadLocalMapæ‰©å®¹æœºåˆ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap-get"><span class="toc-number">1.5.6.</span> <span class="toc-text">ThreadLocalMap.get()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalMap%E8%BF%87%E6%9C%9Fkey%E7%9A%84%E5%90%AF%E5%8F%91%E5%BC%8F%E6%B8%85%E7%90%86"><span class="toc-number">1.5.7.</span> <span class="toc-text">ThreadLocalMapè¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InheritableThreadLoacl"><span class="toc-number">1.6.</span> <span class="toc-text">InheritableThreadLoacl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLoacl%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">ThreadLoaclå†…å­˜æ³„æ¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">1.7.1.</span> <span class="toc-text">è§£å†³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%AE%BE%E7%BD%AE%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆè¦è®¾ç½®å¼±å¼•ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.3.</span> <span class="toc-text">ThreadLocalå»ºè®®ä½¿ç”¨çš„åœºæ™¯</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2022/07/11/ThreadLocal/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ç¿”ä»”"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ç¿”ä»”çš„åšå®¢"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ThreadLocal</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-11 22:23:36" itemprop="dateCreated datePublished" datetime="2022-07-11T22:23:36+08:00">2022-07-11</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-08-24 00:43:18" itemprop="dateModified" datetime="2022-08-24T00:43:18+08:00">2022-08-24</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">å¤šçº¿ç¨‹</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/ThreadLocal/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">ThreadLocal</span></a></span></div><div class="post-author"><span class="author-name">ç¿”ä»”</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h2><p>ThreadLocalå«åšçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œæ„æ€æ˜¯ThreadLocalä¸­çš„å˜é‡æ˜¯<strong>å±äºå½“å‰çº¿ç¨‹</strong>çš„ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯<strong>éš”ç¦»</strong>çš„ã€‚</p>
<p>ThreadLocalä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ª**(private)ThreadLocalMapç±»å‹çš„å‰¯æœ¬æˆå‘˜å˜é‡**ï¼Œæ¯ä¸ªçº¿ç¨‹åªå¯ä»¥è®¿é—®è‡ªå·±çš„å‰¯æœ¬å˜é‡ã€‚åŒæ—¶å¯¹å˜é‡çš„ä¿®æ”¹åªå¯¹è‡ªå·±å¯è§ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„çº¿ç¨‹å‰¯æœ¬å˜é‡ï¼Œ<strong>åªèƒ½ç”±å½“å‰çº¿ç¨‹ä½¿ç”¨</strong></li>
<li>ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜</li>
</ul>
<p> <img src="/2022/07/11/ThreadLocal/20201217201331591.png" alt="img" loading="lazy"> </p>
<blockquote>
<p>threadloclæ˜¯ä½œä¸ºå½“å‰çº¿ç¨‹ä¸­å±æ€§ThreadLocalMapé›†åˆä¸­çš„æŸä¸€ä¸ªEntryçš„keyå€¼Entryï¼ˆthreadlocl,valueï¼‰ï¼Œè™½ç„¶ä¸åŒçš„çº¿ç¨‹ä¹‹é—´threadlocalè¿™ä¸ªkeyå€¼æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯ä¸åŒçš„çº¿ç¨‹æ‰€æ‹¥æœ‰çš„ThreadLocalMapæ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„çº¿ç¨‹é—´åŒä¸€ä¸ªThreadLocalï¼ˆkeyï¼‰å¯¹åº”å­˜å‚¨çš„å€¼(value)ä¸ä¸€æ ·ï¼Œä»è€Œåˆ°è¾¾äº†çº¿ç¨‹é—´å˜é‡éš”ç¦»çš„ç›®çš„ï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿™ä¸ªvalueå˜é‡åœ°å€æ˜¯ä¸€æ ·çš„ã€‚</p>
</blockquote>
<h2 id="2-ThreadLocalä¸Synchronizedçš„åŒºåˆ«"><a href="#2-ThreadLocalä¸Synchronizedçš„åŒºåˆ«" class="headerlink" title="2.ThreadLocalä¸Synchronizedçš„åŒºåˆ«"></a>2.ThreadLocalä¸Synchronizedçš„åŒºåˆ«</h2><p>ThreadLocal<T>å…¶å®æ˜¯ä¸çº¿ç¨‹ç»‘å®šçš„ä¸€ä¸ªå˜é‡ã€‚ä¸¤è€…éƒ½ç”¨äºè§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜</T></p>
<ol>
<li>Synchronizedç”¨äºçº¿ç¨‹é—´æ•°æ®å…±äº«ï¼ŒThreadLocalåˆ™ç”¨äºçº¿ç¨‹ä¹‹é—´çš„æ•°æ®éš”ç¦»</li>
<li>Synchronizedåˆ©ç”¨é”çš„æœºåˆ¶ï¼Œä½¿å˜é‡åœ¨ä»»ä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ŒThreadLocalä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªå‰¯æœ¬å˜é‡ï¼Œéš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„å…±äº«</li>
</ol>
<h2 id="3-ThreadLocalçš„ä½¿ç”¨"><a href="#3-ThreadLocalçš„ä½¿ç”¨" class="headerlink" title="3.ThreadLocalçš„ä½¿ç”¨"></a>3.ThreadLocalçš„ä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocaDemo</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; localVar = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;String&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="comment">//æ‰“å°å½“å‰çº¿ç¨‹ä¸­æœ¬åœ°å†…å­˜ä¸­æœ¬åœ°å˜é‡çš„å€¼</span></span><br><span class="line">        System.out.println(str + <span class="string">&quot; :&quot;</span> + localVar.get());</span><br><span class="line">        <span class="comment">//æ¸…é™¤æœ¬åœ°å†…å­˜ä¸­çš„æœ¬åœ°å˜é‡,é˜²æ­¢gcåå†…å­˜æ³„æ¼</span></span><br><span class="line">        localVar.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                ThreadLocaDemo.localVar.set(<span class="string">&quot;local_A&quot;</span>);</span><br><span class="line">                print(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                <span class="comment">//æ‰“å°æœ¬åœ°å˜é‡</span></span><br><span class="line">                System.out.println(<span class="string">&quot;after remove : &quot;</span> + localVar.get());</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"> </span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                ThreadLocaDemo.localVar.set(<span class="string">&quot;local_B&quot;</span>);</span><br><span class="line">                print(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;after remove : &quot;</span> + localVar.get());</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»“æœ</span></span><br><span class="line">A :local_A</span><br><span class="line">after remove : <span class="literal">null</span></span><br><span class="line">B :local_B</span><br><span class="line">after remove : <span class="literal">null</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>ThreadLocalå¯¹è±¡å¯ä»¥æä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è·å–äº†è‡ªå·±çº¿ç¨‹å­˜æ”¾çš„å‰¯æœ¬å˜é‡ã€‚</p>
<h2 id="4-ThreadLocalæ•°æ®ç»“æ„"><a href="#4-ThreadLocalæ•°æ®ç»“æ„" class="headerlink" title="4.ThreadLocalæ•°æ®ç»“æ„"></a>4.ThreadLocalæ•°æ®ç»“æ„</h2><p> <img src="/2022/07/11/ThreadLocal/2.84686f10.png" alt="img" loading="lazy"> </p>
<p>ThreadLocalæœ‰ä¸€ä¸ªç±»å‹ä¸ºThreadLocal.ThreadLocalMapçš„å®ä¾‹å˜é‡<strong>threadLocals</strong>ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„ThreadLocalMapã€‚</p>
<p><strong>ThreadLocalMap</strong>æœ‰è‡ªå·±çš„å®ç°ï¼Œå¯ä»¥å°†å®ƒçš„<strong>key</strong>è§†ä¸ºThreadLocalï¼Œ<strong>value</strong>è§†ä¸ºä»£ç ä¸­æ”¾å…¥çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚(å®é™…ä¸Šï¼Œkeyæ˜¯ThreadLocalçš„ä¸€ä¸ªå¼±å¼•ç”¨)</p>
<p>æ¯ä¸ªçº¿ç¨‹å¾€ThreadLocalé‡Œæ”¾å€¼çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯å¾€è‡ªå·±çš„ThreadLocalMapé‡Œæ”¾ï¼Œè¯»ä¹Ÿæ˜¯ä»ThreadLocalMapé‡Œè¯»ï¼Œä»¥ThreadLocalä½œä¸ºå¼•ç”¨ï¼Œåœ¨mapé‡Œæ‰¾å¯¹åº”çš„keyï¼Œä¹Ÿå› æ­¤å®ç°çº¿ç¨‹éš”ç¦»</p>
<p>ThreadLocalMapç±»ä¼¼äºjavaçš„mapï¼ŒåŒºåˆ«åœ¨äºï¼Œæ²¡æœ‰é“¾è¡¨ç»“æ„ã€‚</p>
<p>ThreadLocalMapåº•å±‚ç»“æ„æ˜¯Entryæ•°ç»„ï¼Œå®ƒçš„keyæ˜¯ThreadLocal&lt;?&gt;Kï¼Œç»§æ‰¿è‡ªWeakReferenceï¼Œå¼±å¼•ç”¨ç±»å‹ã€‚</p>
<h2 id="5-æºç è§£æ"><a href="#5-æºç è§£æ" class="headerlink" title="5.æºç è§£æ"></a>5.æºç è§£æ</h2><h3 id="ThreadLocalMap-Hashç®—æ³•"><a href="#ThreadLocalMap-Hashç®—æ³•" class="headerlink" title="ThreadLocalMap Hashç®—æ³•"></a>ThreadLocalMap Hashç®—æ³•</h3><p>ThradLocalMapæ˜¯ä¸€ä¸ªmapç»“æ„ï¼Œåˆ™å®ç°è‡ªå·±çš„hashç®—æ³•æ¥è§£å†³hashå†²çªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„iå°±æ˜¯keyåœ¨æ•£åˆ—è¡¨ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚</p>
<p>æœ€å…³é”®çš„æ˜¯threadLocalHashCodeå€¼çš„è®¡ç®—ï¼ŒThreadLocalä¸­æœ‰ä¸€ä¸ªå±æ€§ä¸ºHASH_INCREMENT =  0x61c88647 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadLocalHashCode</span> <span class="operator">=</span> nextHashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">nextHashCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextHashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalMap</span> &#123;</span><br><span class="line">        ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">            table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">            size = <span class="number">1</span>;</span><br><span class="line">            setThreshold(INITIAL_CAPACITY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯å½“åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œè¿™ä¸ªThreadLocal.nextHashCode è¿™ä¸ªå€¼å°±ä¼šå¢é•¿ <code>0x61c88647</code> </p>
<p>è¿™ä¸ªå€¼å¯ä»¥ä½¿å¾—hashåˆ†å¸ƒå‡åŒ€ã€‚</p>
<h3 id="ThreadHashå†²çª"><a href="#ThreadHashå†²çª" class="headerlink" title="ThreadHashå†²çª"></a>ThreadHashå†²çª</h3><blockquote>
<p>ç»¿è‰²å—è¡¨ç¤ºæ­£å¸¸æ•°æ®ï¼Œç°è‰²å—è¡¨ç¤ºEntryçš„keyä¸ºnullï¼Œå·²è¢«åƒåœ¾å›æ”¶ï¼Œç™½è‰²å—è¡¨ç¤ºEntryä¸ºnull</p>
</blockquote>
<p><img src="/2022/07/11/ThreadLocal/7.2604852b.png" alt="img" loading="lazy"> </p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœæ’å…¥ä¸€ä¸ªvalue=27çš„æ•°æ®ï¼Œé€šè¿‡hashè®¡ç®—ååº”è¯¥è½å…¥æ§½ä½4ä¸­ï¼Œä½†æ§½ä½4å·²ç»æœ‰äº†Entryæ•°æ®ã€‚</p>
<p>æ­¤æ—¶ä¼šçº¿æ€§å‘åæŸ¥æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°Entryä¸ºnullçš„æ§½ä½æ‰ä¼šåœæ­¢ï¼Œå°†å½“å‰å…ƒç´ æ”¾å…¥æ­¤æ§½ä½ä¸­ã€‚<strong>è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šæœ‰å…¶ä»–æƒ…å†µï¼Œå¦‚é‡åˆ°Entryçš„keyä¸ºnullçš„æˆ–keyä¸ä¸ºnullä¸”ç›¸ç­‰çš„æƒ…å†µï¼Œéœ€è¦å…·ä½“åˆ†æ</strong></p>
<h3 id="ThreadLocal-set-è¯¦è§£"><a href="#ThreadLocal-set-è¯¦è§£" class="headerlink" title="ThreadLocal.set()è¯¦è§£"></a>ThreadLocal.set()è¯¦è§£</h3><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼šé€šè¿‡hashè®¡ç®—åçš„æ§½ä½å¯¹åº”çš„Entryæ•°æ®ä¸ºç©º</strong></p>
<p> <img src="/2022/07/11/ThreadLocal/9.f78d7ebb.png" alt="img" loading="lazy"> </p>
<p>ç›´æ¥å°†æ•°æ®æ”¾å…¥æ§½ä½å³å¯</p>
<p><strong>ç¬¬äºŒç§æƒ…å†µï¼šæ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œkeyå€¼ä¸ThreadLocalé€šè¿‡hashè®¡ç®—è·å–çš„å€¼ä¸€æ ·</strong> <img src="/2022/07/11/ThreadLocal/10.706954d1.png" alt="img" loading="lazy"> </p>
<p>æ­¤æ—¶æ›´æ–°æ§½ä½çš„Entryçš„value</p>
<p><strong>ç¬¬ä¸‰ç§æƒ…å†µï¼šæ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°Entryä¸ºnullçš„æ§½ä½ä¹‹å‰ï¼Œæ²¡æœ‰é‡åˆ°è¿‡æœŸçš„Entry</strong> <img src="/2022/07/11/ThreadLocal/11.c5a61453.png" alt="img" loading="lazy"> </p>
<p>éå†æ•£åˆ—æ•°ç»„ï¼Œçº¿æ€§å¾€åæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°Entryä¸ºnullçš„æ§½ä½ï¼Œå°†æ•°æ®æ”¾å…¥ï¼Œæˆ–è€…å¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°keyç›¸ç­‰çš„æ•°æ®ï¼Œç›´æ¥æ›´æ–°ã€‚</p>
<p><strong>ç¬¬å››ç§æƒ…å†µï¼šæ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°Entryä¸ºnullä¹‹å‰ï¼Œé‡åˆ°keyè¿‡æœŸçš„Entry</strong></p>
<p>å¦‚ä¸‹ï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°index=7çš„æ§½ä½æ•°æ®Entryçš„keyä¸ºnull <img src="/2022/07/11/ThreadLocal/12.1fd13c9f.png" alt="img" loading="lazy"> </p>
<p>æ•£åˆ—æ•°ç»„ä¸‹è¡¨ä¸º7çš„ä½ç½®å¯¹åº”çš„Entryæ•°æ®keyä¸ºnullï¼Œè¡¨æ˜æ­¤æ•°æ®çš„keyè¢«åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šæ‰§è¡ŒreplaceStaleEntry()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯ <strong>æ›¿æ¢è¿‡æœŸæ•°æ®</strong>ï¼Œä»¥index=7ä¸ºèµ·ç‚¹å¼€å§‹éå†ï¼Œè¿›è¡Œæ¢æµ‹å¼æ•°æ®æ¸…ç†å·¥ä½œã€‚</p>
<p>åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®æ‰«æçš„å¼€å§‹ä½ç½®ï¼šslotToExpunge=staleSlot=7</p>
<p> ä»¥å½“å‰<code>staleSlot</code>å¼€å§‹ å‘å‰è¿­ä»£æŸ¥æ‰¾ï¼Œæ‰¾å…¶ä»–è¿‡æœŸçš„æ•°æ®ï¼Œç„¶åæ›´æ–°è¿‡æœŸæ•°æ®èµ·å§‹æ‰«æä¸‹æ ‡<code>slotToExpunge</code>ã€‚<code>for</code>å¾ªç¯è¿­ä»£ï¼Œç›´åˆ°ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>ç»“æŸã€‚ </p>
<p>æ‰¾åˆ°äº†è¿‡æœŸæ•°æ®ï¼Œç»§ç»­å‘å‰è¿­ä»£ï¼Œç›´åˆ°é‡åˆ°Entryä¸ºnullçš„æ§½ä½æ‰åœæ­¢ã€‚å¦‚ä¸‹å›¾ï¼ŒslotToExpungeè¢«æ›´æ–°ä¸º0 <img src="/2022/07/11/ThreadLocal/13.55766305.png" alt="img" loading="lazy"> </p>
<p>ä»¥å½“å‰èŠ‚ç‚¹(<code>index=7</code>)å‘å‰è¿­ä»£ï¼Œæ£€æµ‹æ˜¯å¦æœ‰è¿‡æœŸçš„<code>Entry</code>æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°<code>slotToExpunge</code>å€¼ã€‚ç¢°åˆ°<code>null</code>åˆ™ç»“æŸæ¢æµ‹ã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹<code>slotToExpunge</code>è¢«æ›´æ–°ä¸º 0ã€‚</p>
<p>ä¸Šé¢å‘å‰è¿­ä»£çš„æ“ä½œæ˜¯ä¸ºäº†æ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„èµ·å§‹ä¸‹æ ‡<code>slotToExpunge</code>çš„å€¼ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰è¿‡æœŸæ§½ä½<code>staleSlot</code>ä¹‹å‰æ˜¯å¦è¿˜æœ‰è¿‡æœŸå…ƒç´ ã€‚</p>
<p>æ¥ç€å¼€å§‹ä»¥<code>staleSlot</code>ä½ç½®(<code>index=7</code>)å‘åè¿­ä»£ï¼Œ</p>
<p><strong>å¦‚æœæ‰¾åˆ°äº†ç›¸åŒ key å€¼çš„ Entry æ•°æ®ï¼š</strong> <img src="/2022/07/11/ThreadLocal/14.28205930.png" alt="img" loading="lazy"> </p>
<p>ä»å½“å‰èµ·ç‚¹staleSlotå‘åæŸ¥æ‰¾keyç›¸ç­‰çš„æ•°æ®ï¼Œæ‰¾åˆ°åæ›´æ–°Entryçš„å€¼å¹¶äº¤æ¢staleSlotå…ƒç´ çš„ä½ç½®(staleSlotä¸ºè¿‡æœŸå…ƒç´ )ï¼Œæ›´æ–°Entryå…ƒç´ ï¼Œç„¶åå¼€å§‹è¿›è¡Œè¿‡æœŸEntryçš„æ¸…ç†å·¥ä½œï¼Œå¦‚ä¸‹ <img src="/2022/07/11/ThreadLocal/view.png" alt="img" loading="lazy"> </p>
<p><strong>å¦‚æœæ²¡æ‰¾åˆ°ç›¸åŒkeyçš„Entryæ•°æ®:</strong> <img src="/2022/07/11/ThreadLocal/15.e6795086.png" alt="img" loading="lazy"> </p>
<p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>å…ƒç´ ï¼Œç›´åˆ°<code>Entry</code>ä¸º<code>null</code>åˆ™åœæ­¢å¯»æ‰¾ã€‚é€šè¿‡ä¸Šå›¾å¯çŸ¥ï¼Œæ­¤æ—¶<code>table</code>ä¸­æ²¡æœ‰<code>key</code>å€¼ç›¸åŒçš„<code>Entry</code>ã€‚</p>
<p>åˆ›å»ºæ–°çš„<code>Entry</code>ï¼Œæ›¿æ¢<code>table[stableSlot]</code>ä½ç½®ï¼š <img src="/2022/07/11/ThreadLocal/16.480ba6bd.png" alt="img" loading="lazy"> </p>
<p>æ›¿æ¢å®Œæˆåï¼Œä¹Ÿæ˜¯è¿›è¡Œè¿‡æœŸå…ƒç´ æ¸…ç†å·¥ä½œã€‚æ¸…ç†å·¥ä½œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šexpungeStaleEntry()å’ŒcleanSomeSlots(),</p>
<p><strong>ä»£ç ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">         e != <span class="literal">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tab[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">    <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡keyæ¥è®¡ç®—åœ¨æ•£åˆ—è¡¨ä¸­å¯¹åº”ä½ç½®ï¼Œç„¶åä»¥å½“å‰keyå¯¹åº”çš„æ¡¶ä½ç½®å‘åæŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯ä»¥ä½¿ç”¨çš„æ¡¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Entry[] tab = table;</span><br><span class="line"><span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>ä»€ä¹ˆæƒ…å†µä¸‹æ¡¶å¯ä»¥ä½¿ç”¨ï¼Ÿ</p>
<ol>
<li>k=keyè¯´æ˜æ›¿æ¢æ“ä½œ</li>
<li>ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸæ¡¶ï¼Œæ‰§è¡Œæ›¿æ¢é€»è¾‘ï¼Œå ç”¨è¿‡æœŸæ¡¶</li>
<li>æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°æ¡¶ä¸­Entry=nullçš„æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨</li>
</ol>
<p>æ¥ç€ç›´æ¥forå¾ªç¯éå†ï¼Œå‘åæŸ¥æ‰¾ï¼Œä»¥ä¸‹nextIndex()ã€prevIndex()æ–¹æ³•å®ç°ï¼š <img src="/2022/07/11/ThreadLocal/17.ce02241d.png" alt="img" loading="lazy">  <img src="/2022/07/11/ThreadLocal/17.ce02241d.png" alt="img" loading="lazy"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">prevIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ((i - <span class="number">1</span> &gt;= <span class="number">0</span>) ? i - <span class="number">1</span> : len - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ‰§è¡Œforå¾ªç¯ä¸­çš„é€»è¾‘ï¼š</p>
<ol>
<li>éå†å½“å‰keyå€¼å¯¹åº”çš„æ¡¶ä¸­Entryæ•°æ®ä¸ºç©ºï¼Œè¯´æ˜æ•£åˆ—æ•°ç»„ä¸­æ²¡æœ‰å‘ç”Ÿhashå†²çªï¼Œè·³å‡ºå¾ªç¯ï¼Œç›´æ¥æ”¾åˆ°æ•°ç»„æ¡¶ä¸­</li>
<li>å¦‚æœkeyå€¼å¯¹åº”çš„æ¡¶ä¸­Entryä¸ä¸ºç©º<ol>
<li>å¦‚æœk=keyï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œï¼Œåšæ›¿æ¢é€»è¾‘ï¼Œç›´æ¥è¿”å›</li>
<li>å¦‚æœkey=nullï¼Œè¯´æ˜å½“å‰Entryæ˜¯è¿‡æœŸæ•°æ®ï¼Œæ‰§è¡Œ replaceStaleEntry() æ–¹æ³•ï¼Œç„¶åè¿”å›</li>
</ol>
</li>
<li>forå¾ªç¯æ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œè¯´æ˜éå†è¿‡ç¨‹ä¸­æ‰¾åˆ°äº†Entryä¸ºnullçš„æƒ…å†µ<ol>
<li>åœ¨Entryä¸ºnullçš„ä½ç½®æ–°å»ºEntry</li>
<li>æ‰§è¡Œ++Sizeæ“ä½œ</li>
</ol>
</li>
<li>è°ƒç”¨cleanSomeSlots()åšä¸€æ¬¡<strong>å¯å‘å¼æ¸…ç†</strong>å·¥ä½œï¼Œæ¸…ç†æ•£åˆ—æ•°ç»„ä¸­è¿‡æœŸæ•°æ®<ol>
<li>å¦‚æœæ²¡æœ‰æ¸…ç†åˆ°ä»»ä½•æ•°æ®ï¼Œä¸”sizeè¶…è¿‡äº†é˜ˆå€¼(æ•°ç»„é•¿åº¦çš„2/3)ï¼Œè¿›è¡Œrehash()æ“ä½œ</li>
<li>rehash()ä¸­ä¼šå…ˆè¿›è¡Œä¸€è½®<strong>æ¢æµ‹å¼æ¸…ç†</strong>ï¼Œæ¸…ç†å®Œæˆåï¼Œå¦‚æœsize &gt;= threshold - threshold/4;å³å¦‚æœæ¸…ç†å<strong>size&gt;=3/4é˜ˆå€¼</strong>å°±ä¼šæ‰§è¡ŒçœŸæ­£çš„æ‰©å®¹é€»è¾‘</li>
</ol>
</li>
</ol>
<p><strong>replaceStaleEntry()æ–¹æ³•</strong>ï¼Œæä¾›æ›¿æ¢è¿‡æœŸæ•°æ®åŠŸèƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value,</span></span><br><span class="line"><span class="params">                                       <span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">slotToExpunge</span> <span class="operator">=</span> staleSlot;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> prevIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = prevIndex(i, len))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="literal">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line"></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line"></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                slotToExpunge = i;</span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>slotToExpungeè¡¨ç¤ºå¼€å§‹æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰staleSlotå¼€å§‹ã€‚ä»¥å½“å‰staleSlotå¼€å§‹ï¼Œå‘å‰è¿­ä»£æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ²¡æœ‰è¿‡æœŸçš„æ•°æ®ï¼Œforå¾ªç¯ä¸€ç›´ç¢°åˆ°Entryä¸ºnullæ‰ç»“æŸã€‚å¦‚æœå‘å‰æ‰¾åˆ°è¿‡æœŸæ•°æ®ï¼Œæ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¸ºiï¼Œå³slotToExpunge=i</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> prevIndex(staleSlot, len);</span><br><span class="line">     (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">     i = prevIndex(i, len))&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (e.get() == <span class="literal">null</span>)&#123;</span><br><span class="line">        slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ä»staleSlotå¼€å§‹å‘åæŸ¥æ‰¾ï¼Œä¹Ÿæ˜¯ç¢°åˆ°Entryä¸ºnullçš„æ¡¶ç»“æŸã€‚å¦‚æœè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°<strong>k=key</strong>ï¼Œè¯´æ˜æ˜¯<strong>æ›¿æ¢é€»è¾‘</strong>ã€‚æ›¿æ¢æ–°æ•°æ®å¹¶äº¤æ¢å½“å‰staleSlotä½ç½®ã€‚å¦‚æœslotToExpunge=staleSlotï¼Œè¯´æ˜replaceStaleEntry()ä¸€å¼€å§‹å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®æ—¶å¹¶æœªæ‰¾åˆ°ã€‚æ¥ç€å‘åæŸ¥æ‰¾ä¹Ÿæ²¡æœ‰æ‰¾åˆ°è¿‡æœŸæ•°æ®ã€‚æœ€åè°ƒç”¨ cleanSomeSlots(expungeStaleEntry(slotToExpunge), len); è¿›è¡Œå¯å‘å¼è¿‡æœŸæ•°æ®æ¸…ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">    e.value = value;</span><br><span class="line"></span><br><span class="line">    tab[i] = tab[staleSlot];</span><br><span class="line">    tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">        slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœkeyï¼=kï¼Œæ¥ç€å¾€ä¸‹æ‰§è¡Œï¼Œk==nullï¼Œè¯´æ˜å½“å‰éå†åˆ°çš„æ˜¯è¿‡æœŸæ•°æ®ï¼ŒslotToExpunge==staleSlotï¼Œè¯´æ˜ä¸€å¼€å§‹å‘å‰æŸ¥æ‰¾å¹¶æœªæ‰¾åˆ°è¿‡æœŸæ•°æ®ï¼Œå¦‚æœæ¡ä»¶æˆç«‹ï¼Œåˆ™æ›´æ–°slotToExpungeä¸ºå½“å‰ä½ç½®ï¼Œè¿™ä¸ªå‰é©±èŠ‚ç‚¹æ‰«ææ—¶æœªå‘ç°è¿‡æœŸæ•°æ®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (k == <span class="literal">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">    slotToExpunge = i;</span><br></pre></td></tr></table></figure>

<p>å¾€åè¿­ä»£è¿‡ç¨‹ä¸­å¦‚æœæ²¡æœ‰æ‰¾åˆ°k==keyçš„æ•°æ®ï¼Œä¸”ç¢°åˆ°çš„Entryä¸ºnullçš„æ•°æ®ï¼Œåˆ™ç»“æŸå½“å‰è¿­ä»£æ“ä½œã€‚æ­¤æ—¶è¯´æ˜è¿™é‡Œæ˜¯ä¸€ä¸ªæ·»åŠ çš„é€»è¾‘ï¼Œå°†æ–°çš„æ•°æ®æ·»åŠ åˆ°table[staleSlot]å¯¹åº”çš„slotä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">tab[staleSlot] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br></pre></td></tr></table></figure>

<p>æœ€ååˆ¤æ–­é™¤äº†staleSlotä¹‹å¤–ï¼Œè¿˜å‘ç°äº†å…¶ä»–è¿‡æœŸæ•°æ®ï¼Œå°±è¦å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocalMapè¿‡æœŸkeyçš„æ¢æµ‹å¼æ¸…ç†è¿‡ç¨‹"><a href="#ThreadLocalMapè¿‡æœŸkeyçš„æ¢æµ‹å¼æ¸…ç†è¿‡ç¨‹" class="headerlink" title="ThreadLocalMapè¿‡æœŸkeyçš„æ¢æµ‹å¼æ¸…ç†è¿‡ç¨‹"></a>ThreadLocalMapè¿‡æœŸkeyçš„æ¢æµ‹å¼æ¸…ç†è¿‡ç¨‹</h3><p>ThreadLocalMapæœ‰ä¸¤ç§è¿‡æœŸkeyæ•°æ®æ¸…ç†æ–¹å¼ï¼š<strong>æ¢æµ‹å¼å’Œå¯å‘å¼æ¸…ç†</strong></p>
<p>expungeStaleEntry()æ–¹æ³•ï¼Œéå†æ•£åˆ—æ•°ç»„ï¼Œä»<strong>å¼€å§‹ä½ç½®å‘å</strong>æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œ<strong>å°†è¿‡æœŸæ•°æ®çš„Entryè®¾ç½®ä¸ºnull</strong>ï¼Œæ²¿é€”ç¢°åˆ°çš„æœªè¿‡æœŸçš„æ•°æ®å°†å…¶hashå<strong>é‡æ–°åœ¨tableæ•°ç»„ä¸­å®šä½</strong>ã€‚å¦‚æœå®šä½ä½ç½®æœ‰äº†å…ƒç´ ï¼Œåˆ™ä¼šå°†æ­¤æ•°æ®æ”¾ç½®åœ¨æœ€é è¿‘æ­¤ä½ç½®çš„Entry=nullçš„æ¡¶ä¸­ï¼Œä½¿rehashåçš„Entryæ•°æ®è·ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘ä¸€äº›ã€‚ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">expungeStaleEntry</span><span class="params">(<span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="literal">null</span>;</span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="literal">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            e.value = <span class="literal">null</span>;</span><br><span class="line">            tab[i] = <span class="literal">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                tab[i] = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡ä¸€è½®æ¢æµ‹åï¼Œkeyè¿‡æœŸæ•°æ®ä¼šè¢«æ¸…ç†ï¼Œæ²¡è¿‡æœŸçš„æ•°æ®ç»è¿‡rehash()åç†è®ºä¸Šæ›´æ¥è¿‘ <code>i= key.hashCode &amp; (tab.len - 1)</code>çš„ä½ç½®ã€‚</p>
<h3 id="ThreadLocalMapæ‰©å®¹æœºåˆ¶"><a href="#ThreadLocalMapæ‰©å®¹æœºåˆ¶" class="headerlink" title="ThreadLocalMapæ‰©å®¹æœºåˆ¶"></a>ThreadLocalMapæ‰©å®¹æœºåˆ¶</h3><p>åœ¨ThreadLocalMap.set()æ–¹æ³•æœ€åï¼Œå¦‚æœæ‰§è¡Œå®Œå¯å‘å¼æ¸…ç†åæœªæ¸…ç†åˆ°ä»»ä½•æ•°æ®ï¼Œå¹¶ä¸”æ•°ç»„ä¸­Entryçš„æ•°é‡è¾¾åˆ°äº†åˆ—è¡¨çš„æ‰©å®¹é˜ˆå€¼(len*2/3)ï¼Œåˆ™æ‰§è¡Œrehashé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">    rehash();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">()</span> &#123;</span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expungeStaleEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼š<strong>éå†æ•°ç»„</strong>ï¼Œè‹¥é‡åˆ°äº†keyä¸ºnullçš„è¿‡æœŸæ•°æ®ï¼Œåˆ™è¿›è¡Œ<strong>æ¢æµ‹å¼æ¸…ç†</strong>å·¥ä½œã€‚æ¸…ç†å®Œæˆä¹‹åï¼Œtableä¸­å¯èƒ½æœ‰ä¸€äº›è¿‡æœŸæ•°æ®è¢«æ¸…ç†æ‰ï¼Œæ‰€ä»¥æ­¤æ—¶é€šè¿‡<strong>åˆ¤æ–­</strong> <code>size &gt;= threshold - threshold / 4</code> ä¹Ÿå°±æ˜¯<code>size &gt;= threshold * 3/4</code> æ¥å†³å®šæ˜¯å¦æ‰©å®¹ã€‚ </p>
<blockquote>
<p>ThreadLocalMapæ‰©å®¹æœ‰ä¸¤ä¸ªåˆ¤æ–­æ­¥éª¤ï¼š</p>
<p>**set()<strong>æ—¶ï¼Œé˜ˆå€¼æ˜¯size&gt;=thresholdï¼Œè€Œ</strong>rehash()*<em>æ—¶,é˜ˆå€¼æ˜¯size&gt;=threshold</em>3/4ã€‚</p>
</blockquote>
<p> <img src="/2022/07/11/ThreadLocal/24.5a96689a.png" alt="img" loading="lazy"> </p>
<p>æ‰©å®¹åçš„tabå¤§å°æ˜¯<strong>oldLen*2</strong>ï¼Œç„¶åéå†å°±æ•£åˆ—è¡¨ï¼Œé‡æ–°è®¡ç®—hashä½ç½®ã€‚æ”¾åˆ°æ–°æ•°ç»„ä¸­ï¼Œå‡ºç°hashå†²çªå°±çº¿æ€§å¾€åå¯»æ‰¾æœ€è¿‘entryä¸ºnullçš„ä½ç½®ã€‚éå†å®Œæˆåï¼ŒoldTabä¸­æ‰€æœ‰entryæ•°æ®å·²ç»æ”¾å…¥æ–°æ•°ç»„ã€‚é‡æ–°è®¡ç®—tabä¸‹æ¬¡æ‰©å®¹çš„<strong>é˜ˆå€¼</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resize</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLen</span> <span class="operator">=</span> oldTab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newLen</span> <span class="operator">=</span> oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> <span class="title class_">Entry</span>[newLen];</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> oldTab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                e.value = <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocalMap-get"><a href="#ThreadLocalMap-get" class="headerlink" title="ThreadLocalMap.get()"></a>ThreadLocalMap.get()</h3><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼šé€šè¿‡æŸ¥æ‰¾keyå€¼è®¡ç®—æ•£åˆ—è¡¨ä¸­slotä½ç½®ï¼Œç„¶åè¯¥slotä½ç½®ä¸­Entry.keyå’ŒæŸ¥æ‰¾keyä¸€è‡´ï¼Œç›´æ¥è¿”å›</strong> <img src="/2022/07/11/ThreadLocal/26.fdebe91d.png" alt="img" loading="lazy"> </p>
<p><strong>ç¬¬äºŒç§æƒ…å†µï¼šslotä½ç½®ä¸­çš„Entryå’Œè¦æŸ¥æ‰¾çš„keyä¸ä¸€è‡´ï¼š</strong> <img src="/2022/07/11/ThreadLocal/27.9c78c2a2.png" alt="img" loading="lazy"> </p>
<p>å¦‚å›¾ï¼Œä»¥get(ThreadLocal1)ä¸ºä¾‹ï¼Œé€šè¿‡hashè®¡ç®—åï¼Œæ­£ç¡®çš„ä½ç½®åº”è¯¥ä¸º4ï¼Œä½†index=4çš„ä½ç½®å·²ç»æœ‰äº†æ•°æ®ï¼Œä¸”keyå€¼ä¸ç­‰äºè¦æŸ¥çš„keyï¼Œæ‰€ä»¥ç»§ç»­å¾€åè¿­ä»£æŸ¥æ‰¾ã€‚</p>
<p> è¿­ä»£åˆ°<code>index=5</code>çš„æ•°æ®æ—¶ï¼Œæ­¤æ—¶<code>Entry.key=null</code>ï¼Œ<strong>è§¦å‘ä¸€æ¬¡æ¢æµ‹å¼æ•°æ®å›æ”¶æ“ä½œ</strong>ï¼Œæ‰§è¡Œ<code>expungeStaleEntry()</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œ<code>index 5,8</code>çš„æ•°æ®éƒ½ä¼šè¢«å›æ”¶ï¼Œè€Œ<code>index 6,7</code>çš„æ•°æ®éƒ½ä¼šå‰ç§»ï¼Œæ­¤æ—¶ç»§ç»­å¾€åè¿­ä»£ï¼Œåˆ°<code>index = 6</code>çš„æ—¶å€™å³æ‰¾åˆ°äº†<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š  <img src="/2022/07/11/ThreadLocal/28.ea7d5196.png" alt="img" loading="lazy"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="type">int</span> i, Entry e)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocalMapè¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†"><a href="#ThreadLocalMapè¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†" class="headerlink" title="ThreadLocalMapè¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†"></a>ThreadLocalMapè¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†</h3><p> <img src="/2022/07/11/ThreadLocal/29.5f828b88.png" alt="img" loading="lazy"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanSomeSlots</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        i = nextIndex(i, len);</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">            n = len;</span><br><span class="line">            removed = <span class="literal">true</span>;</span><br><span class="line">            i = expungeStaleEntry(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> ( (n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="InheritableThreadLoacl"><a href="#InheritableThreadLoacl" class="headerlink" title="InheritableThreadLoacl"></a>InheritableThreadLoacl</h2><p>ThreadLocalï¼Œåœ¨å¼‚æ­¥åœºæ™¯ä¸‹æ— æ³•ç»™å­çº¿ç¨‹å…±äº«çˆ¶çº¿ç¨‹ä¸­åˆ›å»ºçš„å‰¯æœ¬æ•°æ®ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒInheritableThreadLocalç±»å¯ä»¥è§£å†³ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocalDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ThreadLocal&lt;String&gt; ThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">        ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">        ThreadLocal.set(<span class="string">&quot;çˆ¶ç±»æ•°æ®:threadLocal&quot;</span>);</span><br><span class="line">        inheritableThreadLocal.set(<span class="string">&quot;çˆ¶ç±»æ•°æ®:inheritableThreadLocal&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼š&quot;</span> + ThreadLocal.get());</span><br><span class="line">                System.out.println(<span class="string">&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼š&quot;</span> + inheritableThreadLocal.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼š<span class="literal">null</span></span><br><span class="line">å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼šçˆ¶ç±»æ•°æ®:inheritableThreadLocal</span><br></pre></td></tr></table></figure>

<p>å®ç°åŸç†æ˜¯å­çº¿ç¨‹é€šè¿‡çˆ¶çº¿ç¨‹ä¸­é€šè¿‡è°ƒç”¨new Thread()æ–¹æ³•åˆ›å»ºå­çº¿ç¨‹ï¼Œ <code>Thread#init</code>æ–¹æ³•åœ¨<code>Thread</code>çš„æ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚åœ¨<code>init</code>æ–¹æ³•ä¸­æ‹·è´çˆ¶çº¿ç¨‹æ•°æ®åˆ°å­çº¿ç¨‹ä¸­ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span><br><span class="line"><span class="params">                      <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                      <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;name cannot be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">        <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">    <span class="built_in">this</span>.stackSize = stackSize;</span><br><span class="line">    tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThreadLoaclå†…å­˜æ³„æ¼"><a href="#ThreadLoaclå†…å­˜æ³„æ¼" class="headerlink" title="ThreadLoaclå†…å­˜æ³„æ¼"></a>ThreadLoaclå†…å­˜æ³„æ¼</h2><p> <img src="/2022/07/11/ThreadLocal/640.jpg" alt="å›¾ç‰‡" loading="lazy"> </p>
<p> ThreadLocalåœ¨ä¿å­˜çš„æ—¶å€™ä¼šæŠŠè‡ªå·±å½“åšKeyå­˜åœ¨ThreadLocalMapä¸­ï¼Œæ­£å¸¸æƒ…å†µåº”è¯¥æ˜¯keyå’Œvalueéƒ½åº”è¯¥è¢«å¤–ç•Œå¼ºå¼•ç”¨æ‰å¯¹ï¼Œä½†æ˜¯ç°åœ¨keyè¢«è®¾è®¡æˆWeakReferenceå¼±å¼•ç”¨äº†ã€‚  <img src="/2022/07/11/ThreadLocal/640-1657591204426.jpg" alt="å›¾ç‰‡" loading="lazy"> </p>
<p> å¦‚æœåˆ›å»ºThreadLocalçš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªEntryå¯¹è±¡ä¸­çš„valueå°±æœ‰å¯èƒ½ä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚  æ¯”å¦‚çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹ï¼Œçº¿ç¨‹éƒ½æ˜¯å¤ç”¨çš„ï¼Œé‚£ä¹ˆä¹‹å‰çš„çº¿ç¨‹å®ä¾‹å¤„ç†å®Œä¹‹åï¼Œå‡ºäºå¤ç”¨çš„ç›®çš„çº¿ç¨‹ä¾ç„¶å­˜æ´»ï¼Œæ‰€ä»¥ï¼ŒThreadLocalè®¾å®šçš„valueå€¼è¢«æŒæœ‰ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ </p>
<h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>åœ¨ä»£ç æœ€åä½¿ç”¨remove(),å°†æ•°æ®æ¸…ç©º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal&lt;String&gt; localName = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    localName.set(<span class="string">&quot;å¼ ä¸‰&quot;</span>);</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    localName.remove();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ºä»€ä¹ˆè¦è®¾ç½®å¼±å¼•ç”¨"><a href="#ä¸ºä»€ä¹ˆè¦è®¾ç½®å¼±å¼•ç”¨" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è®¾ç½®å¼±å¼•ç”¨"></a>ä¸ºä»€ä¹ˆè¦è®¾ç½®å¼±å¼•ç”¨</h3><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼šå¼ºå¼•ç”¨</strong></p>
<p> å¼•ç”¨ThreadLocalçš„å¯¹è±¡è¢«å›æ”¶äº†ï¼Œä½†æ˜¯ThreadLocalMapè¿˜æŒæœ‰ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ï¼ŒThreadLocalä¸ä¼šè¢«å›æ”¶ï¼ŒåŒæ ·å¯¼è‡´Entryå†…å­˜æ³„æ¼ã€‚ </p>
<p><strong>ç¬¬äºŒç§æƒ…å†µï¼šå¼±å¼•ç”¨</strong></p>
<p> å¼•ç”¨ThreadLocalçš„å¯¹è±¡è¢«å›æ”¶äº†ï¼Œç”±äºThreadLocalMapæŒæœ‰ThreadLocalçš„å¼±å¼•ç”¨ï¼Œå³ä½¿æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ï¼ŒThreadLocalä¹Ÿä¼šè¢«å›æ”¶ã€‚valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨setã€getã€removeçš„æ—¶å€™ä¼šè¢«æ¸…é™¤ã€‚ </p>
<p><strong>ç»“è®º</strong></p>
<p>æ¯”è¾ƒä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœéƒ½æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyï¼Œéƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯ä½¿ç”¨å¼±å¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœï¼šå¼±å¼•ç”¨ThreadLocalè¢«æ¸…ç†åkeyä¸ºnullï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨setã€getã€removeçš„æ—¶å€™å¯èƒ½ä¼šè¢«æ¸…é™¤ã€‚</p>
<p>å› æ­¤ï¼Œ<strong>ThreadLocalå†…å­˜æ³„æ¼çš„æ ¹æº</strong>æ˜¯ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè€Œä¸æ˜¯å› ä¸ºå¼±å¼•ç”¨ã€‚</p>
<h3 id="ThreadLocalå»ºè®®ä½¿ç”¨çš„åœºæ™¯"><a href="#ThreadLocalå»ºè®®ä½¿ç”¨çš„åœºæ™¯" class="headerlink" title="ThreadLocalå»ºè®®ä½¿ç”¨çš„åœºæ™¯"></a>ThreadLocalå»ºè®®ä½¿ç”¨çš„åœºæ™¯</h3><ul>
<li>å½“éœ€è¦å­˜å‚¨çº¿ç¨‹ç§æœ‰å˜é‡çš„æ—¶å€™ã€‚</li>
<li>å½“éœ€è¦å®ç°çº¿ç¨‹å®‰å…¨çš„å˜é‡æ—¶ã€‚</li>
<li>å½“éœ€è¦å‡å°‘çº¿ç¨‹èµ„æºç«äº‰çš„æ—¶å€™ã€‚</li>
</ul>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/images/alipay.jpg" alt="æ”¯ä»˜å®" title="æ”¯ä»˜å®"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechatpay.png"><img loading="lazy" src="/images/wechatpay.png" alt="å¾®ä¿¡æ”¯ä»˜" title="å¾®ä¿¡æ”¯ä»˜"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>ç¿”ä»”</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://example.com/2022/07/11/ThreadLocal/" title="ThreadLocal">http://example.com/2022/07/11/ThreadLocal/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/07/14/Sysnchronized%E9%94%81%E5%8D%87%E7%BA%A7/" rel="prev" title="Sysnchronizedé”å‡çº§"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Sysnchronizedé”å‡çº§</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/07/07/ReenttrantLock%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="next" title="AQSæºç åˆ†æ(reentrantLock)"><span class="post-nav-text">AQSæºç åˆ†æ(reentrantLock)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2022 </span><span class="with-love" id="animate" title="äº‘æ¸¸å›çš„èµåŠ©è€…ä»¬"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> ç¿”ä»”</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v5.4.2</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.11</span></div><div class="live-time"><span>æœ¬åšå®¢å·²è¿è¡Œ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2022-04-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} å¤© ${passHour} å°æ—¶ ${passMinute} åˆ† ${passSecond} ç§’`;
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>