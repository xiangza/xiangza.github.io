<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="ç¿”ä»”"><meta name="copyright" content="ç¿”ä»”"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>AQSæºç åˆ†æ(reentrantLock) | ç¿”ä»”çš„åšå®¢</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"ç¿”ä»”çš„å°ç«™","version":"1.8.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="AQSåŸç†å’Œç›¸å…³æºç ï¼š https:&#x2F;&#x2F;www.cnblogs.com&#x2F;waterystone&#x2F;p&#x2F;4920797.html https:&#x2F;&#x2F;www.cnblogs.com&#x2F;chengxiao&#x2F;archive&#x2F;2017&#x2F;07&#x2F;24&#x2F;7141160.html  AQSç®€å•ä»‹ç»AQSå…¨ç§°AbstractQueuedSyschronizerï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œåœ¨java.util.concurrent.l">
<meta property="og:type" content="article">
<meta property="og:title" content="AQSæºç åˆ†æ(reentrantLock)">
<meta property="og:url" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/index.html">
<meta property="og:site_name" content="ç¿”ä»”çš„åšå®¢">
<meta property="og:description" content="AQSåŸç†å’Œç›¸å…³æºç ï¼š https:&#x2F;&#x2F;www.cnblogs.com&#x2F;waterystone&#x2F;p&#x2F;4920797.html https:&#x2F;&#x2F;www.cnblogs.com&#x2F;chengxiao&#x2F;archive&#x2F;2017&#x2F;07&#x2F;24&#x2F;7141160.html  AQSç®€å•ä»‹ç»AQSå…¨ç§°AbstractQueuedSyschronizerï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œåœ¨java.util.concurrent.l">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188276933.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188606418.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188606418.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198053565.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198245942.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198344657.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/df0ea7bd9535485d87ddeb96c6a946ab.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657244474955.png">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/640.jpg">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/640-1657243263254.jpg">
<meta property="og:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzVmMTkwMjI0MWUwODUzM2E2MjdmOTkxMS5wbmc.png">
<meta property="article:published_time" content="2022-07-07T09:59:20.000Z">
<meta property="article:modified_time" content="2022-07-30T10:29:00.600Z">
<meta property="article:author" content="ç¿”ä»”">
<meta property="article:tag" content="reentrantLock">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188276933.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ç¿”ä»”"><img width="96" loading="lazy" src="/images/tx.jpg" alt="ç¿”ä»”"><span class="site-author-status" title="ä¸æƒ³ä¸Šå­¦">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">ç¿”ä»”</a></div><span class="site-name">ç¿”ä»”çš„åšå®¢</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="æˆ‘çš„ä¸»é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">27</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">9</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">18</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="æ–‡æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=910426929&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="985391895@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS%E5%8E%9F%E7%90%86%E5%92%8C%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">AQSåŸç†å’Œç›¸å…³æºç ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS"><span class="toc-number">2.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">ç®€å•ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">åŸºæœ¬å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8C%E6%AD%A5%E5%99%A8"><span class="toc-number">2.2.1.</span> <span class="toc-text">è‡ªå®šä¹‰åŒæ­¥å™¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">AQSåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E9%94%81%E4%B8%8E%E5%85%B1%E4%BA%AB%E9%94%81"><span class="toc-number">2.3.1.</span> <span class="toc-text">ç‹¬å é”ä¸å…±äº«é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">2.3.2.</span> <span class="toc-text">å…¬å¹³é”ä¸éå…¬å¹³é”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">åŸç†æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A0%87%E5%BF%97%E4%BD%8D-state"><span class="toc-number">2.3.4.</span> <span class="toc-text">åŒæ­¥æ ‡å¿—ä½ state</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81waitStatus"><span class="toc-number">2.3.5.</span> <span class="toc-text">èŠ‚ç‚¹çŠ¶æ€waitStatus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLH%E9%98%9F%E5%88%97"><span class="toc-number">2.3.6.</span> <span class="toc-text">CLHé˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.7.</span> <span class="toc-text">NodeèŠ‚ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReentrantLock%E6%BA%90%E7%A0%81"><span class="toc-number">2.4.</span> <span class="toc-text">ReentrantLockæºç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReentrantLock%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.1.</span> <span class="toc-text">ReentrantLockçš„åº•å±‚å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F-%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">ç‹¬å æ¨¡å¼(å…¬å¹³é”)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.4.1.1.1.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F%E9%94%81%E9%87%8A%E6%94%BE"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">ç‹¬å æ¨¡å¼é”é‡Šæ”¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Node%E9%93%BE%E8%A1%A8%E6%B5%81%E8%BD%AC%E6%83%85%E5%86%B5"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">Nodeé“¾è¡¨æµè½¬æƒ…å†µ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.4.1.4.</span> <span class="toc-text">å…±äº«æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">2.4.1.4.1.</span> <span class="toc-text">å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F%E9%94%81%E9%87%8A%E6%94%BE"><span class="toc-number">2.4.1.5.</span> <span class="toc-text">å…±äº«æ¨¡å¼é”é‡Šæ”¾</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%8C%BA%E5%88%AB"><span class="toc-number">2.4.2.</span> <span class="toc-text">å…¬å¹³é”ä¸éå…¬å¹³é”åŒºåˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ç¿”ä»”"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ç¿”ä»”çš„åšå®¢"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">AQSæºç åˆ†æ(reentrantLock)</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-07 17:59:20" itemprop="dateCreated datePublished" datetime="2022-07-07T17:59:20+08:00">2022-07-07</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-07-30 18:29:00" itemprop="dateModified" datetime="2022-07-30T18:29:00+08:00">2022-07-30</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">å¤šçº¿ç¨‹</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/reentrantLock/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">reentrantLock</span></a></span></div><div class="post-author"><span class="author-name">ç¿”ä»”</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="AQSåŸç†å’Œç›¸å…³æºç ï¼š"><a href="#AQSåŸç†å’Œç›¸å…³æºç ï¼š" class="headerlink" title="AQSåŸç†å’Œç›¸å…³æºç ï¼š"></a>AQSåŸç†å’Œç›¸å…³æºç ï¼š</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/waterystone/p/4920797.html">https://www.cnblogs.com/waterystone/p/4920797.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html">https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html</a></li>
</ul>
<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><h3 id="ç®€å•ä»‹ç»"><a href="#ç®€å•ä»‹ç»" class="headerlink" title="ç®€å•ä»‹ç»"></a>ç®€å•ä»‹ç»</h3><p>AQSå…¨ç§°AbstractQueuedSyschronizerï¼ŒæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œåœ¨java.util.concurrent.lockåŒ…ä¸‹ã€‚</p>
<p><img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188276933.png" alt="1657188276933" loading="lazy"></p>
<p>AQSæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦æ„å»ºé”å’ŒåŒæ­¥å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">extends</span> <span class="title class_">AbstractOwnableSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> AQS ä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€äº›é€šç”¨åŠŸèƒ½çš„æ˜¯å®ç°ï¼Œå› æ­¤ï¼Œä½¿ç”¨ AQS èƒ½ç®€å•ä¸”é«˜æ•ˆåœ°æ„é€ å‡ºåº”ç”¨å¹¿æ³›çš„å¤§é‡çš„åŒæ­¥å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„ <code>ReentrantLock</code>ï¼Œ<code>Semaphore</code>ï¼Œå…¶ä»–çš„è¯¸å¦‚ <code>ReentrantReadWriteLock</code>ï¼Œ<code>SynchronousQueue</code>ï¼Œ<code>FutureTask</code>(jdk1.7) ç­‰ç­‰çš†æ˜¯åŸºäº AQS çš„ã€‚ </p>
<h3 id="åŸºæœ¬å®ç°åŸç†"><a href="#åŸºæœ¬å®ç°åŸç†" class="headerlink" title="åŸºæœ¬å®ç°åŸç†"></a>åŸºæœ¬å®ç°åŸç†</h3><blockquote>
<p>æ ¸å¿ƒæ€æƒ³ï¼šä¸€å¥—å®ç°çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’åé”åˆ†é…çš„æœºåˆ¶</p>
</blockquote>
<p><img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188606418.png" alt="1657188606418" loading="lazy"></p>
<p>AQSä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡(state)è¡¨ç¤º<strong>åŒæ­¥çŠ¶æ€</strong>ï¼Œé€šè¿‡å†…ç½®çš„<strong>FIFOé˜Ÿåˆ—</strong>(CLH)æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚</p>
<p>CLHé˜Ÿåˆ—ï¼šå°†æ¯ä¸ªè¯·æ±‚èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹Node</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;<span class="comment">//å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§</span></span><br></pre></td></tr></table></figure>

<p><strong>çŠ¶æ€ä¿¡æ¯</strong>é€šè¿‡ <code>protected</code> ç±»å‹çš„<code>getState()</code>ï¼Œ<code>setState()</code>ï¼Œ<code>compareAndSetState()</code> è¿›è¡Œæ“ä½œ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">// è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">int</span> newState)</span> &#123;</span><br><span class="line">        state = newState;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetState</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AQSæ”¯æŒä¸¤ç§åŒæ­¥æ–¹å¼ï¼š</p>
<p><strong>1.ç‹¬å å¼</strong></p>
<p><strong>2.å…±äº«å¼</strong></p>
<p>  è¿™æ ·æ–¹ä¾¿ä½¿ç”¨è€…å®ç°ä¸åŒç±»å‹çš„åŒæ­¥ç»„ä»¶ï¼Œç‹¬å å¼å¦‚ReentrantLockï¼Œå…±äº«å¼å¦‚Semaphoreï¼ŒCountDownLatchï¼Œç»„åˆå¼çš„å¦‚ReentrantReadWriteLockã€‚æ€»ä¹‹ï¼ŒA<strong>QSä¸ºä½¿ç”¨æä¾›äº†åº•å±‚æ”¯æ’‘</strong>ï¼Œå¦‚ä½•ç»„è£…å®ç°ï¼Œä½¿ç”¨è€…å¯ä»¥è‡ªç”±å‘æŒ¥ã€‚</p>
<p> åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œä¸€èˆ¬ä½¿ç”¨æ–¹å¼ï¼š<br><strong>1. ä½¿ç”¨è€…ç»§æ‰¿AbstractQueuedSynchronizerå¹¶é‡å†™æŒ‡å®šæ–¹æ³•ã€‚(è¿™äº›é‡å†™æ–¹æ³•æ— éæ˜¯å¯¹å…±äº«èµ„æºstateçš„è·å–å’Œé‡Šæ”¾)</strong></p>
<p><strong>2.å°†AQSç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•</strong></p>
<p>AQSå®šä¹‰çš„å¯é‡å†™çš„æ–¹æ³•ï¼š</p>
<p><strong>protected boolean tryAcquire(int arg) : ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¯•ç€è·å–ï¼ŒæˆåŠŸè¿”å›trueï¼Œåä¹‹ä¸ºfalse</strong></p>
<p>ã€€ã€€ã€€ã€€<strong>protected boolean tryRelease(int arg) ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…ä¸­çš„å…¶ä»–çº¿ç¨‹æ­¤æ—¶å°†æœ‰æœºä¼šè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼›</strong></p>
<p>ã€€ã€€ã€€ã€€<strong>protected int tryAcquireShared(int arg) ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å€¼å¤§äºç­‰äº0ï¼Œä»£è¡¨è·å–æˆåŠŸï¼›åä¹‹è·å–å¤±è´¥ï¼›</strong></p>
<p>ã€€ã€€ã€€ã€€<strong>protected boolean tryReleaseShared(int arg) ï¼šå…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸä¸ºtrueï¼Œå¤±è´¥ä¸ºfalse</strong></p>
<p>ã€€ã€€ã€€ã€€<strong>protected boolean isHeldExclusively() ï¼š æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ã€‚</strong></p>
<p><strong>AQSçš„ä½¿ç”¨ï¼š</strong></p>
<p>â€‹     é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å»ç»§æ‰¿AbstractQueuedSynchronizerè¿™ä¸ªç±»ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚å»é‡å†™ç›¸åº”çš„æ–¹æ³•ï¼Œæ¯”å¦‚è¦å®ç°ä¸€ä¸ªç‹¬å é”ï¼Œé‚£å°±å»é‡å†™tryAcquireï¼ŒtryReleaseæ–¹æ³•ï¼Œè¦å®ç°å…±äº«é”ï¼Œå°±å»é‡å†™tryAcquireSharedï¼ŒtryReleaseSharedï¼›æœ€åï¼Œåœ¨æˆ‘ä»¬çš„ç»„ä»¶ä¸­è°ƒç”¨AQSä¸­çš„æ¨¡æ¿æ–¹æ³•å°±å¯ä»¥äº†ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•æ˜¯ä¼šè°ƒç”¨åˆ°æˆ‘ä»¬ä¹‹å‰é‡å†™çš„é‚£äº›æ–¹æ³•çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦å¾ˆå°çš„å·¥ä½œé‡å°±å¯ä»¥å®ç°è‡ªå·±çš„åŒæ­¥ç»„ä»¶ï¼Œé‡å†™çš„é‚£äº›æ–¹æ³•ï¼Œä»…ä»…æ˜¯ä¸€äº›ç®€å•çš„å¯¹äºå…±äº«èµ„æºstateçš„è·å–å’Œé‡Šæ”¾æ“ä½œï¼Œè‡³äºåƒæ˜¯è·å–èµ„æºå¤±è´¥ï¼Œçº¿ç¨‹éœ€è¦é˜»å¡ä¹‹ç±»çš„æ“ä½œï¼Œè‡ªç„¶æ˜¯AQSå¸®æˆ‘ä»¬å®Œæˆäº†ã€‚ </p>
<h4 id="è‡ªå®šä¹‰åŒæ­¥å™¨"><a href="#è‡ªå®šä¹‰åŒæ­¥å™¨" class="headerlink" title="è‡ªå®šä¹‰åŒæ­¥å™¨"></a>è‡ªå®šä¹‰åŒæ­¥å™¨</h4><p><strong>Mutex(äº’æ–¥é”)</strong></p>
<p>Mutexæ˜¯ä¸€ä¸ªä¸å¯é‡å…¥çš„äº’æ–¥é”å®ç°ã€‚é”èµ„æºï¼ˆAQSé‡Œçš„stateï¼‰åªæœ‰ä¸¤ç§çŠ¶æ€ï¼š0è¡¨ç¤ºæœªé”å®šï¼Œ1è¡¨ç¤ºé”å®šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mutex</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰åŒæ­¥å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦é”å®šçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°è¯•è·å–èµ„æºï¼Œç«‹å³è¿”å›ã€‚æˆåŠŸåˆ™è¿”å›trueï¼Œå¦åˆ™falseã€‚</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="type">assert</span> <span class="variable">acquires</span> <span class="operator">=</span>= <span class="number">1</span>; <span class="comment">// è¿™é‡Œé™å®šåªèƒ½ä¸º1ä¸ªé‡</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;<span class="comment">//stateä¸º0æ‰è®¾ç½®ä¸º1ï¼Œä¸å¯é‡å…¥ï¼</span></span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());<span class="comment">//è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ç‹¬å èµ„æº</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°è¯•é‡Šæ”¾èµ„æºï¼Œç«‹å³è¿”å›ã€‚æˆåŠŸåˆ™ä¸ºtrueï¼Œå¦åˆ™falseã€‚</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">            <span class="type">assert</span> <span class="variable">releases</span> <span class="operator">=</span>= <span class="number">1</span>; <span class="comment">// é™å®šä¸º1ä¸ªé‡</span></span><br><span class="line">            <span class="keyword">if</span> (getState() == <span class="number">0</span>)<span class="comment">//æ—¢ç„¶æ¥é‡Šæ”¾ï¼Œé‚£è‚¯å®šå°±æ˜¯å·²å æœ‰çŠ¶æ€äº†ã€‚åªæ˜¯ä¸ºäº†ä¿é™©ï¼Œå¤šå±‚åˆ¤æ–­ï¼</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);<span class="comment">//é‡Šæ”¾èµ„æºï¼Œæ”¾å¼ƒå æœ‰çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœŸæ­£åŒæ­¥ç±»çš„å®ç°éƒ½ä¾èµ–ç»§æ‰¿äºAQSçš„è‡ªå®šä¹‰åŒæ­¥å™¨ï¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Sync</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sync</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//lock&lt;--&gt;acquireã€‚ä¸¤è€…è¯­ä¹‰ä¸€æ ·ï¼šè·å–èµ„æºï¼Œå³ä¾¿ç­‰å¾…ï¼Œç›´åˆ°æˆåŠŸæ‰è¿”å›ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//tryLock&lt;--&gt;tryAcquireã€‚ä¸¤è€…è¯­ä¹‰ä¸€æ ·ï¼šå°è¯•è·å–èµ„æºï¼Œè¦æ±‚ç«‹å³è¿”å›ã€‚æˆåŠŸåˆ™ä¸ºtrueï¼Œå¤±è´¥åˆ™ä¸ºfalseã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//unlock&lt;--&gt;releaseã€‚ä¸¤è€…è¯­æ–‡ä¸€æ ·ï¼šé‡Šæ”¾èµ„æºã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é”æ˜¯å¦å æœ‰çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isHeldExclusively();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> åŒæ­¥ç±»åœ¨å®ç°æ—¶ä¸€èˆ¬éƒ½å°†è‡ªå®šä¹‰åŒæ­¥å™¨ï¼ˆsyncï¼‰å®šä¹‰ä¸ºå†…éƒ¨ç±»ï¼Œä¾›è‡ªå·±ä½¿ç”¨ï¼›è€ŒåŒæ­¥ç±»è‡ªå·±ï¼ˆMutexï¼‰åˆ™å®ç°æŸä¸ªæ¥å£ï¼Œå¯¹å¤–æœåŠ¡ã€‚å½“ç„¶ï¼Œæ¥å£çš„å®ç°è¦ç›´æ¥ä¾èµ–syncï¼Œå®ƒä»¬åœ¨è¯­ä¹‰ä¸Šä¹Ÿå­˜åœ¨æŸç§å¯¹åº”å…³ç³»ï¼ï¼è€Œsyncåªç”¨å®ç°èµ„æºstateçš„è·å–-é‡Šæ”¾æ–¹å¼tryAcquire-tryRelelaseï¼Œè‡³äºçº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ã€å”¤é†’ç­‰ï¼Œä¸Šå±‚çš„AQSéƒ½å·²ç»å®ç°å¥½äº†ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒã€‚ </p>
<h3 id="AQSåŸç†"><a href="#AQSåŸç†" class="headerlink" title="AQSåŸç†"></a>AQSåŸç†</h3><h4 id="ç‹¬å é”ä¸å…±äº«é”"><a href="#ç‹¬å é”ä¸å…±äº«é”" class="headerlink" title="ç‹¬å é”ä¸å…±äº«é”"></a>ç‹¬å é”ä¸å…±äº«é”</h4><p><strong>ç‹¬å é”</strong>ï¼šåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å æœ‰å…±äº«èµ„æº</p>
<p><strong>å…±äº«é”ï¼š</strong>å…±äº«èµ„æºå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶å æœ‰ï¼ŒçŸ¥é“å…±äº«èµ„æºè¢«å ç”¨å®Œæ¯•(ReadWriteLockã€CountDownLatch)</p>
<h4 id="å…¬å¹³é”ä¸éå…¬å¹³é”"><a href="#å…¬å¹³é”ä¸éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”ä¸éå…¬å¹³é”"></a>å…¬å¹³é”ä¸éå…¬å¹³é”</h4><p><strong>å…¬å¹³é”ï¼š</strong>åœ¨å¤šä¸ªçº¿ç¨‹ç«äº‰è·å–é”æ—¶ï¼Œå…¬å¹³é”å€¾å‘äºå°†è®¿é—®æƒæˆäºˆç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¬å¹³é”ç›¸å½“äºæœ‰ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œå…ˆè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ä¼šå…ˆè·å¾—é”ï¼ŒæŒ‰ç…§ â€œFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰â€ çš„åŸåˆ™ï¼Œå¯¹äºæ¯ä¸€ä¸ªç­‰å¾…çº¿ç¨‹éƒ½æ˜¯å…¬å¹³çš„ã€‚</p>
<p><strong>éå…¬å¹³é”ï¼š</strong> éå…¬å¹³é”æ˜¯æŠ¢å æ¨¡å¼ï¼Œçº¿ç¨‹ä¸ä¼šå…³æ³¨é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨å…¶ä»–çº¿ç¨‹ï¼Œä¹Ÿä¸ä¼šéµå®ˆå…ˆæ¥ååˆ°çš„åŸåˆ™ï¼Œç›´æ¥å°è¯•è·å–é”ã€‚</p>
<h4 id="åŸç†æµç¨‹"><a href="#åŸç†æµç¨‹" class="headerlink" title="åŸç†æµç¨‹"></a>åŸç†æµç¨‹</h4><p><img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657188606418.png" alt="1657188606418" loading="lazy"></p>
<p> ä»¥å®ç°<strong>ç‹¬å é”</strong>ä¸ºä¾‹ï¼ˆå³å½“å‰èµ„æºåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰ï¼‰ï¼Œå…¶å®ç°åŸç†å¦‚ä¸‹ï¼šstate åˆå§‹åŒ– 0ï¼Œåœ¨å¤šçº¿ç¨‹æ¡ä»¶ä¸‹ï¼Œçº¿ç¨‹è¦æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ï¼Œå¿…é¡»é¦–å…ˆ<strong>è·å– state</strong>ï¼ŒæŸä¸ªçº¿ç¨‹è·å–æˆåŠŸä¹‹åï¼Œ state åŠ  1ï¼Œå…¶ä»–çº¿ç¨‹å†è·å–çš„è¯ç”±äºå…±äº«èµ„æºå·²è¢«å ç”¨ï¼Œæ‰€ä»¥ä¼šåˆ° <strong>FIFO ç­‰å¾…é˜Ÿåˆ—</strong>å»ç­‰å¾…ï¼Œç­‰å æœ‰ state çš„çº¿ç¨‹æ‰§è¡Œå®Œä¸´ç•ŒåŒºçš„ä»£ç é‡Šæ”¾èµ„æº( state å‡ 1)åï¼Œä¼šå”¤é†’ FIFO ä¸­çš„ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ˆhead ä¸­çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼‰å»è·å– stateã€‚ </p>
<p>state ç”±äºæ˜¯å¤šçº¿ç¨‹å…±äº«å˜é‡ï¼Œæ‰€ä»¥å¿…é¡»å®šä¹‰æˆ volatileï¼Œä»¥ä¿è¯ state çš„å¯è§æ€§, åŒæ—¶è™½ç„¶ volatile èƒ½ä¿è¯å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥ AQS æä¾›äº†å¯¹ state çš„åŸå­æ“ä½œæ–¹æ³•ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p>
<h4 id="åŒæ­¥æ ‡å¿—ä½-state"><a href="#åŒæ­¥æ ‡å¿—ä½-state" class="headerlink" title="åŒæ­¥æ ‡å¿—ä½ state"></a><strong>åŒæ­¥æ ‡å¿—ä½ state</strong></h4><p>AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥æ ‡å¿—ä½ stateï¼Œç”¨æ¥å®ç°åŠ é”æ§åˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> volatitle <span class="type">int</span> state;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹å€¼ä¸º0ï¼Œçº¿ç¨‹æ¯åŠ ä¸€æ¬¡é”ï¼Œstateå°±ä¼šåŠ 1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå·²ç»è·å¾—é”çš„çº¿ç¨‹å†æ¬¡åŠ é”ï¼Œstateå€¼ä¼šå†æ¬¡åŠ 1ã€‚stateå®é™…ä¸Šè¡¨ç¤ºçš„æ˜¯å·²è·å¾—é”çš„çº¿ç¨‹åŠ é”æ¬¡æ•°</p>
<h4 id="èŠ‚ç‚¹çŠ¶æ€waitStatus"><a href="#èŠ‚ç‚¹çŠ¶æ€waitStatus" class="headerlink" title="èŠ‚ç‚¹çŠ¶æ€waitStatus"></a><strong>èŠ‚ç‚¹çŠ¶æ€waitStatus</strong></h4><p>Nodeç»“ç‚¹æ˜¯å¯¹æ¯ä¸€ä¸ªç­‰å¾…è·å–èµ„æºçš„çº¿ç¨‹çš„å°è£…ï¼Œå…¶åŒ…å«äº†éœ€è¦åŒæ­¥çš„çº¿ç¨‹æœ¬èº«åŠå…¶ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æ˜¯å¦è¢«é˜»å¡ã€æ˜¯å¦ç­‰å¾…å”¤é†’ã€æ˜¯å¦å·²ç»è¢«å–æ¶ˆç­‰ã€‚å˜é‡waitStatusåˆ™è¡¨ç¤ºå½“å‰Nodeç»“ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼Œå…±æœ‰5ç§å–å€¼CANCELLEDã€SIGNALã€CONDITIONã€PROPAGATEã€0ã€‚</p>
<ul>
<li><strong>CANCELLED</strong>(1)ï¼šè¡¨ç¤ºå½“å‰ç»“ç‚¹å·²å–æ¶ˆè°ƒåº¦ã€‚å½“timeoutæˆ–è¢«ä¸­æ–­ï¼ˆå“åº”ä¸­æ–­çš„æƒ…å†µä¸‹ï¼‰ï¼Œä¼šè§¦å‘å˜æ›´ä¸ºæ­¤çŠ¶æ€ï¼Œè¿›å…¥è¯¥çŠ¶æ€åçš„ç»“ç‚¹å°†ä¸ä¼šå†å˜åŒ–ã€‚</li>
<li><strong>SIGNAL</strong>(-1)ï¼šè¡¨ç¤ºåç»§ç»“ç‚¹åœ¨ç­‰å¾…å½“å‰ç»“ç‚¹å”¤é†’ã€‚åç»§ç»“ç‚¹å…¥é˜Ÿæ—¶ï¼Œä¼šå°†å‰ç»§ç»“ç‚¹çš„çŠ¶æ€æ›´æ–°ä¸ºSIGNALã€‚</li>
<li><strong>CONDITION</strong>(-2)ï¼šè¡¨ç¤ºç»“ç‚¹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†Conditionçš„signal()æ–¹æ³•åï¼ŒCONDITIONçŠ¶æ€çš„ç»“ç‚¹å°†<strong>ä»ç­‰å¾…é˜Ÿåˆ—è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</strong>ï¼Œç­‰å¾…è·å–åŒæ­¥é”ã€‚</li>
<li><strong>PROPAGATE</strong>(-3)ï¼šå…±äº«æ¨¡å¼ä¸‹ï¼Œå‰ç»§ç»“ç‚¹ä¸ä»…ä¼šå”¤é†’å…¶åç»§ç»“ç‚¹ï¼ŒåŒæ—¶ä¹Ÿå¯èƒ½ä¼šå”¤é†’åç»§çš„åç»§ç»“ç‚¹ã€‚</li>
<li><strong>0</strong>ï¼šæ–°ç»“ç‚¹å…¥é˜Ÿæ—¶çš„é»˜è®¤çŠ¶æ€ã€‚</li>
</ul>
<p>æ³¨æ„ï¼Œ<strong>è´Ÿå€¼è¡¨ç¤ºç»“ç‚¹å¤„äºæœ‰æ•ˆç­‰å¾…çŠ¶æ€ï¼Œè€Œæ­£å€¼è¡¨ç¤ºç»“ç‚¹å·²è¢«å–æ¶ˆã€‚æ‰€ä»¥æºç ä¸­å¾ˆå¤šåœ°æ–¹ç”¨&gt;0ã€&lt;0æ¥åˆ¤æ–­ç»“ç‚¹çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</strong>ã€‚</p>
<h4 id="CLHé˜Ÿåˆ—"><a href="#CLHé˜Ÿåˆ—" class="headerlink" title="CLHé˜Ÿåˆ—"></a>CLHé˜Ÿåˆ—</h4><p>é™¤äº†stateåŒæ­¥æ ‡å¿—ä½å¤–ï¼ŒAQSå†…éƒ¨è¿˜ä½¿ç”¨äº†ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼Œæ¥è¡¨ç¤ºç­‰å¾…é”çš„çº¿ç¨‹ï¼Œå½“çº¿ç¨‹ç«äº‰æŠ¢é”å¤±è´¥åä¼šå°è£…æˆNodeèŠ‚ç‚¹åŠ å…¥CLHé˜Ÿåˆ—ã€‚<img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198053565.png" alt="1657198053565" loading="lazy"></p>
<h4 id="NodeèŠ‚ç‚¹"><a href="#NodeèŠ‚ç‚¹" class="headerlink" title="NodeèŠ‚ç‚¹"></a>NodeèŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">      <span class="comment">// æ ‡è¯†å½“å‰èŠ‚ç‚¹åœ¨å…±äº«æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">      <span class="comment">// æ ‡è¯†å½“å‰èŠ‚ç‚¹åœ¨ç‹¬å æ¨¡å¼</span></span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br><span class="line">ã€€ã€€ã€€ <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line">      <span class="comment">//å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">volatile</span> Node prev;</span><br><span class="line">      <span class="comment">//åé©±èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">volatile</span> Node next;</span><br><span class="line">      <span class="comment">//å½“å‰çº¿ç¨‹</span></span><br><span class="line">      <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">      <span class="comment">//å­˜å‚¨åœ¨conditioné˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">      Node nextWaiter;</span><br><span class="line">      <span class="comment">//æ˜¯å¦ä¸ºå…±äº«é”</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isShared</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">return</span> <span class="variable">nextWaiter</span> <span class="operator">=</span>= SHARED;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> Node <span class="title function_">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> prev;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">      Node() &#123;&#125;</span><br><span class="line">      Node(Thread thread, Node mode) &#123;</span><br><span class="line">            <span class="built_in">this</span>.nextWaiter = mode;</span><br><span class="line">            <span class="built_in">this</span>.thread = thread;</span><br><span class="line">      &#125;</span><br><span class="line">      Node(Thread thread, <span class="type">int</span> waitStatus) &#123;</span><br><span class="line">            <span class="built_in">this</span>.waitStatus = waitStatus;</span><br><span class="line">            <span class="built_in">this</span>.thread = thread;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ç›´æ¥åç»§å’Œç›´æ¥å‰é©±èŠ‚ç‚¹ã€‚</p>
<p><strong>NodeèŠ‚ç‚¹çš„å˜åŒ–è¿‡ç¨‹</strong></p>
<p>å½“å‡ºç°é”ç«äº‰å’Œé‡Šæ”¾é”çš„æ—¶å€™ï¼ŒAQSåŒæ­¥é˜Ÿåˆ—ä¸­çš„NodeèŠ‚ç‚¹çš„å˜åŒ–ï¼š<img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198245942.png" alt="1657198245942" loading="lazy"></p>
<ul>
<li>çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹è¿½åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹çš„prevèŠ‚ç‚¹å’ŒnextèŠ‚ç‚¹çš„æŒ‡å‘</li>
<li>é€šè¿‡CASå°†tailé‡æ–°æŒ‡å‘æ–°çš„å°¾éƒ¨èŠ‚ç‚¹ï¼Œå³å½“å‰æ’å…¥çš„NodeèŠ‚ç‚¹</li>
</ul>
<p> head èŠ‚ç‚¹è¡¨ç¤ºè·å–é”æˆåŠŸçš„èŠ‚ç‚¹ï¼Œå½“å¤´ç»“ç‚¹é‡Šæ”¾é”åï¼Œä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œå¦‚æœåç»§èŠ‚ç‚¹è·å¾—é”æˆåŠŸï¼Œå°±ä¼šæŠŠè‡ªå·±è®¾ç½®ä¸ºå¤´ç»“ç‚¹ï¼ŒèŠ‚ç‚¹çš„å˜åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼š <img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657198344657.png" alt="1657198344657" loading="lazy"></p>
<ul>
<li>ä¿®æ”¹headèŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªè·å¾—é”çš„èŠ‚ç‚¹</li>
<li>æ–°çš„è·å¾—é”çš„èŠ‚ç‚¹ï¼Œå°†prevçš„æŒ‡é’ˆæŒ‡å‘null</li>
</ul>
<p> å’Œè®¾ç½® tail çš„é‡æ–°æŒ‡å‘ä¸åŒï¼Œè®¾ç½® head èŠ‚ç‚¹ä¸éœ€è¦ç”¨ CASï¼Œæ˜¯å› ä¸ºè®¾ç½® head èŠ‚ç‚¹æ˜¯ç”±è·å¾—é”çš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œè€ŒåŒæ­¥é”åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è·å¾—ï¼Œæ‰€ä»¥ä¸éœ€è¦ CAS ä¿è¯ã€‚åªéœ€è¦æŠŠ head èŠ‚ç‚¹è®¾ç½®ä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ–­å¼€åŸ head èŠ‚ç‚¹çš„ next å¼•ç”¨å³å¯ã€‚ </p>
<h3 id="ReentrantLockæºç "><a href="#ReentrantLockæºç " class="headerlink" title="ReentrantLockæºç "></a>ReentrantLockæºç </h3><p>ReentrantLockæ˜¯åŸºäºAQSå®ç°çš„ï¼Œå¯é‡å…¥çš„ç‹¬å é”ã€‚</p>
<p> <img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/df0ea7bd9535485d87ddeb96c6a946ab.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy"> </p>
<h4 id="ReentrantLockçš„åº•å±‚å®ç°"><a href="#ReentrantLockçš„åº•å±‚å®ç°" class="headerlink" title="ReentrantLockçš„åº•å±‚å®ç°"></a>ReentrantLockçš„åº•å±‚å®ç°</h4><h5 id="ç‹¬å æ¨¡å¼-å…¬å¹³é”"><a href="#ç‹¬å æ¨¡å¼-å…¬å¹³é”" class="headerlink" title="ç‹¬å æ¨¡å¼(å…¬å¹³é”)"></a>ç‹¬å æ¨¡å¼(å…¬å¹³é”)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨çš„æ˜¯syncçš„æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“æ˜¯ç”±å­ç±»(FairSync)æ¥å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))&#123;</span><br><span class="line">     selfInterrupt();   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>é¦–å…ˆè°ƒç”¨**tryAcquire()**æ–¹æ³•å°è¯•è·å–é”ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡CASä¿®æ”¹stateä¸º1ï¼Œå¦‚æœå‘ç°é”å·²ç»è¢«å½“å‰çº¿ç¨‹å ç”¨ï¼Œå°±æ‰§è¡Œé‡å…¥ï¼Œä¹Ÿå°±æ˜¯ç»™state+1.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();<span class="comment">//è·å–stateå€¼</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;<span class="comment">//è‹¥stateä¸º0ï¼Œæ„å‘³ç€å½“å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°èµ„æºï¼Œé‚£å°±å¯ä»¥ç›´æ¥è·å–èµ„æºäº†å—ï¼ŸNO!è¿™ä¸å°±è·Ÿéå…¬å¹³é”çš„é€»è¾‘ä¸€æ ·äº†å˜›ã€‚çœ‹ä¸‹é¢çš„é€»è¾‘</span></span><br><span class="line">                <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; <span class="comment">//åˆ¤æ–­åœ¨æ—¶é—´é¡ºåºä¸Šï¼Œæ˜¯å¦æœ‰ç”³è¯·é”æ’åœ¨è‡ªå·±ä¹‹å‰çš„çº¿ç¨‹ï¼Œè‹¥æ²¡æœ‰ï¼Œæ‰èƒ½å»è·å–ï¼ŒCASè®¾ç½®stateï¼Œå¹¶æ ‡è®°å½“å‰çº¿ç¨‹ä¸ºæŒæœ‰æ’ä»–é”çš„çº¿ç¨‹ï¼›åä¹‹ï¼Œä¸èƒ½è·å–ï¼è¿™å³æ˜¯å…¬å¹³çš„å¤„ç†æ–¹å¼ã€‚</span></span><br><span class="line">                    compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;<span class="comment">//é‡å…¥çš„å¤„ç†é€»è¾‘ï¼Œå½“å‰çº¿ç¨‹ä¸å æœ‰é”çº¿ç¨‹æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¬å¹³é”ä¸éå…¬å¹³é”é€»è¾‘å¤§è‡´ä¸€è‡´ï¼Œä¸åŒåœ°æ–¹åœ¨äºæœ‰äº†!hasQueuedPredecesscors()è¿™ä¸ªåˆ¤æ–­é€»è¾‘ï¼Œå³ä¾¿stateä¸º0ï¼Œä¹Ÿä¸èƒ½è´¸ç„¶ç›´æ¥å»è·å–ï¼Œè¦å»çœ‹çœ‹æœ‰æ²¡æœ‰è¿˜åœ¨æ’é˜Ÿçš„çº¿ç¨‹ï¼Œè‹¥æ²¡æœ‰æ‰å°è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; <span class="comment">// å°¾ç»“ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;<span class="comment">//å¤´ç»“ç‚¹</span></span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="literal">null</span> || s.thread != Thread.currentThread());<span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰æ’åœ¨è‡ªå·±ä¹‹å‰çš„çº¿ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æœ‰ä¸¤ç§å¯èƒ½ä¼šè¿”å›true(è¿”å›trueæ„å‘³ç€æœ‰å…¶ä»–çº¿ç¨‹ç”³è¯·é”æ¯”è‡ªå·±æ—©ï¼Œéœ€è¦æ”¾å¼ƒæŠ¢å )ï¼š</p>
<ol>
<li>h!=t&amp;&amp;(s=h.next)==nullï¼Œè¿™ä¸ªé€»è¾‘æˆç«‹çš„ä¸€ç§å¯èƒ½headæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œtailæ­¤æ—¶è¿˜ä¸ºnullï¼Œè€ƒè™‘è¿™ç§æƒ…å†µï¼šå½“å…¶ä»–çº¿ç¨‹å»è·å–é”å¤±è´¥ï¼Œéœ€æ„é€ ä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä¸­(å‡è®¾æ­¤æ—¶åŒæ­¥é˜Ÿåˆ—ä¸ºç©º)ï¼Œåœ¨æ·»åŠ çš„æ—¶å€™ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ— æ„ä¹‰å‚€å„¡å¤´èŠ‚ç‚¹(åœ¨AQSçš„enqæ–¹æ³•ä¸­ï¼Œè¿™æ˜¯ä¸ªè‡ªæ—‹casæ“ä½œ)ï¼Œæœ‰å¯èƒ½åœ¨å°†headæŒ‡å‘æ­¤å‚€å„¡èŠ‚ç‚¹å®Œæ¯•ä¹‹åï¼Œè¿˜æœªå°†tailæŒ‡å‘èŠ‚ç‚¹ã€‚å¾ˆæ˜æ˜¾ï¼Œæ­¤çº¿ç¨‹æ—¶é—´ä¸Šä¼˜äºå½“å‰å¯¹è±¡ï¼Œè¡¨ç¤ºæœ‰ç­‰å¾…çº¿ç¨‹æ¯”è‡ªå·±æ¥çš„æ—©</li>
<li>h!=t &amp;&amp; (s=h.next) != null &amp;&amp; s.thread != Thread.currentThread()  åŒæ­¥é˜Ÿåˆ—ä¸­å·²ç»æœ‰è‹¥å¹²æ’é˜Ÿçº¿ç¨‹ä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯é˜Ÿåˆ—çš„è€äºŒç»“ç‚¹ï¼Œæ­¤ç§æƒ…å†µä¼šè¿”å›true  å‡å¦‚æ²¡æœ‰s.thread !=Thread.currentThread()è¿™ä¸ªåˆ¤æ–­çš„è¯ï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿè‹¥å½“å‰çº¿ç¨‹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­æ˜¯è€äºŒç»“ç‚¹ï¼ˆå¤´ç»“ç‚¹æ­¤æ—¶æ˜¯ä¸ªæ— æ„ä¹‰çš„å‚€å„¡ç»“ç‚¹),æ­¤æ—¶æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†èµ„æºï¼Œå”¤é†’è€äºŒç»“ç‚¹çº¿ç¨‹ï¼Œè€äºŒç»“ç‚¹çº¿ç¨‹é‡æ–°tryAcquireï¼ˆæ­¤é€»è¾‘åœ¨AQSä¸­çš„acquireQueuedæ–¹æ³•ä¸­ï¼‰ï¼Œåˆä¼šè°ƒç”¨åˆ°hasQueuedPredecessorsï¼Œä¸åŠ s.thread !=Thread.currentThread()è¿™ä¸ªåˆ¤æ–­çš„è¯ï¼Œè¿”å›å€¼å°±ä¸ºtrueï¼Œå¯¼è‡´tryAcquireå¤±è´¥ã€‚ </li>
</ol>
</li>
<li><p>å¦‚æœé”è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ‰§è¡Œ tryAcquire è¿”å›å¤±è´¥ï¼Œåˆ™ä¼šæ‰§è¡Œ <strong>addWaiter()</strong> æ–¹æ³•åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªç‹¬å å¼èŠ‚ç‚¹ï¼ŒNode. EXCLUSIVE ä»£è¡¨ç‹¬å æ¨¡å¼ï¼ŒaddWaiter() æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š </p>
<blockquote>
<p>addWaiteré€»è¾‘ï¼š</p>
<p>1.æ–°å»ºä¸€ä¸ªå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹ï¼Œ</p>
<p>2.å¦‚æœåŸtailä¸ä¸ºç©ºï¼Œåˆ™å°†åŸtailèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®æˆæ–°çš„NodeèŠ‚ç‚¹ï¼Œæ–°çš„èŠ‚ç‚¹è®¾ç½®ä¸ºtailï¼Œå¹¶ä¸”ä¸Šçº§èŠ‚ç‚¹ä¸ºåŸtailèŠ‚ç‚¹ï¼Œè¿”å›å½“å‰èŠ‚ç‚¹</p>
<p>3.å¦‚æœåŸtailèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è°ƒç”¨enq()æ–¹æ³•ï¼Œè¿›è¡Œè‡ªæ—‹ï¼Œå¦‚æœtailä¸ºç©ºï¼Œåˆ™è¿›è¡Œé“¾è¡¨åˆå§‹åŒ–ï¼Œåˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ä¸ºHeadèŠ‚ç‚¹ï¼Œå°†æ–°å»ºèŠ‚ç‚¹ è®¾ç½®æˆtailèŠ‚ç‚¹ï¼Œå¹¶ä¸”å’ŒHeadèŠ‚ç‚¹ç®€å†åŒå‘é“¾è¡¨ </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// å¦‚æœtailä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†åŸæ¥çš„tailèŠ‚ç‚¹è®¾ç½®ä¸ºæ–°èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// å°†æ–°èŠ‚ç‚¹CASæˆtailèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            <span class="comment">// åŸtailèŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>è·å–fifoçš„å°¾èŠ‚ç‚¹ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™é‡‡ç”¨casæ–¹å¼å°†ç­‰å¾…çº¿ç¨‹å…¥é˜Ÿï¼Œå¦‚æœå°¾èŠ‚ç‚¹ä¸ºç©ºåˆ™æ‰§è¡Œ<strong>enq()æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// å¦‚æœtailèŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–é“¾è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="comment">// æ–°å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œå¹¶ä¸”CASæ‰HeadèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                <span class="comment">// headèŠ‚ç‚¹èµ‹å€¼ç»™tailèŠ‚ç‚¹</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ç¬¬äºŒæ¬¡çš„æƒ…å†µtå°±ä¸å¯èƒ½ä¸ºç©ºäº†ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æ–°å»ºçš„èŠ‚ç‚¹çš„ä¸Šä¸€èŠ‚ç‚¹ä¸ºheadèŠ‚ç‚¹</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹æ–°å»ºçš„èŠ‚ç‚¹CASä¸ºtailèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">// å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°å»ºèŠ‚ç‚¹</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆåˆ¤æ–­tailæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºè¯´æ˜FIFOé˜Ÿåˆ—çš„headã€tailè¿˜æœªæ„å»ºï¼Œæ­¤æ—¶å…ˆæ„å»ºå¤´èŠ‚ç‚¹ï¼Œæ„å»ºä¹‹åå†ç”¨casçš„æ–¹å¼å°†æ­¤çº¿ç¨‹èŠ‚ç‚¹å…¥é˜Ÿ</p>
<blockquote>
<p>ä½¿ç”¨CASåˆ›å»ºheadèŠ‚ç‚¹çš„æ—¶å€™åªæ˜¯ç®€å•çš„è°ƒç”¨new Node()ï¼Œå¹¶ä¸åƒå…¶ä»–èŠ‚ç‚¹é‚£æ ·ï¼Œè®°å½•threadï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p> å› ä¸º head ç»“ç‚¹ä¸º<strong>è™šç»“ç‚¹</strong>ï¼Œå®ƒåªä»£è¡¨å½“å‰æœ‰çº¿ç¨‹å ç”¨äº† stateï¼Œè‡³äºå ç”¨ state çš„æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œå…¶å®æ˜¯è°ƒç”¨äº†ä¸Šæ–‡çš„ setExclusiveOwnerThread(current) ï¼Œå³è®°å½•åœ¨ exclusiveOwnerThread å±æ€§é‡Œã€‚ </p>
</blockquote>
</li>
<li><blockquote>
<p>å…¥é˜ŸæˆåŠŸåï¼Œçº¿ç¨‹ç”±äº<strong>é©¬ä¸Šå°±é˜»å¡</strong>ï¼Œå¼€é”€è¾ƒå¤§ï¼Œæ‰€ä»¥è®©ä»–ä»¬<strong>è‡ªæ—‹ç«äº‰</strong>é”ï¼Œä½†å¦‚æœæ˜¯ç‹¬å é”ï¼Œä¸€ç›´è¢«å½“å‰å æœ‰é”çš„çº¿ç¨‹æŒæœ‰ï¼Œé˜Ÿå†…çº¿ç¨‹ä¸€è‡´è‡ªæ—‹æ²¡æœ‰æ„ä¹‰ï¼Œå ç”¨cpuå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥æ›´åˆé€‚çš„æ˜¯è‡ª<strong>æ—‹ä¸€ä¸¤æ¬¡</strong>å°±é˜»å¡ï¼Œå¦å¤–å¦‚æœé”å†è‡ªæ—‹è¿‡ç¨‹ä¸­è¢«ä¸­æ–­äº†ï¼Œæˆ–è€…è‡ªæ—‹è¶…æ—¶åº”è¯¥å¤„äº<strong>å–æ¶ˆçŠ¶æ€</strong>ã€‚å› æ­¤æœ‰äº†<strong>waitStatus</strong>å˜é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span>&#123;</span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();<span class="comment">//æ ‡è¯†ç­‰å¾…èŠ‚ç‚¹å¤„äºå…±äº«æ¨¡å¼</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//æ ‡è¯†ç­‰å¾…èŠ‚ç‚¹å¤„äºç‹¬å æ¨¡å¼</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">//ç”±äºè¶…æ—¶æˆ–ä¸­æ–­ï¼ŒèŠ‚ç‚¹å·²è¢«å–æ¶ˆ</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span> <span class="operator">=</span> -<span class="number">1</span>;  <span class="comment">// èŠ‚ç‚¹é˜»å¡ï¼ˆparkï¼‰å¿…é¡»åœ¨å…¶å‰é©±ç»“ç‚¹ä¸º SIGNAL çš„çŠ¶æ€ä¸‹æ‰èƒ½è¿›è¡Œï¼Œå¦‚æœç»“ç‚¹ä¸º SIGNAL,åˆ™å…¶é‡Šæ”¾é”æˆ–å–æ¶ˆåï¼Œå¯ä»¥é€šè¿‡ unpark å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;<span class="comment">//è¡¨ç¤ºçº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶å˜é‡ï¼ˆå…ˆè·å–é”ï¼ŒåŠ å…¥åˆ°æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œç„¶åé‡Šæ”¾é”ï¼Œç­‰å¾…æ¡ä»¶å˜é‡æ»¡è¶³æ¡ä»¶ï¼›åªæœ‰é‡æ–°è·å–é”ä¹‹åæ‰èƒ½è¿”å›ï¼‰</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;<span class="comment">//è¡¨ç¤ºåç»­ç»“ç‚¹ä¼šä¼ æ’­å”¤é†’çš„æ“ä½œï¼Œå…±äº«æ¨¡å¼ä¸‹èµ·ä½œç”¨</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//ç­‰å¾…çŠ¶æ€ï¼šå¯¹äºconditionèŠ‚ç‚¹ï¼Œåˆå§‹åŒ–ä¸ºCONDITIONï¼›å…¶å®ƒæƒ…å†µï¼Œé»˜è®¤ä¸º0ï¼Œé€šè¿‡CASæ“ä½œåŸå­æ›´æ–°</span></span><br><span class="line"> <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure>


</blockquote>
<p><strong>acquireQueued(final Node node, int arg)</strong>,å†™å…¥é˜Ÿåˆ—åéœ€è¦æŒ‚èµ·å½“å‰çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">//æ ‡è®°æ˜¯å¦æˆåŠŸè·å–é”  falseè¡¨ç¤ºæˆåŠŸè·å–</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æ ‡è®°çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­è¿‡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹é˜»å¡</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹ï¼Œåˆ™å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// åŠ é”æˆåŠŸäº†ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºheadèŠ‚ç‚¹ï¼Œå°†prevç½®ç©º</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                <span class="comment">// å°†åŸheadèŠ‚ç‚¹çš„nextç½®ç©ºï¼Œè„±é“¾å¸®åŠ©GCå›æ”¶</span></span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;<span class="comment">//æˆåŠŸè·å–</span></span><br><span class="line">                <span class="comment">// è¿”å›æ˜¯å¦è¢«é˜»å¡</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯headèŠ‚ç‚¹æˆ–ç«äº‰é”å¤±è´¥</span></span><br><span class="line">            <span class="comment">// è¿›è¡Œå¯¹å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€çš„åˆ¤æ–­ï¼Œæ¥å†³å®šå½“å‰èŠ‚ç‚¹æ˜¯å¦åº”è¯¥é˜»å¡ï¼Œ</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                <span class="comment">// é˜»å¡å¹¶æ£€æŸ¥ä¸­æ–­</span></span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// failedæ­£å¸¸æƒ…å†µéƒ½ä¸ºfalseï¼Œé™¤éè‡ªæ—‹é˜»å¡æœ€åéƒ½æ²¡æœ‰è¿›åˆ°è·å–é”é‡Œé¢</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// çº¿ç¨‹è‡ªæ—‹ä¸­å› ä¸ºå¼‚å¸¸ç­‰åŸå› è·å–é”å¤±è´¥ï¼Œåˆ™è¿›è¡Œå–æ¶ˆè¿›è¡Œä¸­çš„é”ç”³è¯·</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="comment">// -1 è¯´æ˜å‰ä¸€ä¸ªèŠ‚ç‚¹æ­£å¸¸é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹é˜»å¡ï¼Œå½“å‰èŠ‚ç‚¹å°±æ­£å¸¸é˜»å¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å¤§äº0ï¼Œåˆ™è¯´æ˜å·²ç»æ”¾å¼ƒäº†ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// é“¾è¡¨ä¸­å‰”é™¤å‰ä¸€ä¸ªæ”¾å¼ƒçŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">            <span class="comment">// å¦‚æœå‰ä¸€ä¸ªçŠ¶æ€è¿˜æ˜¯å¤§äº0ï¼Œç»§ç»­å¾€å‰æ‰¾ã€‚</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// å°†æ‰¾åˆ°éæ”¾å¼ƒçš„èŠ‚ç‚¹ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯é˜»å¡ä¹Ÿä¸æ˜¯æ”¾å¼ƒï¼Œç›¸å½“äº0æˆ–è€…&lt;-1çš„çŠ¶æ€ï¼Œå°†å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€CASæˆ-1é˜»å¡ã€‚ç­‰å¾…å”¤é†’</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿›è¡Œçº¿ç¨‹é˜»å¡</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// æ­¤å¤„æ£€æŸ¥é˜»å¡æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¯¥æ–¹æ³•ä¸ä»…æ£€æŸ¥ä¸­æ–­è¿˜ä¼šé‡ç½®ä¸­æ–­æ ‡å¿—ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li><p>ç¬¬ä¸€ç§æƒ…å†µï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹ï¼Œä¸”è·å–é”æˆåŠŸçš„å¤„ç†ï¼Œå°†headæŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œå¹¶ä¸”è®©åŸheadèŠ‚ç‚¹å‡ºé˜Ÿï¼Œæ–¹ä¾¿gcï¼Œæ³¨æ„å…¶ä¸­çš„setHead()çš„å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHead</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    head = node;</span><br><span class="line">    node.thread = <span class="literal">null</span>;</span><br><span class="line">    node.prev = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†headè®¾ç½®å½“å‰èŠ‚ç‚¹ï¼Œè¦æŠŠèŠ‚ç‚¹çš„threadï¼Œpreè®¾ç½®ä¸ºnullï¼Œå› ä¸ºheadæ˜¯è™šèŠ‚ç‚¹ï¼Œä¸ä¿å­˜é™¤waitStatus(èŠ‚ç‚¹çŠ¶æ€)çš„å…¶ä»–ä¿¡æ¯ã€‚å æœ‰é”çš„çº¿ç¨‹ç”± exclusiveThread  å±æ€§è®°å½•</p>
</li>
<li><p>å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯headæˆ–ç«äº‰é”å¤±è´¥ï¼Œåˆ™é¦–å…ˆè°ƒç”¨ shouldParkAfterFailedAcquire  æ–¹æ³•åˆ¤æ–­æ˜¯å¦åº”è¯¥åœæ­¢è‡ªæ—‹è¿›å…¥é˜»å¡çŠ¶æ€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="comment">// -1 è¯´æ˜å‰ä¸€ä¸ªèŠ‚ç‚¹æ­£å¸¸é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹é˜»å¡ï¼Œå½“å‰èŠ‚ç‚¹å°±æ­£å¸¸é˜»å¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å¤§äº0ï¼Œåˆ™è¯´æ˜å·²ç»æ”¾å¼ƒäº†ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// é“¾è¡¨ä¸­å‰”é™¤å‰ä¸€ä¸ªæ”¾å¼ƒçŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">            <span class="comment">// å¦‚æœå‰ä¸€ä¸ªçŠ¶æ€è¿˜æ˜¯å¤§äº0ï¼Œç»§ç»­å¾€å‰æ‰¾ã€‚</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// å°†æ‰¾åˆ°éæ”¾å¼ƒçš„èŠ‚ç‚¹ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯é˜»å¡ä¹Ÿä¸æ˜¯æ”¾å¼ƒï¼Œç›¸å½“äº0æˆ–è€…&lt;-1çš„çŠ¶æ€ï¼Œå°†å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€CASæˆ-1é˜»å¡ã€‚ç­‰å¾…å”¤é†’</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é¦–å…ˆï¼Œæ ¹æ®ä¹‹å‰Nodeç±»çš„ä¿¡æ¯ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºSIGNALï¼Œåˆ™å½“å‰èŠ‚ç‚¹å¯ä»¥è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>å¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºå–æ¶ˆçŠ¶æ€(1)ï¼Œåˆ™éœ€è¦å–æ¶ˆå‰é©±èŠ‚ç‚¹ï¼Œè¿™é‡Œé‡‡ç”¨do whileï¼ŒæŠŠå½“å‰èŠ‚ç‚¹ä¹‹å‰çš„æ‰€æœ‰waitStatusä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹å…¨éƒ¨ç§»é™¤ã€‚</p>
<p>å¦‚æœå‰é©±èŠ‚ç‚¹å°äºç­‰äº0ï¼Œåˆ™éœ€è¦å…ˆå°†å…¶å‰é©±èŠ‚ç‚¹ç½®ä¸ºSIGNALï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹è¿›å…¥é˜»å¡çš„ä¸€ä¸ªæ¡ä»¶æ˜¯å‰é©±èŠ‚ç‚¹å¿…é¡»ä¸ºSIGNALï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è‡ªæ—‹åå‘ç°å‰é©±èŠ‚ç‚¹ä¸ºSIGNALï¼Œå°±ä¼šè¿”å›true</p>
<p> shouldParkAfterFailedAcquire è¿”å› true ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿›å…¥é˜»å¡ä¸­æ–­ï¼Œé‚£ä¹ˆä¸‹ä¸€æ­¥ parkAndCheckInterrupt å°±è¯¥è®©çº¿ç¨‹é˜»å¡äº† </p>
</blockquote>
</li>
<li><p> <strong>parkAndCheckInterrupt ()</strong></p>
</li>
</ol>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é˜»å¡çº¿ç¨‹ï¼Œè¿›å…¥waitingçŠ¶æ€</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœè¢«å”¤é†’ï¼Œè¿”å›çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œå¹¶ä¸”æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼ˆåœ¨è·å¾—é”åä¼šè¡¥ä¸€æ¬¡ä¸­æ–­ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>park()ä¼šè®©çº¿ç¨‹è¿›å…¥waitingçŠ¶æ€ï¼Œåœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œæœ‰ä¸¤ç§é€”å¾„å¯ä»¥å”¤é†’è¯¥çº¿ç¨‹:1)è¢«unpark() 2)è¢«interrupt()ã€‚å‰è€…è¢«å”¤é†’è¿”å›falseï¼Œåè€…è¢«ä¸­æ–­è¿”å›trueå¹¶é‡ç½®æ ‡è®°ï¼Œå¹¶è®°å½•ä¸‹æ¥ï¼Œå¦‚æœå‘ç°ä¸­æ–­è¿‡å°±åœ¨ä¸­æ–­ä¸€æ¬¡</p>
</li>
<li><p>çº¿ç¨‹åœ¨ç­‰å¾…èµ„æºçš„è¿‡ç¨‹ä¸­è¢«å”¤é†’ï¼Œå”¤é†’åè¿˜æ˜¯ä¼šä¸æ–­åœ°å»å°è¯•è·å–é”ï¼Œç›´åˆ°æŠ¢åˆ°é”ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ•´ä¸ªæµç¨‹ä¸­ï¼Œå¹¶ä¸å“åº”ä¸­æ–­ï¼Œåªæ˜¯è®°å½•ä¸­æ–­è®°å½•ã€‚æœ€åæŠ¢åˆ°é”è¿”å›äº†ï¼Œé‚£ä¹ˆå¦‚æœè¢«ä¸­æ–­è¿‡çš„è¯ï¼Œå°±éœ€è¦è¡¥å……ä¸€æ¬¡ä¸­æ–­ã€‚</p>
</li>
</ol>
<p>   ä¸ºä»€ä¹ˆè¦åˆ¤æ–­æ˜¯å¦ä¸­æ–­è¿‡å‘¢ï¼Ÿå› ä¸º å¦‚æœçº¿ç¨‹åœ¨é˜»å¡æœŸé—´æ”¶åˆ°äº†ä¸­æ–­ï¼Œå”¤é†’ï¼ˆè½¬ä¸ºè¿è¡Œæ€ï¼‰è·å–é”åï¼ˆacquireQueued ä¸º trueï¼‰éœ€è¦è¡¥ä¸€ä¸ªä¸­æ–­ ï¼Œå¦‚ä¸‹ï¼š</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯å› ä¸ºä¸­æ–­å”¤é†’çš„çº¿ç¨‹ï¼Œè·å–é”åéœ€è¦è¡¥ä¸€ä¸‹ä¸­æ–­</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åœ¨parkAndCheckInterrupt()æ–¹æ³•ä¸­ç­‰å¾…é˜»å¡è¢«é‡Šæ”¾ï¼Œåˆ™ç»§ç»­å¾ªç¯å°è¯•è·å–é”ã€‚é˜»å¡è¢«é‡Šæ”¾å­˜åœ¨æ­£å¸¸é‡Šæ”¾ï¼ˆunpack()ï¼‰å’Œé˜»å¡ä¸­æ–­é‡Šæ”¾ï¼Œè°ƒç”¨Thread.interrupted()æ–¹æ³•åˆ¤æ–­æ˜¯å¦é˜»å¡ä¸­æ–­é‡Šæ”¾ï¼Œä¼šå°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—é‡ç½®è°ƒï¼›æ‰€ä»¥åœ¨å†æ¬¡è·å–é”ä¹‹åï¼Œè¿˜è¦è¿›è¡Œçº¿ç¨‹ä¸­æ–­æ ‡è¯†çš„è®¾ç½®</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p>å‰æ–‡ä¸æ˜¯è¯´ Node çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€ä¼šè¢«å–æ¶ˆå—ï¼Œé‚£ <strong>Node ä»€ä¹ˆæ—¶å€™ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€å‘¢ã€‚</strong> </p>
<p>å›çœ‹acquireQueued</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// çœç•¥è‡ªæ—‹è·å–é”ä»£ç         </span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹è‡ªæ—‹ä¸­å› ä¸ºå¼‚å¸¸ç­‰åŸå› è·å–é”æœ€ç»ˆå¤±è´¥ï¼Œåˆ™è°ƒç”¨æ­¤æ–¹æ³•</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœçº¿ç¨‹è‡ªæ—‹ä¸­å› ä¸ºå¼‚å¸¸ç­‰åŸå› è·å–é”æœ€ç»ˆå¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cancelAcquire</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// ç”±äºçº¿ç¨‹è¦è¢«å–æ¶ˆäº†ï¼Œæ‰€ä»¥å°† thread çº¿ç¨‹æ¸…æ‰</span></span><br><span class="line">    node.thread = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢è¿™æ­¥è¡¨ç¤ºå°† node çš„ pre æŒ‡å‘ä¹‹å‰ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼ˆå³è·³è¿‡æ‰€æœ‰å–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼‰,waitStatus &gt; 0 è¡¨ç¤ºå½“å‰ç»“ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç»è¿‡è¿‡æ»¤åçš„ pre çš„ next ç»“ç‚¹ï¼Œè¿™ä¸€æ­¥ä¸»è¦ç”¨åœ¨åé¢çš„ CAS è®¾ç½® pre çš„ next èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">predNext</span> <span class="operator">=</span> pred.next;</span><br><span class="line">    <span class="comment">// å°†å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å–æ¶ˆç»“ç‚¹ä¸ºå°¾ç»“ç‚¹ï¼Œä½¿ç”¨ CAS åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºå…¶å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™å°¾ç»“ç‚¹çš„ next æŒ‡é’ˆè®¾ç½®ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸€æ­¥çœ‹å¾—æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æƒ³æƒ³ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œé‚£æ˜¯ä¸æ˜¯è¦æŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ä¹Ÿè¯´äº†ï¼Œè¦å”¤é†’æˆ–é˜»å¡ç»“ç‚¹ï¼Œé¡»åœ¨å…¶å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNAL çš„æ¡ä»¶æ‰èƒ½æ“ä½œï¼Œæ‰€ä»¥åœ¨è®¾ç½® pre çš„ next èŠ‚ç‚¹æ—¶è¦ä¿è¯ pre ç»“ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œæƒ³é€šäº†è¿™ä¸€ç‚¹ç›¸ä¿¡ä½ ä¸éš¾ç†è§£ä»¥ä¸‹ä»£ç ã€‚</span></span><br><span class="line">        <span class="type">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ pre ä¸º headï¼Œæˆ–è€…  pre çš„çŠ¶æ€è®¾ç½® SIGNAL å¤±è´¥ï¼Œåˆ™ç›´æ¥å”¤é†’åç»§ç»“ç‚¹å»ç«äº‰é”ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ SIGNAL çš„ç»“ç‚¹å–æ¶ˆï¼ˆæˆ–é‡Šæ”¾é”ï¼‰åå¯ä»¥å”¤é†’åç»§ç»“ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h6><ol>
<li>è°ƒç”¨tryAcquire()å°è¯•è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›</li>
<li>æ²¡æˆåŠŸï¼Œåˆ™addWaiter()å°†è¯¥çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ ‡è®°ä¸ºç‹¬å æ¨¡å¼</li>
<li>acquireQueued()ä½¿çº¿ç¨‹å†ç­‰å¾…é˜Ÿåˆ—ä¸­ä¼‘æ¯ï¼Œæœ‰æœºä¼šæ—¶(è½®åˆ°è‡ªå·±ï¼Œä¼šè¢«unpark())ä¼šå»å°è¯•è·å–èµ„æºã€‚è·å–åæ‰è¿”å›ï¼Œå¦‚æœåœ¨æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li>å¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œå®ƒæ˜¯ä¸å“åº”çš„ã€‚åªæ˜¯è·å–èµ„æºåæ‰è¿›è¡Œè‡ªæˆ‘ä¸­æ–­selfInterruptï¼Œå°†ä¸­æ–­è¡¥ä¸Š</li>
</ol>
<p><img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/1657244474955.png" alt="1657244474955" loading="lazy"></p>
<hr>
<h5 id="ç‹¬å æ¨¡å¼é”é‡Šæ”¾"><a href="#ç‹¬å æ¨¡å¼é”é‡Šæ”¾" class="headerlink" title="ç‹¬å æ¨¡å¼é”é‡Šæ”¾"></a>ç‹¬å æ¨¡å¼é”é‡Šæ”¾</h5><p>ä¸ç®¡æ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨AQSçš„å¦‚ä¸‹æ¨¡æ¿æ–¹æ³•æ¥é‡Šæ”¾é”ï¼š</p>
<ol>
<li><p>unlock()æ–¹æ³•è°ƒç”¨äº†release()æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.util.concurrent.locks.AbstractQueuedSynchronizer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é”é‡Šæ”¾æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//å”¤é†’headä¹‹åçš„èŠ‚ç‚¹ï¼Œç«äº‰é”</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1.å°è¯•é‡Šæ”¾é”</p>
<p>2.é‡Šæ”¾æˆåŠŸä¹‹åï¼Œå¯¹HeadèŠ‚ç‚¹æ£€æŸ¥ï¼Œå”¤é†’æ’é˜Ÿåçš„åç»§è€…</p>
<p>3.ä¸ºä»€ä¹ˆé‡Šæ”¾é”çš„æ¡ä»¶æ˜¯ h != null &amp;&amp; h.waitStatus != 0 </p>
<p>â€‹    1.å¦‚æœh==nullï¼Œæœ‰ä¸¤ç§å¯èƒ½ï¼Œä¸€ç§æ˜¯ä¸€ä¸ªçº¿ç¨‹å†ç«äº‰é”ï¼Œç°åœ¨å®ƒé‡Šæ”¾äº†ï¼Œæ²¡æœ‰æ‰€è°“å”¤é†’åç»§èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿è¡Œç«äº‰é”ï¼Œåªæ˜¯è¿˜æ²¡åˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼Œæ—¢ç„¶è¿˜åœ¨è¿è¡Œï¼Œè‡ªç„¶æ— éœ€å”¤é†’æ“ä½œ</p>
<p>â€‹    2ã€å¦‚æœ h!=null&amp;&amp;h,waitStatus==0ï¼Œè¯´æ˜headçš„åç»§èŠ‚ç‚¹æ­£åœ¨è‡ªæ—‹ç«äº‰ï¼Œä¹Ÿå°±æ˜¯è¯´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ— éœ€å”¤é†’</p>
<p>â€‹    3.å¦‚æœ h!=null&amp;&amp;h,waitStatus&lt;0ï¼Œæ­¤æ—¶waitStatuså€¼å¯èƒ½ä¸ºSIGNALï¼Œæˆ– PROPAGATE ï¼Œè¿™ä¸¤ç§æƒ…å†µè¯´æ˜åç»§èŠ‚ç‚¹é˜»å¡éœ€è¦å”¤é†’( unparkSuccessor(Node node) )</p>
</blockquote>
<ol>
<li><p>tryRelease()å°è¯•é‡Šæ”¾é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é‡å…¥é”ï¼Œæ¯æ¬¡é‡Šæ”¾çŠ¶æ€-1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ï¼Œä¸ç­‰äºé”æ‰€æœ‰è€…çš„çº¿ç¨‹ï¼Œåˆ™æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœcä¸º0ï¼Œåˆ™è¯´æ˜é‡å…¥é”ä¹Ÿéƒ½é‡Šæ”¾å®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å®Œæˆé‡Šæ”¾åˆ™è¿”å›æˆåŠŸ</span></span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// é”æ‹¥æœ‰è€…çš„çº¿ç¨‹ç½®ç©º</span></span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°å½“å‰èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ¤è¯»é‚£é”æŒæœ‰è€…æ˜¯å¦å½“å‰çº¿ç¨‹ã€‚åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€-1æ˜¯å¦ä¸º0ï¼›å°†æ‰€æ‹¥æœ‰è€…ç½®ç©ºï¼Œé‡Šæ”¾é”ã€‚å¦‚æœæœ€åçŠ¶æ€ä¸ä¸º0ï¼Œè¿”å›é‡Šæ”¾é”å¤±è´¥</p>
</blockquote>
</li>
</ol>
</li>
<li><p>unparkSuccessor()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å– head çš„ waitStatusï¼ˆå‡è®¾å…¶ä¸º SIGNALï¼‰,å¹¶ç”¨ CAS å°†å…¶ç½®ä¸º 0ï¼Œä¸ºå•¥è¦åšè¿™ä¸€æ­¥å‘¢ï¼Œä¹‹å‰æˆ‘ä»¬åˆ†æè¿‡å¤šæ¬¡ï¼Œå…¶å® waitStatus = SIGNALï¼ˆ&lt; -1ï¼‰æˆ– PROPAGATEï¼ˆ-Â·3ï¼‰ åªæ˜¯ä¸€ä¸ªæ ‡å¿—ï¼Œä»£è¡¨åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œåç»§èŠ‚ç‚¹å¯ä»¥å”¤é†’ï¼Œæ—¢ç„¶æ­£åœ¨å”¤é†’åç»§èŠ‚ç‚¹ï¼Œè‡ªç„¶å¯ä»¥å°†å…¶é‡ç½®ä¸º 0ï¼Œå½“ç„¶å¦‚æœå¤±è´¥äº†ä¹Ÿä¸å½±å“å…¶å”¤é†’åç»§ç»“ç‚¹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹æ“ä½œä¸ºæ‰¾åˆ°ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="comment">// sèŠ‚ç‚¹ä¸ºç©ºæˆ–è€…çŠ¶æ€å¤§äº0(å–æ¶ˆçŠ¶æ€)</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// å¾ªç¯ä»å°¾éƒ¨å¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç¦»å½“å‰nodeæœ€è¿‘çš„ä¸€ä¸ªç¬¦åˆç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="comment">// æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å°äº0çš„ï¼Œè¯´æ˜åœ¨ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// å…ˆå°†ç­‰å¾…çš„èŠ‚ç‚¹èµ‹ç»™s</span></span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­˜åœ¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å”¤é†’</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// å°†ä¸‹ä¸€ä¸ªæ’é˜Ÿè€…å”¤é†’</span></span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>unparkSuccessoné€»è¾‘ï¼š<br>1.è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œæ»¡è¶³åˆ™å”¤é†’</p>
<p>2.ä¸æ»¡è¶³åˆ™å¾ªç¯ä»å°¾éƒ¨å¾€å‰æ‰¾ï¼Œæ‰¾åˆ°ç¦»å½“å‰nodeæœ€è¿‘çš„éå–æ¶ˆèŠ‚ç‚¹</p>
<p>3.å°†ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹å”¤é†’</p>
</blockquote>
<p>è¿™é‡Œå¯»æ‰¾é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ä¸ºä»€ä¹ˆä»åå¾€å‰æ‰¾ï¼Œå› ä¸ºèŠ‚ç‚¹å…¥é˜Ÿå¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œå¦‚ä¸‹ï¼š <img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/640.jpg" alt="å›¾ç‰‡" loading="lazy"> </p>
<p>çº¿ç¨‹è‡ªæ—‹æ—¶ï¼Œæ˜¯å…ˆæ‰§è¡Œnode.pre=predï¼Œå†æ‰§è¡Œpred.next=nodeï¼Œå¦‚æœ  unparkSuccessor åˆšå¥½åœ¨è¿™ä¸¤è€…ä¹‹é—´æ‰§è¡Œï¼Œæ­¤æ—¶æ˜¯æ‰¾ä¸åˆ°  head çš„åç»§èŠ‚ç‚¹çš„ï¼Œå¦‚ä¸‹  <img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/640-1657243263254.jpg" alt="å›¾ç‰‡" loading="lazy"> </p>
</li>
</ol>
<h5 id="Nodeé“¾è¡¨æµè½¬æƒ…å†µ"><a href="#Nodeé“¾è¡¨æµè½¬æƒ…å†µ" class="headerlink" title="Nodeé“¾è¡¨æµè½¬æƒ…å†µ"></a>Nodeé“¾è¡¨æµè½¬æƒ…å†µ</h5><p> <img src="/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzVmMTkwMjI0MWUwODUzM2E2MjdmOTkxMS5wbmc.png" alt="image" loading="lazy"> </p>
<h5 id="å…±äº«æ¨¡å¼"><a href="#å…±äº«æ¨¡å¼" class="headerlink" title="å…±äº«æ¨¡å¼"></a>å…±äº«æ¨¡å¼</h5><p><strong>acquireShared(int arg)</strong></p>
<blockquote>
<p>æ­¤æ–¹æ³•æ˜¯å…±äº«æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ï¼Œä¼šè·å–æŒ‡å®šé‡çš„èµ„æºï¼Œè·å–æˆåŠŸç›´æ¥è¿”å›ï¼Œè·å–å¤±è´¥è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–æˆåŠŸä¸ºæ­¢ï¼Œæ•´ä¸ªè¿‡ç¨‹å¿½ç•¥ä¸­æ–­</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒtryAcquireShared()éœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨å»å®ç°ã€‚ä½†æ˜¯AQSå·²ç»æŠŠå…¶è¿”å›å€¼çš„è¯­ä¹‰å®šä¹‰å¥½äº†ï¼šè´Ÿå€¼ä»£è¡¨è·å–å¤±è´¥ï¼›0ä»£è¡¨è·å–æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºï¼›æ­£æ•°è¡¨ç¤ºè·å–æˆåŠŸï¼Œè¿˜æœ‰å‰©ä½™èµ„æºï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¯ä»¥å»è·å–ã€‚æ‰€ä»¥è¿™é‡ŒacquireShared()çš„æµç¨‹å°±æ˜¯ï¼š</p>
<ol>
<li><ol>
<li>tryAcquireShared()å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼›</li>
<li>å¤±è´¥åˆ™é€šè¿‡doAcquireShared()è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢æ‰è¿”å›ã€‚</li>
</ol>
</li>
</ol>
<p><strong>doAcquireShared(int)</strong></p>
<p> æ­¤æ–¹æ³•ç”¨äºå°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ä¼‘æ¯ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºå”¤é†’è‡ªå·±ï¼Œè‡ªå·±æˆåŠŸæ‹¿åˆ°ç›¸åº”é‡çš„èµ„æºåæ‰è¿”å› </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);<span class="comment">//åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;<span class="comment">//æ˜¯å¦æˆåŠŸæ ‡å¿—</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡çš„æ ‡å¿—</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();<span class="comment">//å‰é©±</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;<span class="comment">//å¦‚æœåˆ°headçš„ä¸‹ä¸€ä¸ªï¼Œå› ä¸ºheadæ˜¯æ‹¿åˆ°èµ„æºçš„çº¿ç¨‹ï¼Œæ­¤æ—¶nodeè¢«å”¤é†’ï¼Œå¾ˆå¯èƒ½æ˜¯headç”¨å®Œèµ„æºæ¥å”¤é†’è‡ªå·±çš„</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);<span class="comment">//å°è¯•è·å–èµ„æº</span></span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;<span class="comment">//æˆåŠŸ</span></span><br><span class="line">                    setHeadAndPropagate(node, r);<span class="comment">//å°†headæŒ‡å‘è‡ªå·±ï¼Œè¿˜æœ‰å‰©ä½™èµ„æºå¯ä»¥å†å”¤é†’ä¹‹åçš„çº¿ç¨‹</span></span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)<span class="comment">//å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­è¢«æ‰“æ–­è¿‡ï¼Œæ­¤æ—¶å°†ä¸­æ–­è¡¥ä¸Šã€‚</span></span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//åˆ¤æ–­çŠ¶æ€ï¼Œå¯»æ‰¾å®‰å…¨ç‚¹ï¼Œè¿›å…¥waitingçŠ¶æ€ï¼Œç­‰ç€è¢«unpark()æˆ–interrupt()</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•å’ŒacquireQueuedå¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œå°†è¡¥ä¸­æ–­çš„sekfInteerupt()æ”¾åˆ° doAcquireShared ()é‡Œï¼Œè€Œç‹¬å æ¨¡å¼æ˜¯æ”¾åˆ°acquireQueued()ä¹‹å¤–ã€‚</p>
<blockquote>
<p>è·Ÿç‹¬å æ¨¡å¼æ¯”ï¼Œè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåªæœ‰çº¿ç¨‹æ˜¯head.nextæ—¶ï¼ˆâ€œè€äºŒâ€ï¼‰ï¼Œæ‰ä¼šå»å°è¯•è·å–èµ„æºï¼Œæœ‰å‰©ä½™çš„è¯è¿˜ä¼šå”¤é†’ä¹‹åçš„é˜Ÿå‹ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œå‡å¦‚è€å¤§ç”¨å®Œåé‡Šæ”¾äº†5ä¸ªèµ„æºï¼Œè€Œè€äºŒéœ€è¦6ä¸ªï¼Œè€ä¸‰éœ€è¦1ä¸ªï¼Œè€å››éœ€è¦2ä¸ªã€‚è€å¤§å…ˆå”¤é†’è€äºŒï¼Œè€äºŒä¸€çœ‹èµ„æºä¸å¤Ÿï¼Œä»–æ˜¯æŠŠèµ„æºè®©ç»™è€ä¸‰å‘¢ï¼Œè¿˜æ˜¯ä¸è®©ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼è€äºŒä¼šç»§ç»­park()ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºï¼Œä¹Ÿæ›´ä¸ä¼šå»å”¤é†’è€ä¸‰å’Œè€å››äº†ã€‚ç‹¬å æ¨¡å¼ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œè¿™æ ·åšæœªå°ä¸å¯ï¼›ä½†å…±äº«æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹æ˜¯å¯ä»¥åŒæ—¶æ‰§è¡Œçš„ï¼Œç°åœ¨å› ä¸ºè€äºŒçš„èµ„æºéœ€æ±‚é‡å¤§ï¼Œè€ŒæŠŠåé¢é‡å°çš„è€ä¸‰å’Œè€å››ä¹Ÿéƒ½å¡ä½äº†ã€‚å½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯é—®é¢˜ï¼Œåªæ˜¯AQSä¿è¯ä¸¥æ ¼æŒ‰ç…§å…¥é˜Ÿé¡ºåºå”¤é†’ç½¢äº†ï¼ˆä¿è¯å…¬å¹³ï¼Œä½†é™ä½äº†å¹¶å‘ï¼‰ã€‚ </p>
</blockquote>
<p><strong>setHeadAndPropagate(Node, int)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    setHead(node);<span class="comment">//headæŒ‡å‘è‡ªå·±</span></span><br><span class="line">     <span class="comment">//å¦‚æœè¿˜æœ‰å‰©ä½™é‡ï¼Œç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ªé‚»å±…çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> æ­¤æ–¹æ³•åœ¨setHead()çš„åŸºç¡€ä¸Šå¤šäº†ä¸€æ­¥ï¼Œå°±æ˜¯è‡ªå·±è‹é†’çš„åŒæ—¶ï¼Œå¦‚æœæ¡ä»¶ç¬¦åˆï¼ˆæ¯”å¦‚è¿˜æœ‰å‰©ä½™èµ„æºï¼‰ï¼Œè¿˜ä¼šå»å”¤é†’åç»§ç»“ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯å…±äº«æ¨¡å¼ï¼ </p>
<p><strong>doReleaseShared()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                unparkSuccessor(h);<span class="comment">//å”¤é†’åç»§</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)<span class="comment">// headå‘ç”Ÿå˜åŒ–</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h6><ol>
<li>tryAcquireShared()å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å› </li>
<li>å¤±è´¥åˆ™é€šè¿‡doAcquireShared()è¿›å…¥ç­‰å¾…é˜Ÿåˆ—park()ï¼Œç›´åˆ°è¢«unpark()/interrupt()å¹¶æˆåŠŸè·å–åˆ°èµ„æºæ‰è¿”å›ã€‚æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¹Ÿæ˜¯å¿½ç•¥ä¸­æ–­çš„ã€‚</li>
</ol>
<h5 id="å…±äº«æ¨¡å¼é”é‡Šæ”¾"><a href="#å…±äº«æ¨¡å¼é”é‡Šæ”¾" class="headerlink" title="å…±äº«æ¨¡å¼é”é‡Šæ”¾"></a>å…±äº«æ¨¡å¼é”é‡Šæ”¾</h5><p>**releaseShared()**å…±äº«æ¨¡å¼ä¸‹é‡Šæ”¾é”çš„é¡¶å±‚å…¥å£ï¼Œä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœæˆåŠŸé‡Šæ”¾ä¸”å…è®¸å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œå®ƒä¼šå”¤é†’ç­‰å¾…çº¿ç¨‹æ¥è·å–èµ„æº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;<span class="comment">//å°è¯•é‡Šæ”¾èµ„æº</span></span><br><span class="line">        doReleaseShared();<span class="comment">//å”¤é†’åç»§ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é‡Šæ”¾æ‰èµ„æºåï¼Œå”¤é†’åç»§ã€‚è·Ÿç‹¬å æ¨¡å¼ä¸‹çš„release()ç›¸ä¼¼ï¼Œä½†æœ‰ä¸€ç‚¹ç¨å¾®éœ€è¦æ³¨æ„ï¼šç‹¬å æ¨¡å¼ä¸‹çš„tryRelease()åœ¨å®Œå…¨é‡Šæ”¾æ‰èµ„æºï¼ˆstate=0ï¼‰åï¼Œæ‰ä¼šè¿”å›trueå»å”¤é†’å…¶ä»–çº¿ç¨‹ï¼Œè¿™ä¸»è¦æ˜¯åŸºäºç‹¬å ä¸‹å¯é‡å…¥çš„è€ƒé‡ï¼›è€Œå…±äº«æ¨¡å¼ä¸‹çš„releaseShared()åˆ™æ²¡æœ‰è¿™ç§è¦æ±‚ï¼Œå…±äº«æ¨¡å¼å®è´¨å°±æ˜¯æ§åˆ¶ä¸€å®šé‡çš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œé‚£ä¹ˆæ‹¥æœ‰èµ„æºçš„çº¿ç¨‹åœ¨é‡Šæ”¾æ‰éƒ¨åˆ†èµ„æºæ—¶å°±å¯ä»¥å”¤é†’åç»§ç­‰å¾…ç»“ç‚¹ã€‚ä¾‹å¦‚ï¼Œèµ„æºæ€»é‡æ˜¯13ï¼ŒAï¼ˆ5ï¼‰å’ŒBï¼ˆ7ï¼‰åˆ†åˆ«è·å–åˆ°èµ„æºå¹¶å‘è¿è¡Œï¼ŒCï¼ˆ4ï¼‰æ¥æ—¶åªå‰©1ä¸ªèµ„æºå°±éœ€è¦ç­‰å¾…ã€‚Aåœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡Šæ”¾æ‰2ä¸ªèµ„æºé‡ï¼Œç„¶åtryReleaseShared(2)è¿”å›trueå”¤é†’Cï¼ŒCä¸€çœ‹åªæœ‰3ä¸ªä»ä¸å¤Ÿç»§ç»­ç­‰å¾…ï¼›éšåBåˆé‡Šæ”¾2ä¸ªï¼ŒtryReleaseShared(2)è¿”å›trueå”¤é†’Cï¼ŒCä¸€çœ‹æœ‰5ä¸ªå¤Ÿè‡ªå·±ç”¨äº†ï¼Œç„¶åCå°±å¯ä»¥è·ŸAå’ŒBä¸€èµ·è¿è¡Œã€‚è€ŒReentrantReadWriteLockè¯»é”çš„tryReleaseShared()åªæœ‰åœ¨å®Œå…¨é‡Šæ”¾æ‰èµ„æºï¼ˆstate=0ï¼‰æ‰è¿”å›trueï¼Œæ‰€ä»¥è‡ªå®šä¹‰åŒæ­¥å™¨å¯ä»¥æ ¹æ®éœ€è¦å†³å®štryReleaseShared()çš„è¿”å›å€¼ã€‚ </p>
</blockquote>
<p>**doReleaseShared()**å”¤é†’åç»§çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                unparkSuccessor(h);<span class="comment">//å”¤é†’åç»§</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)<span class="comment">// headå‘ç”Ÿå˜åŒ–</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å…¬å¹³é”ä¸éå…¬å¹³é”åŒºåˆ«"><a href="#å…¬å¹³é”ä¸éå…¬å¹³é”åŒºåˆ«" class="headerlink" title="å…¬å¹³é”ä¸éå…¬å¹³é”åŒºåˆ«"></a>å…¬å¹³é”ä¸éå…¬å¹³é”åŒºåˆ«</h4><blockquote>
<p>å…¬å¹³é”</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//å¦‚æœèŠ‚ç‚¹ä¹‹å‰æœ‰å‰ç»§èŠ‚ç‚¹ï¼Œä¼šè¿›è¡Œå…¥é˜Ÿ</span></span><br><span class="line">         	acquire(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Fair version of tryAcquire.  Don&#x27;t grant access unless</span></span><br><span class="line"><span class="comment">       * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">          <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">          <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; <span class="comment">//åœ¨è·å–é”ä¹‹å‰ä¼šåˆ¤æ–­å½“å‰èŠ‚ç‚¹ä¹‹å‰æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰æ‰ä¼šå°è¯•CASåŠ é”</span></span><br><span class="line">              <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                  compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                  setExclusiveOwnerThread(current);</span><br><span class="line">                  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">              <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">              <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">              setState(nextc);</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>éå…¬å¹³é”</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//ä½¿ç”¨CASè·å–stateèµ„æºï¼ŒæˆåŠŸè®¾ç½®1ï¼Œå¹¶è®°å½•å ç”¨é”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;<span class="comment">//ä¸ä¼šåˆ¤æ–­æ˜¯å¦è¿˜æœ‰èŠ‚ç‚¹ç­‰å¾…ï¼Œç›´æ¥è¿›è¡ŒCASå°è¯•åŠ é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>çˆ¶ç±»å…±æœ‰æ–¹æ³•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ol>
<li>åœ¨æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹è¿›è¡Œlockæ—¶ï¼Œéå…¬å¹³é”ä¼šç›´æ¥å°è¯•CASåŠ é”ï¼Œå¦‚æœåŠ é”æˆåŠŸå°±å…ˆæ‰§è¡Œã€‚å°±åƒæ’é˜ŸåŠ å¡ä¸€æ ·ï¼Œä¹Ÿç”±æ­¤å¾—æ¥ä¸å…¬å¹³é”ã€‚è€Œå…¬å¹³é”ä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹èŠ‚ç‚¹ç­‰å¾…ï¼Œå¦‚æœæœ‰åªèƒ½ä¹–ä¹–çš„å»ç­‰å¾…ã€‚ </li>
<li> åœ¨ç¬¬ä¸€æ¬¡CASåŠ é”å¤±è´¥åï¼Œè¿›è¡Œacquireæ–¹æ³•ã€‚ä¼šè¿›è¡Œå†ä¸€æ¬¡å°è¯•åŠ é”tryAcquireã€‚å¦‚æœæ­¤æ—¶é”å·²ç»é‡Šæ”¾ï¼Œé‚£ä¹ˆéå…¬å¹³é”å°±ä¼šè·å–æ‰§è¡Œæœºä¼šã€‚ä½†æ˜¯å…¬å¹³é”åªèƒ½è€è€å®å®çš„æ£€æŸ¥å‰é¢è¿˜æœ‰æ²¡æœ‰æ’é˜Ÿçš„äººã€‚ </li>
</ol>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/images/alipay.jpg"><img loading="lazy" src="/images/alipay.jpg" alt="æ”¯ä»˜å®" title="æ”¯ä»˜å®"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/images/wechatpay.png"><img loading="lazy" src="/images/wechatpay.png" alt="å¾®ä¿¡æ”¯ä»˜" title="å¾®ä¿¡æ”¯ä»˜"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>ç¿”ä»”</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/" title="AQSæºç åˆ†æ(reentrantLock)">http://example.com/2022/07/07/AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(reentrantLock)/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/07/07/ReenttrantLock%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="prev" title="AQSæºç åˆ†æ(reentrantLock)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">AQSæºç åˆ†æ(reentrantLock)</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/06/15/fail-fast%E4%B8%8Efail-safe/" rel="next" title="fail-fastä¸fail-safe"><span class="post-nav-text">fail-fastä¸fail-safe</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2022 </span><span class="with-love" id="animate" title="äº‘æ¸¸å›çš„èµåŠ©è€…ä»¬"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> ç¿”ä»”</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v5.4.2</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.11</span></div><div class="live-time"><span>æœ¬åšå®¢å·²è¿è¡Œ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2022-04-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} å¤© ${passHour} å°æ—¶ ${passMinute} åˆ† ${passSecond} ç§’`;
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>